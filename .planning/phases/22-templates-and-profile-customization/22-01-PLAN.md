---
phase: 22-templates-and-profile-customization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/product_video_compositor.py
  - app/api/profile_routes.py
  - app/api/product_generate_routes.py
  - supabase/migrations/014_add_video_template_settings.sql
autonomous: true
requirements:
  - TMPL-01
  - TMPL-02
  - TMPL-03
  - TMPL-04
must_haves:
  truths:
    - "3 named template presets (Product Spotlight, Sale Banner, Collection Showcase) exist as Python dataclasses with distinct overlay positions, animation direction, and safe zones"
    - "CompositorConfig accepts template_name, primary_color, accent_color, font_family fields and compose_product_video uses them"
    - "_build_text_overlays uses template layout constants (not hard-coded y positions) and custom colors (not hard-coded color names)"
    - "_build_zoompan_filter supports zoom-out direction for Sale Banner template"
    - "Profile PATCH endpoint accepts video_template_settings JSONB and persists it per profile"
    - "Generation pipeline reads profile video_template_settings and merges into CompositorConfig before composing"
    - "GET /profiles/templates returns the 3 available template names and display names"
  artifacts:
    - path: "app/services/product_video_compositor.py"
      provides: "VideoTemplate dataclass, TEMPLATES dict, extended CompositorConfig, _hex_to_ffmpeg_color helper"
      contains: "class VideoTemplate"
    - path: "app/api/profile_routes.py"
      provides: "ProfileSettingsUpdate with video_template_settings field, GET /profiles/templates endpoint"
      contains: "video_template_settings"
    - path: "app/api/product_generate_routes.py"
      provides: "Profile template settings fetch in Stage 1, template-aware CompositorConfig construction"
      contains: "video_template_settings"
    - path: "supabase/migrations/014_add_video_template_settings.sql"
      provides: "JSONB column on profiles table"
      contains: "video_template_settings"
  key_links:
    - from: "app/api/product_generate_routes.py"
      to: "app/services/product_video_compositor.py"
      via: "CompositorConfig with template_name, primary_color, accent_color"
      pattern: "template_name.*primary_color.*accent_color"
    - from: "app/api/product_generate_routes.py"
      to: "supabase profiles table"
      via: "profile video_template_settings JSONB read"
      pattern: "video_template_settings"
    - from: "app/services/product_video_compositor.py"
      to: "TEMPLATES dict"
      via: "compose_product_video looks up template by config.template_name"
      pattern: "TEMPLATES\\[.*template_name"
---

<objective>
Add 3 named video template presets (Product Spotlight, Sale Banner, Collection Showcase) as Python dataclasses, extend the compositor to use template-driven layout/animation/colors, add per-profile template settings persistence via JSONB column, and wire the generation pipeline to read profile template settings.

Purpose: Enable template-driven video composition where each template defines unique overlay positions, animation direction, text layout, and safe zones — and each profile stores its own template + color customization.

Output: VideoTemplate dataclass + 3 instances, extended CompositorConfig, template-aware _build_text_overlays and _build_zoompan_filter, DB migration, profile PATCH support, generation pipeline wiring.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-templates-and-profile-customization/22-RESEARCH.md
@app/services/product_video_compositor.py
@app/api/profile_routes.py
@app/api/product_generate_routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: VideoTemplate dataclass, 3 presets, extended CompositorConfig, compositor refactors</name>
  <files>
    app/services/product_video_compositor.py
  </files>
  <action>
In `app/services/product_video_compositor.py`, add the following (all additions near the top of the file, after the existing imports and constants):

1. **Add `Literal` import** from `typing` (add to existing import line).

2. **Add `VideoTemplate` dataclass** (before `CompositorConfig`):
   - Fields: `name` (TemplateName literal), `display_name` (str), `zoom_direction` (Literal["in","out"]), `pan_x` (Literal["left","right","center"]), `pan_y` (Literal["up","down","center"]), `title_y`, `brand_y`, `price_y`, `orig_price_y`, `cta_y` (all int), `title_fontsize`, `brand_fontsize`, `price_fontsize`, `cta_fontsize` (all int), `safe_zone_top` (int, default 150), `safe_zone_bottom` (int, default 200), `badge_position` (Literal["top_right","top_left","bottom_right"], default "top_right").
   - `TemplateName = Literal["product_spotlight", "sale_banner", "collection_showcase"]`

3. **Create `TEMPLATES` dict** with 3 preset instances. Use EXACT values from 22-RESEARCH.md Pattern 1. Key distinction: Sale Banner has `zoom_direction="out"`, `badge_position="top_left"`, pushed-down title (y=200). Collection Showcase has `pan_x="right"`, `pan_y="up"`.
   - Set `DEFAULT_TEMPLATE: TemplateName = "product_spotlight"`

4. **Extend `CompositorConfig`** with 4 new fields:
   - `template_name: TemplateName = "product_spotlight"`
   - `primary_color: str = "#FF0000"` (CSS hex — stored as hex, converted at render time)
   - `accent_color: str = "#FFFF00"`
   - `font_family: str = ""` (empty = FFmpeg default)

5. **Add `_hex_to_ffmpeg_color(hex_color: str, opacity: str = "") -> str`** helper function. If `hex_color` starts with `#`, convert to `0xRRGGBB` format. Otherwise pass through unchanged (for named colors like "red", "white"). Append opacity suffix if provided.

6. **Refactor `_build_zoompan_filter`** to accept a new `direction: Literal["in", "out"] = "in"` parameter:
   - For `direction="in"`: keep current behavior (z starts 1.0, increments to 1.5).
   - For `direction="out"`: use `z='if(eq(on,1),1.5,max(zoom-{z_inc:.6f},1.0))'` to start zoomed-in and pull out.

7. **Refactor `_build_text_overlays`** to accept 4 new params: `template: VideoTemplate`, `primary_color: str = "#FF0000"`, `accent_color: str = "#FFFF00"`, `font_family: str = ""`:
   - Replace ALL hard-coded y-positions with `template.title_y`, `template.brand_y`, `template.price_y`, `template.orig_price_y`, `template.cta_y`.
   - Replace ALL hard-coded font sizes with `template.title_fontsize`, `template.brand_fontsize`, `template.price_fontsize`, `template.cta_fontsize`.
   - Replace hard-coded CTA boxcolor "red" with `_hex_to_ffmpeg_color(primary_color, "@0.85")`.
   - Replace hard-coded sale price fontcolor "yellow" with `_hex_to_ffmpeg_color(accent_color)`.
   - If `font_family` is non-empty, pass it as `fontfile=` parameter in `build_drawtext_filter` calls. Check if `build_drawtext_filter` in `textfile_helper.py` already supports a `fontfile` kwarg; if not, the fontfile param can be added to the drawtext string manually via string concatenation.

8. **Refactor `compose_product_video`** to:
   - Look up template: `template = TEMPLATES.get(config.template_name, TEMPLATES[DEFAULT_TEMPLATE])`
   - Pass `template`, `config.primary_color`, `config.accent_color`, `config.font_family` to `_build_text_overlays`.
   - Pass `direction=template.zoom_direction` to `_build_zoompan_filter`.
   - Map `template.badge_position` to FFmpeg overlay coordinates for the sale badge in `filter_complex`:
     - `"top_right"`: `overlay=x=W-w-20:y=20`
     - `"top_left"`: `overlay=x=20:y=20`
     - `"bottom_right"`: `overlay=x=W-w-20:y=H-h-20`

IMPORTANT: Do NOT change the function signatures of `compose_product_video` — it still takes `(image_path, output_path, product, config)`. All new data flows through `CompositorConfig`.
  </action>
  <verify>
    Run `python -c "from app.services.product_video_compositor import VideoTemplate, TEMPLATES, CompositorConfig, DEFAULT_TEMPLATE; print(len(TEMPLATES)); print([t.display_name for t in TEMPLATES.values()]); cfg = CompositorConfig(template_name='sale_banner', primary_color='#00FF00'); print(cfg.template_name, cfg.primary_color)"` — should print 3 templates, their display names, and the custom config fields.
  </verify>
  <done>
    VideoTemplate dataclass exists with 3 preset instances. CompositorConfig has template_name, primary_color, accent_color, font_family fields. _build_text_overlays uses template positions and custom colors. _build_zoompan_filter supports zoom-out. compose_product_video wires everything through config. _hex_to_ffmpeg_color converts CSS hex to FFmpeg format. Badge position is template-driven.
  </done>
</task>

<task type="auto">
  <name>Task 2: DB migration, profile routes, generation pipeline wiring</name>
  <files>
    supabase/migrations/014_add_video_template_settings.sql
    app/api/profile_routes.py
    app/api/product_generate_routes.py
  </files>
  <action>
**A) Create migration file** `supabase/migrations/014_add_video_template_settings.sql`:

```sql
-- Migration 014: Add video template settings to profiles
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS video_template_settings JSONB DEFAULT '{
  "template_name": "product_spotlight",
  "primary_color": "#FF0000",
  "accent_color": "#FFFF00",
  "font_family": "",
  "cta_text": "Comanda acum!"
}'::JSONB;

COMMENT ON COLUMN profiles.video_template_settings IS
  'Per-profile video template preset: template_name, primary_color (hex), accent_color (hex), font_family, cta_text';
```

Also apply this migration to the linked Supabase project using the MCP `apply_migration` tool.

**B) Update `app/api/profile_routes.py`**:

1. Add `video_template_settings: Optional[Dict[str, Any]] = None` field to `ProfileSettingsUpdate` model.

2. In the PATCH handler for `/profiles/{profile_id}`, add the elif/if branch:
   ```python
   if updates.video_template_settings is not None:
       update_data["video_template_settings"] = updates.video_template_settings
   ```
   Follow the same pattern already used for `tts_settings`.

3. Add a new GET endpoint `@router.get("/templates")` that returns the 3 available template presets:
   ```python
   @router.get("/templates")
   async def list_templates():
       """Return available video template presets."""
       from app.services.product_video_compositor import TEMPLATES
       return [
           {"name": t.name, "display_name": t.display_name}
           for t in TEMPLATES.values()
       ]
   ```
   This endpoint does NOT require auth (read-only public metadata). Place it BEFORE the `/{profile_id}` routes to avoid FastAPI treating "templates" as a profile_id.

**C) Update `app/api/product_generate_routes.py`**:

In `_generate_product_video_task`, in Stage 1 (after fetching product data from Supabase), add a profile template settings fetch:

```python
# Read profile template settings
profile_result = supabase.table("profiles")\
    .select("video_template_settings")\
    .eq("id", profile_id)\
    .single()\
    .execute()
tmpl_cfg = (profile_result.data or {}).get("video_template_settings") or {}
```

Then when constructing `CompositorConfig` (Stage 4, around line 680), add the template fields:
```python
compositor_config = CompositorConfig(
    duration_s=request.duration_s,
    cta_text=tmpl_cfg.get("cta_text") or request.cta_text,
    fps=25,
    use_zoompan=True,
    output_dir=settings_obj.output_dir / "product_videos" if hasattr(settings_obj, 'output_dir') else Path("output/product_videos"),
    template_name=tmpl_cfg.get("template_name", "product_spotlight"),
    primary_color=tmpl_cfg.get("primary_color", "#FF0000"),
    accent_color=tmpl_cfg.get("accent_color", "#FFFF00"),
    font_family=tmpl_cfg.get("font_family", ""),
)
```

Priority for CTA: profile setting is the default; if the request explicitly provides a non-default CTA, it overrides. Use: `cta_text = request.cta_text if request.cta_text != "Comanda acum!" else (tmpl_cfg.get("cta_text") or request.cta_text)`.

Ensure `tmpl_cfg` variable is available in the scope where `CompositorConfig` is constructed — it may need to be passed through or stored in a broader scope within the task function.
  </action>
  <verify>
    1. Check migration file exists: `cat supabase/migrations/014_add_video_template_settings.sql`
    2. Verify profile routes: `python -c "from app.api.profile_routes import ProfileSettingsUpdate; m = ProfileSettingsUpdate(video_template_settings={'template_name': 'sale_banner'}); print(m.video_template_settings)"` — should print the dict.
    3. Verify templates endpoint is importable: `python -c "from app.api.profile_routes import router; routes = [r.path for r in router.routes]; print('/templates' in routes or any('templates' in r for r in routes))"` — should print True.
    4. Check the generation route references template settings: `grep -n 'video_template_settings\|tmpl_cfg' app/api/product_generate_routes.py` — should show the new code.
  </verify>
  <done>
    Migration 014 creates video_template_settings JSONB column on profiles. ProfileSettingsUpdate accepts video_template_settings. PATCH handler persists it. GET /profiles/templates returns 3 template names. Generation pipeline reads profile template settings and passes them to CompositorConfig. CTA priority: request override > profile default > hardcoded default.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.product_video_compositor import TEMPLATES, VideoTemplate; assert len(TEMPLATES) == 3; print('3 templates OK')"` passes
2. `python -c "from app.services.product_video_compositor import CompositorConfig; c = CompositorConfig(template_name='sale_banner', primary_color='#00FF00', accent_color='#FF00FF'); assert c.template_name == 'sale_banner'; print('Config OK')"` passes
3. `python -c "from app.services.product_video_compositor import _hex_to_ffmpeg_color; assert _hex_to_ffmpeg_color('#FF0000') == '0xFF0000'; assert _hex_to_ffmpeg_color('red') == 'red'; print('Color conversion OK')"` passes
4. Migration file exists at `supabase/migrations/014_add_video_template_settings.sql`
5. `grep -c 'video_template_settings' app/api/profile_routes.py` returns at least 3 (model field, PATCH handler, endpoint return)
6. `grep -c 'tmpl_cfg\|video_template_settings' app/api/product_generate_routes.py` returns at least 4
</verification>

<success_criteria>
- 3 named VideoTemplate presets exist with distinct overlay positions, animation directions, and safe zones
- CompositorConfig extended with template_name, primary_color, accent_color, font_family
- _build_text_overlays parameterized by template (no hard-coded positions/colors)
- _build_zoompan_filter supports zoom-in and zoom-out
- CSS hex to FFmpeg color conversion helper exists
- Badge position is template-driven
- DB migration adds video_template_settings JSONB to profiles
- Profile PATCH endpoint persists template settings
- GET /profiles/templates returns 3 presets
- Generation pipeline reads profile template settings into CompositorConfig
</success_criteria>

<output>
After completion, create `.planning/phases/22-templates-and-profile-customization/22-01-SUMMARY.md`
</output>
