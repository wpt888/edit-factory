---
phase: 22-templates-and-profile-customization
plan: 02
type: execute
wave: 2
depends_on:
  - 22-01
files_modified:
  - frontend/src/app/settings/page.tsx
  - frontend/src/app/product-video/page.tsx
autonomous: false
requirements:
  - TMPL-01
  - TMPL-02
  - TMPL-03
  - TMPL-04
must_haves:
  truths:
    - "User can see a Template & Branding card in the Settings page with template selector, color pickers, and CTA text field"
    - "User can select one of 3 templates from a dropdown and the selection persists per profile"
    - "User can pick primary and accent colors via color picker inputs and the hex values persist per profile"
    - "User can edit CTA text and it persists per profile"
    - "Switching profiles loads that profile's saved template settings"
    - "Product video generation page pre-fills CTA text from profile template settings"
  artifacts:
    - path: "frontend/src/app/settings/page.tsx"
      provides: "Template & Branding settings card with template selector, color pickers, CTA input"
      contains: "Template & Branding"
    - path: "frontend/src/app/product-video/page.tsx"
      provides: "CTA pre-fill from profile template settings"
      contains: "video_template_settings"
  key_links:
    - from: "frontend/src/app/settings/page.tsx"
      to: "GET /api/v1/profiles/templates"
      via: "fetch on mount to populate template selector"
      pattern: "profiles/templates"
    - from: "frontend/src/app/settings/page.tsx"
      to: "PATCH /api/v1/profiles/{id}"
      via: "handleSave includes video_template_settings in update payload"
      pattern: "video_template_settings"
---

<objective>
Add a Template & Branding settings card to the Settings page with template preset selector, color pickers, and CTA text input — all persisted per profile. Pre-fill CTA on the product video generation page from profile settings.

Purpose: Give each store/profile its own brand identity for generated product videos — users choose their template layout and customize colors/CTA without touching code.

Output: Settings page with template customization UI, profile-aware settings persistence, CTA pre-fill on generation page, Playwright screenshot verification.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-templates-and-profile-customization/22-RESEARCH.md
@.planning/phases/22-templates-and-profile-customization/22-01-SUMMARY.md
@frontend/src/app/settings/page.tsx
@frontend/src/app/product-video/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Template & Branding card on Settings page + CTA pre-fill on generation page</name>
  <files>
    frontend/src/app/settings/page.tsx
    frontend/src/app/product-video/page.tsx
  </files>
  <action>
**A) Settings page — Template & Branding card** (`frontend/src/app/settings/page.tsx`):

1. **Add state variables** for template settings:
   ```tsx
   const [templateName, setTemplateName] = useState<string>("product_spotlight")
   const [primaryColor, setPrimaryColor] = useState<string>("#FF0000")
   const [accentColor, setAccentColor] = useState<string>("#FFFF00")
   const [templateCta, setTemplateCta] = useState<string>("Comanda acum!")
   const [availableTemplates, setAvailableTemplates] = useState<{name: string, display_name: string}[]>([])
   ```

2. **Fetch available templates** on mount (add to the existing useEffect or loadSettings function):
   ```tsx
   // Fetch template presets
   try {
     const tmplRes = await apiGet("/profiles/templates")
     if (tmplRes && Array.isArray(tmplRes)) {
       setAvailableTemplates(tmplRes)
     }
   } catch (err) {
     console.warn("Failed to load templates:", err)
   }
   ```

3. **Load profile template settings** (in the existing loadSettings / profile data fetch):
   When profile data is loaded, read `video_template_settings`:
   ```tsx
   const videoSettings = profileData.video_template_settings || {}
   setTemplateName(videoSettings.template_name || "product_spotlight")
   setPrimaryColor(videoSettings.primary_color || "#FF0000")
   setAccentColor(videoSettings.accent_color || "#FFFF00")
   setTemplateCta(videoSettings.cta_text || "Comanda acum!")
   ```

4. **Include in save handler** (in handleSave or equivalent):
   Add `video_template_settings` to the updates object sent via PATCH:
   ```tsx
   const updates = {
     ...existingUpdates,
     video_template_settings: {
       template_name: templateName,
       primary_color: primaryColor,
       accent_color: accentColor,
       font_family: "",
       cta_text: templateCta,
     },
   }
   ```

5. **Add the Template & Branding Card UI** after the existing settings cards (e.g., after TTS Settings card). Use the Shadcn Card, CardHeader, CardTitle, CardDescription, CardContent components already imported. The card contains:

   - **Template selector**: Use the existing Shadcn `Select` component (already imported and used elsewhere on the page). Populate options from `availableTemplates` state. Display `display_name`, value is `name`.

   - **Color pickers**: Two side-by-side `<input type="color">` elements styled with Tailwind (`h-9 w-16 rounded border border-input cursor-pointer`). One for "Primary Color (CTA)" bound to `primaryColor`, one for "Accent Color (Sale Price)" bound to `accentColor`. Show the hex value next to each picker in a `text-xs text-muted-foreground font-mono` span.

   - **CTA text input**: Use the existing Shadcn `Input` component. Bound to `templateCta`. Label: "Default CTA Text". Helper text below: "Pre-fills the CTA field when generating videos for this profile."

   - All inputs disabled when `saving` state is true.

   Follow the exact JSX structure from 22-RESEARCH.md Pattern 8 (Frontend template settings card).

**B) Product video generation page — CTA pre-fill** (`frontend/src/app/product-video/page.tsx`):

On page load, after the profile context is available, fetch the current profile's template settings and pre-fill the CTA input:

```tsx
// In the useEffect or load function that runs on mount:
const loadProfileDefaults = async () => {
  try {
    const profileId = currentProfile?.id
    if (!profileId) return
    const profileData = await apiGet(`/profiles/${profileId}`)
    if (profileData?.video_template_settings?.cta_text) {
      setCta(profileData.video_template_settings.cta_text)
    }
  } catch (err) {
    console.warn("Failed to load profile template defaults:", err)
  }
}
```

Only pre-fill if the user has not already typed a custom CTA. If the page has existing state from URL params (for product data), preserve that.

Check the existing page structure before modifying — the CTA field may be initialized from URL params or from state. Only override the default "Comanda acum!" with the profile setting; do not override if user has explicitly set a different value via URL param.
  </action>
  <verify>
    1. Dev server running: `cd frontend && npm run dev` (should already be running)
    2. Navigate to Settings page — verify Template & Branding card appears below existing cards
    3. Verify template selector shows 3 options (Product Spotlight, Sale Banner, Collection Showcase)
    4. Verify color pickers render and show hex values
    5. Verify CTA text field is editable
    6. Change template to "Sale Banner", pick a green primary color, save — verify toast confirms save
    7. Refresh page — verify the saved values persist
    8. Switch to a different profile — verify it loads that profile's template settings (or defaults if not yet customized)
  </verify>
  <done>
    Settings page has a Template & Branding card with template selector, two color pickers, and CTA text input. All values load from and save to the profile's video_template_settings JSONB. Switching profiles loads the correct template settings. Product video page pre-fills CTA from profile settings.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of template settings UI</name>
  <files>frontend/src/app/settings/page.tsx</files>
  <action>
Take a Playwright screenshot of the Settings page showing the Template & Branding card. Verify visually that the template selector, color pickers, and CTA text field render correctly.

What was built: Template & Branding settings card with template selector, color pickers, and CTA text — saved per profile. CTA pre-fill on product video page.

How to verify:
1. Open http://localhost:3000/settings
2. Scroll to the "Template & Branding" card
3. Verify the template dropdown shows 3 options: Product Spotlight, Sale Banner, Collection Showcase
4. Verify two color pickers appear with hex values displayed
5. Verify CTA text input shows "Comanda acum!" (or previously saved value)
6. Change template to "Sale Banner", pick custom colors, change CTA text, click Save
7. Refresh page — verify settings persisted
8. If multiple profiles exist: switch to another profile, verify it shows different (or default) template settings
9. Navigate to the product video generation page — verify CTA field pre-fills from profile settings

Resume signal: Type "approved" or describe issues to fix.
  </action>
  <verify>Playwright screenshot taken and shown to user</verify>
  <done>User has visually confirmed the Template & Branding card renders correctly with all controls functional</done>
</task>

</tasks>

<verification>
1. Settings page loads without errors and shows Template & Branding card
2. Template selector populated from GET /profiles/templates (3 options)
3. Color pickers display current hex values and update on change
4. Save button persists video_template_settings to profile via PATCH
5. Page refresh loads saved values
6. Profile switch loads correct template settings per profile
7. Product video page pre-fills CTA from profile settings
</verification>

<success_criteria>
- Template & Branding card visible on Settings page with template selector, 2 color pickers, CTA text input
- All 3 template presets available in selector dropdown
- Template settings persist per profile (save + refresh + profile switch)
- Product video generation page pre-fills CTA from profile template settings
- Playwright screenshot taken and shown to user for verification
</success_criteria>

<output>
After completion, create `.planning/phases/22-templates-and-profile-customization/22-02-SUMMARY.md`
</output>
