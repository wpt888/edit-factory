---
phase: 20-single-product-e2e
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - frontend/src/app/product-video/page.tsx
  - frontend/src/app/products/page.tsx
autonomous: false
requirements:
  - BATCH-01
  - TTS-03
  - OUT-04

must_haves:
  truths:
    - "User can navigate to a product video generation page from the product browser"
    - "User can select voiceover mode (quick or elaborate), TTS provider, duration, and encoding preset"
    - "User can click Generate and see real-time progress updates via job polling"
    - "On completion, user is informed the video is in the library (OUT-04: publishable via Postiz from library)"
  artifacts:
    - path: "frontend/src/app/product-video/page.tsx"
      provides: "Product video generation UI with form and polling"
      contains: "useJobPolling"
    - path: "frontend/src/app/products/page.tsx"
      provides: "Generate Video button/link on product cards"
      contains: "product-video"
  key_links:
    - from: "frontend/src/app/product-video/page.tsx"
      to: "POST /api/v1/products/{product_id}/generate"
      via: "apiPost call on form submit"
      pattern: "products.*generate"
    - from: "frontend/src/app/product-video/page.tsx"
      to: "frontend/src/hooks/use-job-polling.ts"
      via: "useJobPolling hook for progress tracking"
      pattern: "useJobPolling"
    - from: "frontend/src/app/products/page.tsx"
      to: "frontend/src/app/product-video/page.tsx"
      via: "Link or router.push to /product-video?id={product_id}"
      pattern: "product-video"
---

<objective>
Build the frontend product video generation page and wire it to the backend endpoint from Plan 01. Users navigate from the product browser, configure voiceover and render settings, click Generate, and see real-time progress. On completion, they are directed to the library where the video is ready for review and publishing (OUT-04 via existing Postiz integration).

Purpose: This completes the user-facing side of single product E2E generation, making BATCH-01 fully achievable from the UI.
Output: `/product-video` page with generation form and polling UI; updated product browser with generate action.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-single-product-e2e/20-RESEARCH.md
@.planning/phases/20-single-product-e2e/20-01-SUMMARY.md

# Key source files:
@frontend/src/app/products/page.tsx (existing product browser — add generate action)
@frontend/src/hooks/use-job-polling.ts (polling hook interface)
@frontend/src/lib/api.ts (apiPost/apiGet helpers)
@frontend/src/contexts/profile-context.tsx (profile context for header injection)
@frontend/src/app/librarie/page.tsx (library page pattern for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /product-video page with generation form and polling UI</name>
  <files>frontend/src/app/product-video/page.tsx</files>
  <action>
Create `frontend/src/app/product-video/page.tsx` — a new Next.js page for single product video generation.

**Page flow:**
1. Read `product_id` from URL search params (`?id={product_id}`)
2. On mount, fetch product details via `GET /api/v1/feeds/{feed_id}/products` or store product data passed via query params/sessionStorage (simpler: pass `product_id`, `title`, `image`, `price`, `brand` as query params — these are already available on the product card)
3. Show product info card (image, title, price, brand) at the top
4. Show generation settings form below

**Generation form fields (use Shadcn UI components — Select, RadioGroup, Button, Label):**
- **Voiceover Mode**: Radio group — "Quick (template)" / "Elaborate (AI-generated)" — default "quick"
- **TTS Provider**: Select — "Edge TTS (free)" / "ElevenLabs (premium)" — default "edge" (TTS-03)
- **Voice**: Text input or select — shows default voice for selected provider ("ro-RO-EmilNeural" for Edge, profile default for ElevenLabs). Optional override.
- **AI Provider** (only shown when elaborate mode selected): Select — "Gemini" / "Claude" — default "gemini"
- **Duration**: Select — 15s / 30s / 45s / 60s — default 30
- **Encoding Preset**: Select — "TikTok" / "Reels" / "YouTube Shorts" — default "tiktok"
- **CTA Text**: Text input — default "Comanda acum!"
- **Video Filters** (optional section, collapsed by default): 3 checkboxes — Denoise, Sharpen, Color Correction

**Generate button:**
- On click: POST to `/api/v1/products/{product_id}/generate` with form values as JSON body
- On success: extract `job_id` from response, call `startPolling(job_id)` from `useJobPolling` hook
- Disable form while polling is active

**Progress section (visible during and after generation):**
- Use `useJobPolling` hook with callbacks:
  - Show progress bar with percentage and status text
  - `onComplete`: Show success toast, show "View in Library" link to `/librarie`
  - `onError`: Show error toast with error message, re-enable form for retry

**Layout:**
- Use same layout pattern as other pages (container with max-width, padding)
- Back button/link to `/products`
- Page title: "Generate Product Video"

**Styling:** Use existing Tailwind classes and Shadcn components consistent with the rest of the app. No new component library dependencies.
  </action>
  <verify>
1. Run `cd frontend && npx tsc --noEmit` — no TypeScript errors
2. Take Playwright screenshot of the page with a test product ID in the URL
  </verify>
  <done>
/product-video page exists with: product info display, voiceover mode toggle, TTS provider selector, duration/preset selectors, CTA text input, filter checkboxes, Generate button that calls the API and starts polling, progress bar during generation, and "View in Library" link on completion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Generate Video" action to product browser cards</name>
  <files>frontend/src/app/products/page.tsx</files>
  <action>
Update the existing product browser page (`/products`) to add a "Generate Video" action on each product card.

**Changes to product card:**
- Add a "Generate Video" button or icon-button on each product card (bottom of card or as an overlay action)
- On click: navigate to `/product-video?id={product.id}&title={encodeURIComponent(product.title)}&image={encodeURIComponent(product.image_link)}&price={product.raw_price_str}&brand={encodeURIComponent(product.brand || "")}&feed_id={feed_id}`
- Use Next.js `useRouter().push()` for navigation
- Style: small button or film/video icon, consistent with card design

**Also add a navbar link** for `/product-video` is NOT needed — users access it through the product browser. But ensure the products page is accessible from the navbar (it should already be from Phase 19).

Keep changes minimal — do not refactor the existing product card layout. Just add the action button.
  </action>
  <verify>
1. Run `cd frontend && npx tsc --noEmit` — no TypeScript errors
2. Take Playwright screenshot of the products page showing the Generate Video button on cards
  </verify>
  <done>
Product browser cards have a "Generate Video" button that navigates to /product-video with product data in query params.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify single product E2E flow</name>
  <what-built>
Complete single product video generation flow:
1. Product browser with "Generate Video" button per product card
2. /product-video page with voiceover mode, TTS provider, duration, preset, and filter settings
3. Backend POST /api/v1/products/{product_id}/generate endpoint with full pipeline
4. Job polling with real-time progress
5. Completed video appears in /librarie
  </what-built>
  <how-to-verify>
1. Start backend: `python run.py` (port 8000)
2. Start frontend: `cd frontend && npm run dev` (port 3000)
3. Navigate to http://localhost:3000/products
4. Select a feed that has synced products
5. Click "Generate Video" on any product card
6. Verify you land on /product-video with product info displayed
7. Leave defaults (Quick mode, Edge TTS, 30s, TikTok preset)
8. Click "Generate"
9. Verify progress bar updates in real time (5% -> 10% -> 25% -> ... -> 100%)
10. On completion, verify success message and "View in Library" link
11. Click "View in Library" — verify the product video clip appears in /librarie
12. (Optional) Test with ElevenLabs provider if API key is configured — verify subtitles are present in the output video
  </how-to-verify>
  <resume-signal>Type "approved" if the E2E flow works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. /product-video page renders with all form fields
3. Product browser shows Generate Video button on cards
4. Full E2E: select product -> configure -> generate -> poll -> library clip exists
5. Edge TTS path works without subtitles
6. (If ElevenLabs configured) ElevenLabs path works with subtitles
</verification>

<success_criteria>
- User can navigate from product browser to generation page (BATCH-01 UI)
- User can choose TTS provider in the form (TTS-03 UI)
- Generation triggers and progress is visible via polling (BATCH-01)
- Completed video appears in library and is publishable via existing Postiz (OUT-04)
- Human verifies the complete flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/20-single-product-e2e/20-02-SUMMARY.md`
</output>
