---
phase: 08-audio-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/audio_normalizer.py
  - app/services/encoding_presets.py
autonomous: true

must_haves:
  truths:
    - "Audio normalizer service can measure loudness of any audio/video file"
    - "Audio normalizer service can build loudnorm filter string from measurements"
    - "EncodingPreset model includes audio normalization configuration"
    - "All platform presets configured for -14 LUFS / -1.5 dBTP"
  artifacts:
    - path: "app/services/audio_normalizer.py"
      provides: "Two-pass loudnorm measurement and filter building"
      exports: ["LoudnormMeasurement", "measure_loudness", "build_loudnorm_filter"]
      min_lines: 80
    - path: "app/services/encoding_presets.py"
      provides: "EncodingPreset with normalization fields"
      contains: "normalize_audio"
  key_links:
    - from: "app/services/audio_normalizer.py"
      to: "FFmpeg subprocess"
      via: "subprocess.run with loudnorm filter"
      pattern: "subprocess\\.run.*loudnorm"
    - from: "app/services/encoding_presets.py"
      to: "Pydantic BaseModel"
      via: "EncodingPreset class"
      pattern: "class EncodingPreset.*BaseModel"
---

<objective>
Create audio normalization foundation with measurement service and preset configuration.

Purpose: Establish the building blocks for two-pass EBU R128 loudness normalization. The service handles FFmpeg loudnorm filter JSON parsing, and the EncodingPreset model gains fields for normalization targets so all platform presets use -14 LUFS consistently.

Output: audio_normalizer.py service with measure_loudness() and build_loudnorm_filter(), extended EncodingPreset model with normalization fields, all presets updated.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-audio-normalization/08-RESEARCH.md
@app/services/encoding_presets.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audio normalization service</name>
  <files>app/services/audio_normalizer.py</files>
  <action>
Create app/services/audio_normalizer.py implementing two-pass EBU R128 loudness normalization:

1. **LoudnormMeasurement dataclass** with fields:
   - input_i (float): Integrated loudness in LUFS
   - input_tp (float): True peak in dBTP
   - input_lra (float): Loudness range in LU
   - input_thresh (float): Gating threshold
   - target_offset (float): Offset for second pass
   - Add __str__ method for logging

2. **measure_loudness() function**:
   - Parameters: audio_path (Path), target_lufs (-14.0), target_tp (-1.5), target_lra (7.0), timeout_seconds (300)
   - Build FFmpeg command: `ffmpeg -hide_banner -nostats -i {path} -af loudnorm=I={lufs}:TP={tp}:LRA={lra}:print_format=json -f null -`
   - Execute with subprocess.run, capture stderr
   - Parse JSON from stderr using regex: `r'\{[^{}]*"input_i"[^{}]*"input_tp"[^{}]*"input_lra"[^{}]*"input_thresh"[^{}]*"target_offset"[^{}]*\}'` with re.DOTALL
   - Return LoudnormMeasurement on success, None on failure
   - Handle TimeoutExpired, JSONDecodeError, KeyError, ValueError with logged errors

3. **build_loudnorm_filter() function**:
   - Parameters: measurement (LoudnormMeasurement), target_lufs (-14.0), target_tp (-1.5), target_lra (7.0)
   - Build filter string with linear=true mode:
     ```
     loudnorm=I={lufs}:TP={tp}:LRA={lra}:measured_I={m.input_i}:measured_TP={m.input_tp}:measured_LRA={m.input_lra}:measured_thresh={m.input_thresh}:offset={m.target_offset}:linear=true
     ```
   - Log the gain adjustment (target_lufs - measurement.input_i)
   - Return the filter string

Use logging.getLogger(__name__) for all logging. Follow existing service patterns (see encoding_presets.py).
  </action>
  <verify>
Run: `python -c "from app.services.audio_normalizer import LoudnormMeasurement, measure_loudness, build_loudnorm_filter; print('Imports OK')"`
  </verify>
  <done>audio_normalizer.py exists with LoudnormMeasurement, measure_loudness, build_loudnorm_filter exported and importable</done>
</task>

<task type="auto">
  <name>Task 2: Extend EncodingPreset with normalization fields</name>
  <files>app/services/encoding_presets.py</files>
  <action>
Modify app/services/encoding_presets.py to add audio normalization configuration:

1. **Add normalization fields to EncodingPreset class** (after audio_sample_rate, before target_bitrate_mbps):
   ```python
   # Audio normalization (Phase 8)
   normalize_audio: bool = True
   target_lufs: float = Field(ge=-70.0, le=-5.0, default=-14.0, description="Target integrated loudness (LUFS)")
   target_tp: float = Field(ge=-9.0, le=0.0, default=-1.5, description="Target true peak (dBTP)")
   target_lra: float = Field(ge=1.0, le=50.0, default=7.0, description="Target loudness range (LU)")
   ```

2. **Update all preset instances** with explicit normalization values:
   - PRESET_TIKTOK: normalize_audio=True, target_lufs=-14.0, target_tp=-1.5, target_lra=7.0
   - PRESET_REELS: normalize_audio=True, target_lufs=-14.0, target_tp=-1.5, target_lra=7.0
   - PRESET_YOUTUBE_SHORTS: normalize_audio=True, target_lufs=-14.0, target_tp=-1.5, target_lra=7.0
   - PRESET_GENERIC: normalize_audio=True, target_lufs=-14.0, target_tp=-1.5, target_lra=7.0

3. **Update preset descriptions** to mention audio normalization:
   - TikTok: "Optimized for TikTok (9:16, CRF 20, -14 LUFS audio)"
   - Instagram Reels: "Optimized for Instagram Reels (9:16, CRF 18, -14 LUFS audio)"
   - YouTube Shorts: "Optimized for YouTube Shorts (9:16, CRF 18, -14 LUFS audio)"
   - Generic: "Balanced settings for any platform (CRF 20, -14 LUFS audio)"

4. **Update list_presets()** to include normalization info in returned dicts:
   - Add "normalize_audio", "target_lufs" keys to each preset dict

Do NOT modify to_ffmpeg_params() yet - normalization filter is added by render pipeline (Plan 08-02).
  </action>
  <verify>
Run: `python -c "from app.services.encoding_presets import get_preset; p = get_preset('tiktok'); print(f'normalize_audio={p.normalize_audio}, target_lufs={p.target_lufs}, target_tp={p.target_tp}')"`
Expected: normalize_audio=True, target_lufs=-14.0, target_tp=-1.5
  </verify>
  <done>All EncodingPreset instances have normalize_audio=True, target_lufs=-14.0, target_tp=-1.5, target_lra=7.0</done>
</task>

</tasks>

<verification>
1. Import check: `python -c "from app.services.audio_normalizer import measure_loudness, build_loudnorm_filter; from app.services.encoding_presets import get_preset; print('All imports OK')"`
2. Preset check: `python -c "from app.services.encoding_presets import list_presets; import json; print(json.dumps([p['name'] + ': ' + str(p.get('target_lufs', 'MISSING')) for p in list_presets()], indent=2))"`
3. All 4 presets show target_lufs=-14.0
</verification>

<success_criteria>
- audio_normalizer.py service created with measure_loudness() and build_loudnorm_filter()
- EncodingPreset model has normalize_audio, target_lufs, target_tp, target_lra fields
- All 4 platform presets configured with -14 LUFS / -1.5 dBTP
- All imports work without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-audio-normalization/08-01-SUMMARY.md`
</output>
