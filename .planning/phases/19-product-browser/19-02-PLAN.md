---
phase: 19-product-browser
plan: 02
type: execute
wave: 2
depends_on:
  - 19-01
files_modified:
  - frontend/src/app/products/page.tsx
  - frontend/src/components/navbar.tsx
  - frontend/public/placeholder-product.png
autonomous: false
requirements:
  - FEED-02
  - FEED-03
  - FEED-04
  - FEED-05
  - FEED-06

must_haves:
  truths:
    - "User can see synced products in a card grid with image, title, price, sale badge, and brand — paginated at 50/page"
    - "User can type in a search box and the grid filters to matching products"
    - "User can toggle an On Sale filter to show only sale products"
    - "User can select a category from a dropdown to filter by product_type"
    - "User can select a brand from a dropdown to filter by brand"
    - "Products page is accessible from the navbar"
  artifacts:
    - path: "frontend/src/app/products/page.tsx"
      provides: "Product browser page with feed selector, filter bar, card grid, pagination"
      min_lines: 150
    - path: "frontend/public/placeholder-product.png"
      provides: "Fallback image for products without working image_link"
    - path: "frontend/src/components/navbar.tsx"
      provides: "Products nav link"
      contains: "Products"
  key_links:
    - from: "frontend/src/app/products/page.tsx"
      to: "/api/v1/feeds"
      via: "apiGet for feed list"
      pattern: "apiGet.*feeds"
    - from: "frontend/src/app/products/page.tsx"
      to: "/api/v1/feeds/{feed_id}/products"
      via: "apiGet with filter query params"
      pattern: "apiGet.*products"
    - from: "frontend/src/app/products/page.tsx"
      to: "/api/v1/feeds/{feed_id}/products/filters"
      via: "apiGet for brand/category options"
      pattern: "apiGet.*filters"
---

<objective>
Build the /products frontend page — a product browser with feed selector, filter bar (search input, on-sale toggle, category dropdown, brand dropdown), paginated product card grid, and navbar integration.

Purpose: This is the user-facing product browser that satisfies all five FEED requirements (02-06) — the core deliverable of Phase 19.
Output: Product browser page, placeholder image, navbar link.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-product-browser/19-RESEARCH.md
@.planning/phases/19-product-browser/19-01-SUMMARY.md
@frontend/src/app/tts-library/page.tsx
@frontend/src/components/navbar.tsx
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create product browser page with feed selector, filters, and card grid</name>
  <files>frontend/src/app/products/page.tsx, frontend/src/components/navbar.tsx, frontend/public/placeholder-product.png</files>
  <action>
1. **Create placeholder image** at `frontend/public/placeholder-product.png`:
   - Generate a minimal 400x400 gray SVG-based PNG or use a simple gray rectangle with "No Image" text. A simple approach: create a small inline SVG data URI fallback in the component instead, OR create a 1x1 gray PNG. Simplest: use an inline SVG fallback in the onError handler (no file needed). But for consistency, create a minimal placeholder file. Use the Bash tool to create a small gray PNG via base64 or use a simple SVG file at `frontend/public/placeholder-product.svg` (either works — SVG is simpler).

2. **Create `frontend/src/app/products/page.tsx`** following tts-library/page.tsx and usage/page.tsx patterns:

   **Imports:**
   - `"use client"` directive
   - `useState, useEffect, useCallback` from React
   - Shadcn components: Card, CardContent, Badge, Button, Input, Select (SelectContent, SelectItem, SelectTrigger, SelectValue), Switch, Label
   - `apiGet, apiPost` from `@/lib/api`
   - `useProfile` from `@/contexts/profile-context`
   - `toast` from `sonner`
   - Icons from lucide-react: `Search, Filter, RefreshCw, ChevronLeft, ChevronRight, Loader2, Package, Tag`

   **State variables:**
   - `feeds: Feed[]` — list of feeds from GET /feeds
   - `selectedFeedId: string | null` — currently selected feed
   - `selectedFeed: Feed | null` — full feed object (for sync status display)
   - `products: Product[]` — current page of products
   - `pagination: { page, page_size, total, total_pages }` — pagination state
   - `loading: boolean` — loading indicator
   - `search: string` — search input value (raw)
   - `debouncedSearch: string` — debounced search value (triggers fetch)
   - `onSale: boolean` — on-sale toggle
   - `category: string` — selected category ("all" = no filter)
   - `brand: string` — selected brand ("all" = no filter)
   - `filterOptions: { brands: string[], categories: string[] }` — dropdown options
   - `page: number` — current page (1-based)

   **Type definitions** (inline at top of file):
   ```typescript
   interface Feed {
     id: string;
     name: string;
     feed_url: string;
     sync_status: string;
     product_count: number;
     last_synced_at: string | null;
     sync_error: string | null;
   }

   interface Product {
     id: string;
     feed_id: string;
     title: string;
     brand: string | null;
     product_type: string | null;
     image_link: string | null;
     raw_price_str: string | null;
     raw_sale_price_str: string | null;
     is_on_sale: boolean;
     product_url: string | null;
   }
   ```

   **Data fetching logic:**
   - `fetchFeeds()`: GET /feeds → set feeds, auto-select first feed if none selected
   - `fetchFilterOptions(feedId)`: GET /feeds/{feedId}/products/filters → set filterOptions (call once when feed changes, cache in state)
   - `fetchProducts()`: GET /feeds/{feedId}/products with query params built from filter state. Use `URLSearchParams` pattern from Research Pattern 3. Only include non-default params (omit search if empty, omit on_sale if false, omit category/brand if "all").
   - `handleSync(feedId)`: POST /feeds/{feedId}/sync → toast success → refetch feed after 2s delay

   **Effects:**
   - Profile gate: `if (!currentProfile) return;` — fetch feeds when profile loads
   - Feed change: when selectedFeedId changes, fetchFilterOptions + reset page to 1 + fetchProducts
   - Filter change: when debouncedSearch, onSale, category, brand, or page changes AND selectedFeedId is set, fetchProducts
   - Search debounce: 400ms delay from `search` to `debouncedSearch` (Research Pattern 4)
   - Reset page to 1 when any filter changes (search, onSale, category, brand)

   **Layout (3 sections, top to bottom):**

   a) **Feed selector bar** (top):
      - `<Select>` dropdown showing feed names
      - Sync status badge next to dropdown (idle=green, syncing=yellow, error=red)
      - "Re-sync" button (RefreshCw icon) — disabled when syncing
      - Product count display: "{feed.product_count} products"

   b) **Filter bar** (below feed selector):
      - Search Input with Search icon (placeholder: "Search products...")
      - On Sale toggle (Switch component + Label "On Sale")
      - Category Select dropdown (options from filterOptions.categories, plus "All Categories" default)
      - Brand Select dropdown (options from filterOptions.brands, plus "All Brands" default)
      - All controls in a single flex row, wrapping on mobile

   c) **Product card grid** (main area):
      - CSS grid: `grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4`
      - Each card (Research Code Example "Product Card"):
        - `<img>` with `src={product.image_link || "/placeholder-product.svg"}`, `onError` fallback, `className="w-full h-48 object-cover"`
        - Title: `<h3>` truncated to 2 lines (`line-clamp-2`)
        - Brand: small muted text
        - Price row: if on_sale, show sale price in green + original in gray line-through; else show price normally
        - Sale badge (Badge variant="destructive") when is_on_sale
      - Loading state: show Loader2 spinner centered
      - Empty state: "No products found" message with Package icon

   d) **Pagination controls** (bottom):
      - "Page X of Y" text centered
      - ChevronLeft / ChevronRight buttons
      - Disable prev on page 1, disable next on last page
      - "Showing {total} products" count (uses filtered total)

3. **Add navbar link:**
   - In `frontend/src/components/navbar.tsx`, add `{ label: "Products", href: "/products" }` to the navLinks array. Place it after "TTS" and before "Segments" — it's a product-related page, logically grouped near content creation tools.
  </action>
  <verify>
Start frontend dev server: `cd frontend && npm run dev`
Navigate to http://localhost:3000/products in browser.
Run Playwright screenshot test:

```typescript
import { test } from '@playwright/test';

test('Verify products page', async ({ page }) => {
  await page.goto('/products');
  await page.waitForLoadState('networkidle');
  await page.waitForTimeout(2000);
  await page.screenshot({ path: 'screenshots/verify-products-page.png', fullPage: true });
});
```

```bash
cd frontend && npx playwright test tests/verify-products-page.spec.ts --reporter=list
```
  </verify>
  <done>
Products page renders with feed selector, filter bar (search, on-sale toggle, category dropdown, brand dropdown), product card grid, and pagination. Navbar shows "Products" link.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of product browser</name>
  <files>frontend/src/app/products/page.tsx</files>
  <action>Human visual verification of the product browser page built in Task 1.</action>
  <what-built>Complete product browser page with feed selector, filter bar (search, on-sale toggle, category/brand dropdowns), paginated product card grid showing images/titles/prices/sale badges, and navbar link.</what-built>
  <how-to-verify>
1. Navigate to http://localhost:3000/products
2. Verify feed selector dropdown shows your feed(s) and sync status
3. Type a product name in the search box — cards should filter after ~400ms
4. Toggle "On Sale" — only sale products should show
5. Select a category from the dropdown — grid filters to that category
6. Select a brand from the dropdown — grid filters to that brand
7. Click next/prev pagination buttons — page changes
8. Verify product cards show: image, title, brand, price (with sale badge if on sale)
9. Check navbar has "Products" link and it navigates correctly
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
  <verify>Visual inspection at http://localhost:3000/products</verify>
  <done>User has confirmed the product browser works correctly with all filters and pagination</done>
</task>

</tasks>

<verification>
- Products page loads at /products without console errors
- Feed selector populates with user's feeds
- Search filters products by title (debounced, no rapid-fire requests)
- On-sale toggle shows only sale products
- Category and brand dropdowns filter correctly
- Pagination shows accurate filtered count and navigates between pages
- Product cards display image, title, brand, price, and sale badge
- Navbar includes "Products" link
</verification>

<success_criteria>
- All five FEED requirements (02-06) are satisfied:
  - FEED-02: Card grid with pagination at 50/page
  - FEED-03: Search by title
  - FEED-04: On-sale filter
  - FEED-05: Category filter
  - FEED-06: Brand filter
- Products page is accessible from navbar
- User has visually verified the product browser works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/19-product-browser/19-02-SUMMARY.md`
</output>
