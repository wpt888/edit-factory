---
phase: 15-script-to-video-assembly
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - frontend/src/app/assembly/page.tsx
  - frontend/src/components/navbar.tsx
autonomous: false
must_haves:
  truths:
    - "User can enter a script and preview which segments matched which phrases before rendering"
    - "User can see match confidence scores and unmatched phrases in the preview"
    - "User can trigger final render from the preview page and see progress"
    - "Assembly page is accessible from the main navigation"
  artifacts:
    - path: "frontend/src/app/assembly/page.tsx"
      provides: "Assembly UI: script input, preview matches, render trigger with progress"
      min_lines: 150
    - path: "frontend/src/components/navbar.tsx"
      provides: "Navigation link to /assembly page"
      contains: "assembly"
  key_links:
    - from: "frontend/src/app/assembly/page.tsx"
      to: "/api/v1/assembly/preview"
      via: "apiPost call for match preview"
      pattern: "apiPost.*assembly/preview"
    - from: "frontend/src/app/assembly/page.tsx"
      to: "/api/v1/assembly/render"
      via: "apiPost call to trigger render"
      pattern: "apiPost.*assembly/render"
    - from: "frontend/src/app/assembly/page.tsx"
      to: "/api/v1/assembly/status"
      via: "apiGet polling for render progress"
      pattern: "apiGet.*assembly/status"
    - from: "frontend/src/components/navbar.tsx"
      to: "frontend/src/app/assembly/page.tsx"
      via: "Navigation href"
      pattern: "href.*assembly"
---

<objective>
Create the frontend Assembly page that lets users input a script, preview segment matching results, and trigger final video render.

Purpose: This completes the user-facing workflow for Phase 15. Users see which segments matched which script phrases (with confidence scores), can review before committing to an expensive render, and monitor render progress.

Output: `frontend/src/app/assembly/page.tsx` (assembly page), updated `frontend/src/components/navbar.tsx` (navigation link)
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-script-to-video-assembly/15-01-SUMMARY.md (assembly API endpoints)
@frontend/src/app/scripts/page.tsx (existing scripts page — follow same patterns)
@frontend/src/lib/api.ts (apiGet, apiPost)
@frontend/src/components/navbar.tsx (navigation structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create assembly page with script input, preview, and render workflow</name>
  <files>frontend/src/app/assembly/page.tsx</files>
  <action>
Create `frontend/src/app/assembly/page.tsx` as a "use client" Next.js page. Follow the same component and styling patterns as `/scripts/page.tsx` (Shadcn/UI Card, Input, Button, Badge, Alert, etc.).

**Page Layout — Two-column responsive (same as scripts page):**

Left column — Script Input:
- Large Textarea for script text (rows=10, with placeholder "Paste or type your script here...")
- ElevenLabs model selector dropdown (eleven_flash_v2_5, eleven_turbo_v2_5, eleven_multilingual_v2) — default eleven_flash_v2_5
- "Preview Matches" button (primary, full width) — calls `POST /assembly/preview` with { script_text, elevenlabs_model }
- Loading state with Loader2 spinner during preview request
- Error display with Alert component

Right column — Preview & Render:
- Empty state: "Enter a script and click Preview to see segment matches"
- After preview loaded, show:
  1. Summary stats card: audio_duration (formatted mm:ss), total phrases, matched count, unmatched count
  2. Match list: scrollable container, each match as a mini-card showing:
     - SRT index and text (truncated to ~50 chars if needed)
     - Time range (srt_start - srt_end formatted as mm:ss.ms)
     - Matched segment badge: green if matched (show matched_keyword + confidence %), red if unmatched ("No match")
  3. Render section (below match list):
     - Export preset dropdown (TikTok, Instagram Reels, YouTube Shorts) — default TikTok
     - "Assemble & Render" button (calls `POST /assembly/render`)
     - Render progress section (visible after render started):
       - Progress bar (percentage from status polling)
       - Current step text
       - Status badge (processing / completed / failed)
     - After completed: "Download" link to final video (using library files endpoint pattern)

**State management:**
```
scriptText: string
elevenlabsModel: string
presetName: string
// Preview state
isPreviewLoading: boolean
previewData: PreviewResponse | null
previewError: string | null
// Render state
isRendering: boolean
renderJobId: string | null
renderStatus: { status, progress, current_step, final_video_path, error } | null
```

**Render progress polling:**
- After POST /assembly/render returns job_id, poll GET /assembly/status/{job_id} every 2 seconds
- Use setInterval with cleanup in useEffect return (same pattern as use-job-polling.ts)
- Stop polling when status is "completed" or "failed"
- On "completed", show download link

**Styling:**
- Use Shadcn/UI components: Card, CardHeader, CardTitle, CardContent, Button, Badge, Alert, Select, Textarea, Progress (if available, else custom div with width%)
- Color coding: Badge variant="default" (green-ish) for matched, variant="destructive" for unmatched
- Confidence shown as percentage: `Math.round(confidence * 100)%`
- Responsive: stack to single column on mobile (grid-cols-1 lg:grid-cols-2)

**Lucide icons used:** Sparkles (header), Loader2 (loading), CheckCircle (matched), XCircle (unmatched), Play (render button), Download (download link), Film (header)

**No external dependencies needed** — all from existing Shadcn/UI and Lucide.
  </action>
  <verify>
1. File exists: `ls frontend/src/app/assembly/page.tsx`
2. Builds without errors: `cd frontend && npx next build 2>&1 | tail -20` (check for assembly page in output)
3. Take Playwright screenshot:
```typescript
import { test } from '@playwright/test';
test('Verify assembly page', async ({ page }) => {
  await page.goto('/assembly');
  await page.waitForLoadState('networkidle');
  await page.waitForTimeout(1000);
  await page.screenshot({ path: 'screenshots/verify-assembly-page.png', fullPage: true });
});
```
Run with: `cd frontend && npx playwright test tests/verify-assembly-page.spec.ts --reporter=list`
  </verify>
  <done>
Assembly page renders with script input textarea, model selector, preview button on the left, and empty state on the right. Page builds without TypeScript or build errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Assembly link to navbar</name>
  <files>frontend/src/components/navbar.tsx</files>
  <action>
Add a navigation link to the Assembly page in the navbar.

In `frontend/src/components/navbar.tsx`, find the navLinks array and add an "Assembly" entry AFTER the "Scripts" link and BEFORE the "Segments" link:

```typescript
{ label: "Assembly", href: "/assembly" },
```

This positions it logically in the workflow: Scripts (generate) -> Assembly (match + render) -> Segments (library management).
  </action>
  <verify>
1. `grep -n "assembly" frontend/src/components/navbar.tsx` shows the link
2. Take screenshot showing navbar with Assembly link visible
  </verify>
  <done>
Navbar shows Assembly link between Scripts and Segments, accessible from all pages.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Script-to-Video Assembly frontend with:
1. Assembly page at /assembly with script input, ElevenLabs model selector, and preview button
2. Match preview showing which segments matched which SRT phrases with confidence scores
3. Render trigger with progress polling and download link
4. Navigation link in navbar between Scripts and Segments
  </what-built>
  <how-to-verify>
1. Open http://localhost:3000/assembly in the browser
2. Verify the Assembly link appears in the navbar (between Scripts and Segments)
3. Verify the page loads with script input textarea, model selector dropdown, and Preview Matches button
4. Verify empty state shows on the right column ("Enter a script and click Preview...")
5. (Optional, requires backend running + segments in DB): Paste a script, click Preview, and verify match results appear with confidence percentages
6. Review the Playwright screenshot at frontend/screenshots/verify-assembly-page.png
  </how-to-verify>
  <resume-signal>Type "approved" if the assembly page looks correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Assembly page accessible at /assembly and renders without errors
2. Navbar has Assembly link in correct position
3. Preview workflow calls /api/v1/assembly/preview and displays results
4. Render workflow calls /api/v1/assembly/render and polls /api/v1/assembly/status/{job_id}
5. Playwright screenshot confirms visual correctness
</verification>

<success_criteria>
- User can navigate to /assembly from navbar
- Script input textarea and ElevenLabs model selector work correctly
- Preview button triggers API call and displays match results with confidence scores
- Unmatched phrases are clearly indicated
- Render button triggers background job with progress polling
- Page follows existing UI patterns (Shadcn/UI, same styling as scripts page)
</success_criteria>

<output>
After completion, create `.planning/phases/15-script-to-video-assembly/15-02-SUMMARY.md`
</output>
