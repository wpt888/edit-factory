---
phase: 27-frontend-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/app/library/page.tsx
  - frontend/src/components/library/project-sidebar.tsx
  - frontend/src/components/library/clip-gallery.tsx
  - frontend/src/components/library/clip-editor-panel.tsx
  - frontend/src/components/library/segment-selection-modal.tsx
  - frontend/src/components/library/postiz-publish-modal.tsx
  - frontend/src/components/library/types.ts
autonomous: true
requirements: [REF-01, REF-02]
must_haves:
  truths:
    - "library/page.tsx is under 250 lines and delegates to 5-6 child components"
    - "Each extracted component has a single responsibility and its own file"
    - "pollClipStatus no longer uses raw setInterval — converted to usePolling or dedicated polling component"
    - "All existing library page functionality works identically after refactor"
    - "No inline setInterval or setTimeout patterns remain for polling in library page tree"
  artifacts:
    - path: "frontend/src/components/library/project-sidebar.tsx"
      provides: "Project list sidebar with create/delete/select"
      min_lines: 80
    - path: "frontend/src/components/library/clip-gallery.tsx"
      provides: "Main center panel: draft upload, generation progress, clip grid, workflow steps"
      min_lines: 400
    - path: "frontend/src/components/library/clip-editor-panel.tsx"
      provides: "Right sidebar: TTS, subtitles, render controls, enhancement settings"
      min_lines: 150
    - path: "frontend/src/components/library/segment-selection-modal.tsx"
      provides: "Full-screen segment selection modal with 3-column layout"
      min_lines: 200
    - path: "frontend/src/components/library/postiz-publish-modal.tsx"
      provides: "Postiz social publishing modal with integration selection"
      min_lines: 100
    - path: "frontend/src/components/library/types.ts"
      provides: "Shared interfaces: Project, Clip, ClipContent, SubtitleSettings, ExportPreset, SourceVideo, Segment, PostizIntegration"
    - path: "frontend/src/app/library/page.tsx"
      provides: "Thin orchestrator composing child components"
      min_lines: 100
  key_links:
    - from: "frontend/src/app/library/page.tsx"
      to: "frontend/src/components/library/*.tsx"
      via: "imports and props"
      pattern: "import.*from.*@/components/library/"
    - from: "frontend/src/components/library/clip-gallery.tsx"
      to: "frontend/src/hooks/use-polling.ts"
      via: "usePolling for generation progress"
      pattern: "usePolling"
    - from: "frontend/src/components/library/clip-gallery.tsx"
      to: "frontend/src/hooks/use-polling.ts"
      via: "usePolling for clip render status (replacing raw setInterval)"
      pattern: "usePolling"
---

<objective>
Split the 3085-line library/page.tsx into 5-6 focused components and eliminate the last remaining raw setInterval polling pattern (pollClipStatus).

Purpose: The library page is the largest file in the codebase. Decomposing it into single-responsibility components makes it maintainable, testable, and easier to extend. Eliminating the remaining raw setInterval for clip polling completes the polling consolidation started in Phase 26.

Output: 6 new files in `frontend/src/components/library/`, a thin orchestrator page.tsx, and zero raw setInterval patterns for polling.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-frontend-resilience/26-02-SUMMARY.md
@frontend/src/app/library/page.tsx
@frontend/src/hooks/use-polling.ts
@frontend/src/hooks/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared types and create component scaffolding</name>
  <files>
    frontend/src/components/library/types.ts
    frontend/src/components/library/project-sidebar.tsx
    frontend/src/components/library/clip-editor-panel.tsx
    frontend/src/components/library/postiz-publish-modal.tsx
    frontend/src/components/library/segment-selection-modal.tsx
  </files>
  <action>
**Step 1: Create `frontend/src/components/library/types.ts`**

Extract ALL interfaces from library/page.tsx lines 102-215 into this shared types file:
- `Project`, `Clip`, `ClipContent`, `SubtitleSettings`, `ExportPreset`, `SourceVideo`, `Segment`, `PostizIntegration`
- Export all types with `export interface`
- Also export the config helpers (`CONFIG_KEY`, `loadConfig`, `saveConfig`) from lines 7-29

**Step 2: Create `frontend/src/components/library/project-sidebar.tsx`**

Extract the left sidebar (col-span-3) from the JSX (lines 1366-1444). This component:
- Props: `projects`, `selectedProject`, `onSelectProject`, `onDeleteProject`, `onNewProject`
- Renders: project list with selection state, delete buttons, badges, empty state
- Import `EmptyState` from `@/components/empty-state`
- Import types from `./types`

**Step 3: Create `frontend/src/components/library/clip-editor-panel.tsx`**

Extract the right sidebar (col-span-3) from lines 2249-2439. This component:
- Props: `selectedClip`, `clipContent`, `editingTtsText/setEditingTtsText`, `editingSrtContent/setEditingSrtContent`, `editingSubtitleSettings/setEditingSubtitleSettings`, `selectedPreset/setSelectedPreset`, `selectedElevenLabsModel/setSelectedElevenLabsModel`, `videoFilters/setVideoFilters`, `rendering`, `onSave`, `onRender`, `onRenderAll`
- Renders: TTS tab, Subtitles tab, SubtitleEnhancementControls, VideoEnhancementControls, platform selector, ElevenLabs model selector, save/render buttons
- Import VideoEnhancementControls, SubtitleEnhancementControls, SubtitleEditor from existing component paths
- Import DEFAULT_SUBTITLE_SETTINGS, ELEVENLABS_MODELS from types/video-processing
- Empty state when no clip selected (the "Selecteaza un clip" card)

**Step 4: Create `frontend/src/components/library/postiz-publish-modal.tsx`**

Extract the Postiz modal (lines 2900-3067 approximately, the `{showPostizModal && ...}` block). This component:
- Props: `open`, `onClose`, `clip` (nullable for bulk mode), `bulkMode`, `clips` (for bulk), `onPublishComplete`
- Contains its own state: `integrations`, `selectedIntegrations`, `caption`, `scheduleDate`, `scheduleTime`, `publishing`
- Fetches integrations on mount (move `fetchPostizIntegrations` logic into component)
- Move `publishToPostiz` logic into component
- Move `toggleIntegrationSelection` and `getPlatformIcon` into component

**Step 5: Create `frontend/src/components/library/segment-selection-modal.tsx`**

Extract the segment modal (lines 2560-2870). This component:
- Props: `open`, `onClose`, `selectedProject`, `projectSegments`, `onSegmentsChange`
- Contains own state for: `sourceVideos`, `selectedSourceVideo`, `modalSegments`, `pendingSegment`, `showKeywordPopup`
- Moves these functions inside: `fetchSourceVideos`, `fetchSegmentsForVideo`, `handleSegmentCreate`, `handleSaveSegment`, `addSegmentToProject`, `removeSegmentFromProject`, `saveProjectSegments`
- Import SimpleSegmentPopup and VideoSegmentPlayer
- The keyword popup (SimpleSegmentPopup) lives inside this component

**For all components:**
- Use "use client" directive
- Follow kebab-case file naming
- PascalCase component names
- Import types from `./types`
- Use the existing Shadcn UI components (Button, Card, Badge, Dialog, etc.)
- Match exact Tailwind classes from original to preserve styling
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit 2>&1 | head -50` — should have no new type errors in the library/ components.
  </verify>
  <done>
5 new files exist under frontend/src/components/library/ with correct types, props, and extracted JSX. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract ClipGallery, refactor pollClipStatus, and wire orchestrator page</name>
  <files>
    frontend/src/components/library/clip-gallery.tsx
    frontend/src/app/library/page.tsx
  </files>
  <action>
**Step 1: Create `frontend/src/components/library/clip-gallery.tsx`**

This is the largest extracted component — the center column (col-span-6) from lines 1446-2247. It handles:

**Props interface (ClipGalleryProps):**
- `selectedProject`, `clips`, `selectedClip`, `generating`, `generationProgress`, `elapsedTime`
- `generationMode`, `setGenerationMode`, `projectSegments`, `variantCount`, `setVariantCount`
- `onSelectClip`, `onGenerateAI`, `onGenerateSegments`, `onCancelGeneration`
- `onToggleSelection`, `onDeleteClip`, `onOpenSegmentModal`, `onOpenPostizModal`, `onOpenBulkPostizModal`
- `onRenameClip`, `onResetProject`
- `formatTime` helper (or define locally)

**Rendering sections to extract:**
1. Draft state: generation mode toggle, AI upload form, segments mode form
2. Generating state: progress bar, timer, cancel button
3. Empty clips state: reset button
4. Clips grid: thumbnails, selection, hover actions, rename, status badges
5. Workflow steps panel: script/audio, duration, segment generation

**CRITICAL — pollClipStatus refactor (REF-02):**

The `pollClipStatus` function (line 940-959) currently uses raw `setInterval`. Convert it using one of these patterns:

**Recommended approach:** Create a small `ClipStatusPoller` component that wraps usePolling:

```tsx
function ClipStatusPoller({ clipId, onStatusUpdate, onComplete }: {
  clipId: string;
  onStatusUpdate: (clip: Clip) => void;
  onComplete: () => void;
}) {
  usePolling<{ clip: Clip }>({
    endpoint: `/library/clips/${clipId}`,
    interval: 2000,
    enabled: true,
    onData: (data) => {
      onStatusUpdate(data.clip);
      if (data.clip.final_status === "completed" || data.clip.final_status === "failed") {
        onComplete();
      }
    },
    shouldStop: (data) =>
      data.clip.final_status === "completed" || data.clip.final_status === "failed",
  });
  return null; // Invisible component, just for polling
}
```

Then in ClipGallery (or page.tsx), instead of calling `pollClipStatus(clipId)`, render `<ClipStatusPoller clipId={renderingClipId} ... />` when a clip is being rendered.

Add state `renderingClipId: string | null` to track which clip is rendering. When renderFinalClip or renderAllSelected are called, set the rendering clip ID. The ClipStatusPoller renders conditionally when renderingClipId is non-null.

**Step 2: Rewrite `frontend/src/app/library/page.tsx` as thin orchestrator**

The page.tsx should:
1. Keep all `useState` declarations (they define the shared state)
2. Keep all `useCallback`/`useEffect` for data fetching and URL sync
3. Keep handler functions that call API endpoints (fetchProjects, createProject, generateRawClips, cancelGeneration, renderFinalClip, etc.)
4. Remove ALL JSX rendering — delegate to child components:

```tsx
return (
  <div className="min-h-screen bg-background text-foreground">
    <div className="container mx-auto px-4 py-6">
      <div className="grid grid-cols-12 gap-6">
        {/* Left sidebar */}
        <div className="col-span-3">
          <ProjectSidebar
            projects={projects}
            selectedProject={selectedProject}
            onSelectProject={handleSelectProject}
            onDeleteProject={requestDeleteProject}
            onNewProject={() => setShowNewProject(true)}
          />
        </div>

        {/* Main content */}
        <div className="col-span-6">
          <ClipGallery ... />
        </div>

        {/* Right sidebar */}
        <div className="col-span-3">
          <ClipEditorPanel ... />
        </div>
      </div>
    </div>

    {/* Dialogs */}
    <Dialog open={showNewProject} onOpenChange={setShowNewProject}>...</Dialog>
    <Dialog open={showDeleteDialog} ...>...</Dialog>
    {projectToDelete && <ProjectDeleteConfirm ... />}

    {/* Modals */}
    <SegmentSelectionModal ... />
    <PostizPublishModal ... />

    {/* Render polling */}
    {renderingClipId && <ClipStatusPoller ... />}
  </div>
);
```

The New Project dialog and Delete Clip dialog can stay inline in page.tsx since they're small (keep page under 250 lines of JSX is the target, but total file can be larger due to state/handlers).

**Step 3: Verify no raw setInterval/setTimeout patterns for polling remain.**

Search the entire library/ directory and components/library/ for `setInterval`. The only acceptable setInterval is the elapsed timer (line 254-281) which is a display timer, not a polling pattern.

**Important implementation notes:**
- The `generationIntervalRef` (line 241) is already unused/legacy — remove it during refactor.
- The elapsed time timer (timerRef, lines 251-281) is a display concern, NOT polling. It can stay in page.tsx or move to ClipGallery. It's not subject to REF-02.
- Preserve all URL sync logic in page.tsx (it's state-level, not rendering).
- Preserve all config persistence logic in page.tsx.
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit 2>&1 | head -50` — no type errors
2. `grep -rn "setInterval" frontend/src/app/library/page.tsx frontend/src/components/library/` — only the elapsed timer setInterval (display only), no polling setInterval
3. `wc -l frontend/src/app/library/page.tsx` — significantly reduced from 3085 (target: under 600 lines including state/handlers)
4. `ls frontend/src/components/library/` — 6-7 files exist (types.ts + 5 components + optional ClipStatusPoller)
  </verify>
  <done>
library/page.tsx is a thin orchestrator under 600 lines. ClipGallery renders the main content. pollClipStatus replaced with usePolling-based ClipStatusPoller component. No raw setInterval polling patterns remain. All library page functionality preserved.
  </done>
</task>

</tasks>

<verification>
1. **TypeScript compiles:** `cd frontend && npx tsc --noEmit` passes with no errors
2. **Component count:** `ls frontend/src/components/library/` shows 6-7 files
3. **Page size:** `wc -l frontend/src/app/library/page.tsx` is significantly reduced from 3085
4. **No polling setInterval:** `grep -rn "setInterval" frontend/src/app/library/ frontend/src/components/library/` shows only the elapsed-time display timer, not polling
5. **usePolling usage:** `grep -rn "usePolling" frontend/src/components/library/` shows at least one usage (ClipStatusPoller)
6. **Playwright screenshot:** Take a screenshot of the library page to verify visual parity — `cd frontend && npx playwright test tests/verify-library-refactor.spec.ts`
</verification>

<success_criteria>
- library/page.tsx is decomposed into 5-6 focused child components
- Each component has a single, clear responsibility
- pollClipStatus replaced with usePolling-based pattern (no raw setInterval for polling)
- The only setInterval remaining is the elapsed-time display timer (not polling)
- All existing functionality preserved — no regressions
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-frontend-refactoring/27-01-SUMMARY.md`
</output>
