---
phase: 05-per-profile-postiz
plan: 04
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - frontend/src/app/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see video count for current profile"
    - "User can see API costs breakdown for current profile"
    - "User can see monthly quota usage"
    - "Dashboard loads automatically on Settings page"
  artifacts:
    - path: "frontend/src/app/settings/page.tsx"
      provides: "Profile activity dashboard UI"
      contains: "Profile Activity"
  key_links:
    - from: "frontend/src/app/settings/page.tsx"
      to: "/api/v1/profiles/{id}/dashboard"
      via: "apiGet fetch"
      pattern: "dashboard"
---

<objective>
Add profile activity dashboard section to Settings page

Purpose: Provide visibility into per-profile video production and API cost usage
Output: Dashboard card showing video counts, cost breakdown, and quota usage
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-per-profile-postiz/05-RESEARCH.md

@frontend/src/app/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile activity dashboard to Settings page</name>
  <files>frontend/src/app/settings/page.tsx</files>
  <action>
Add a Profile Activity dashboard card at the top of the Settings page (before TTS settings):

1. Add state for dashboard data:
```typescript
interface DashboardData {
  stats: {
    projects_count: number
    clips_count: number
    rendered_count: number
  }
  costs: {
    elevenlabs: number
    gemini: number
    total: number
    monthly: number
    monthly_quota: number | null
    quota_remaining: number | null
  }
}

const [dashboard, setDashboard] = useState<DashboardData | null>(null)
const [dashboardLoading, setDashboardLoading] = useState(true)
```

2. Add useEffect to load dashboard data:
```typescript
useEffect(() => {
  if (profileLoading || !currentProfile) return

  const loadDashboard = async () => {
    setDashboardLoading(true)
    try {
      const response = await apiGet(`/profiles/${currentProfile.id}/dashboard?time_range=30d`)
      if (!response.ok) throw new Error("Failed to load dashboard")

      const data = await response.json()
      setDashboard(data)
    } catch (error) {
      console.error("Failed to load dashboard:", error)
    } finally {
      setDashboardLoading(false)
    }
  }

  loadDashboard()
}, [currentProfile, profileLoading])
```

3. Add Dashboard card at the top of the page content (before TTS card):
```tsx
<Card>
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <BarChart3 className="h-5 w-5" />
      Profile Activity
    </CardTitle>
    <CardDescription>
      Video production and API usage for {currentProfile.name} (last 30 days)
    </CardDescription>
  </CardHeader>
  <CardContent>
    {dashboardLoading ? (
      <div className="flex items-center justify-center h-24">
        <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
      </div>
    ) : dashboard ? (
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {/* Projects */}
        <div className="p-4 bg-muted rounded-lg">
          <div className="text-2xl font-bold">{dashboard.stats.projects_count}</div>
          <div className="text-sm text-muted-foreground">Projects</div>
        </div>

        {/* Clips */}
        <div className="p-4 bg-muted rounded-lg">
          <div className="text-2xl font-bold">{dashboard.stats.clips_count}</div>
          <div className="text-sm text-muted-foreground">Clips Generated</div>
        </div>

        {/* Rendered */}
        <div className="p-4 bg-muted rounded-lg">
          <div className="text-2xl font-bold">{dashboard.stats.rendered_count}</div>
          <div className="text-sm text-muted-foreground">Clips Rendered</div>
        </div>

        {/* Monthly Costs */}
        <div className="p-4 bg-muted rounded-lg">
          <div className="text-2xl font-bold">${dashboard.costs.monthly.toFixed(2)}</div>
          <div className="text-sm text-muted-foreground">This Month</div>
        </div>
      </div>
    ) : (
      <p className="text-center text-muted-foreground">Failed to load dashboard data</p>
    )}

    {/* Quota Progress (if quota set) */}
    {dashboard && dashboard.costs.monthly_quota && dashboard.costs.monthly_quota > 0 && (
      <div className="mt-4 pt-4 border-t">
        <div className="flex justify-between text-sm mb-2">
          <span>Monthly Quota Usage</span>
          <span>
            ${dashboard.costs.monthly.toFixed(2)} / ${dashboard.costs.monthly_quota.toFixed(2)}
          </span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
          <div
            className={`h-2.5 rounded-full ${
              (dashboard.costs.monthly / dashboard.costs.monthly_quota) > 0.9
                ? 'bg-red-500'
                : (dashboard.costs.monthly / dashboard.costs.monthly_quota) > 0.7
                  ? 'bg-yellow-500'
                  : 'bg-green-500'
            }`}
            style={{
              width: `${Math.min(100, (dashboard.costs.monthly / dashboard.costs.monthly_quota) * 100)}%`
            }}
          />
        </div>
        {dashboard.costs.quota_remaining !== null && (
          <p className="text-xs text-muted-foreground mt-1">
            ${dashboard.costs.quota_remaining.toFixed(2)} remaining this month
          </p>
        )}
      </div>
    )}

    {/* Cost Breakdown */}
    {dashboard && dashboard.costs.total > 0 && (
      <div className="mt-4 pt-4 border-t">
        <h4 className="text-sm font-medium mb-2">Cost Breakdown (All Time)</h4>
        <div className="grid grid-cols-2 gap-2 text-sm">
          <div className="flex justify-between">
            <span className="text-muted-foreground">ElevenLabs TTS:</span>
            <span>${dashboard.costs.elevenlabs.toFixed(4)}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-muted-foreground">Gemini Vision:</span>
            <span>${dashboard.costs.gemini.toFixed(4)}</span>
          </div>
        </div>
        <div className="flex justify-between font-medium mt-2 pt-2 border-t">
          <span>Total:</span>
          <span>${dashboard.costs.total.toFixed(4)}</span>
        </div>
      </div>
    )}
  </CardContent>
</Card>
```

4. Add BarChart3 import: `import { ..., BarChart3 } from "lucide-react"`
  </action>
  <verify>
Build check: `cd "/mnt/c/OBSID SRL/n8n/edit_factory/frontend" && npm run build 2>&1 | head -50`
Grep for dashboard: `grep -n "Profile Activity" frontend/src/app/settings/page.tsx`
  </verify>
  <done>
Settings page shows profile activity dashboard with video counts, costs, and quota progress
  </done>
</task>

<task type="auto">
  <name>Task 2: Add monthly quota input to Settings page</name>
  <files>frontend/src/app/settings/page.tsx</files>
  <action>
Add a monthly quota configuration input to the Settings page (in a new "Usage Limits" card after Postiz):

1. Add state for quota:
```typescript
const [monthlyQuota, setMonthlyQuota] = useState<string>("")
```

2. Update loadSettings to load quota:
```typescript
// In loadSettings useEffect, add:
if (data.monthly_quota_usd !== undefined && data.monthly_quota_usd !== null) {
  setMonthlyQuota(data.monthly_quota_usd.toString())
}
```

3. Update handleSave to include quota:
```typescript
// Before the apiPatch call:
const updates: any = {
  tts_settings: ttsSettings,
}

// Add quota if entered
const quotaValue = parseFloat(monthlyQuota)
if (!isNaN(quotaValue) && quotaValue >= 0) {
  updates.monthly_quota_usd = quotaValue
}

const response = await apiPatch(`/profiles/${currentProfile.id}`, updates)
```

4. Add Usage Limits card after Postiz card:
```tsx
<Card>
  <CardHeader>
    <CardTitle>Usage Limits</CardTitle>
    <CardDescription>
      Set monthly spending limits for API usage
    </CardDescription>
  </CardHeader>
  <CardContent className="space-y-4">
    <div className="space-y-2">
      <label className="text-sm font-medium">Monthly Cost Quota (USD)</label>
      <div className="flex items-center gap-2">
        <span className="text-muted-foreground">$</span>
        <Input
          type="number"
          min="0"
          step="0.01"
          value={monthlyQuota}
          onChange={(e) => setMonthlyQuota(e.target.value)}
          placeholder="0.00"
          className="w-32"
          disabled={saving}
        />
      </div>
      <p className="text-xs text-muted-foreground">
        Set to 0 for unlimited. TTS generation will be blocked when quota is exceeded.
      </p>
    </div>
  </CardContent>
</Card>
```

Note: The quota is saved with the existing Save button at the bottom, keeping all settings in one save action.
  </action>
  <verify>
Build check: `cd "/mnt/c/OBSID SRL/n8n/edit_factory/frontend" && npm run build 2>&1 | head -50`
Grep for quota: `grep -n "monthly_quota" frontend/src/app/settings/page.tsx`
  </verify>
  <done>
Settings page allows configuring monthly cost quota with visual feedback
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd "/mnt/c/OBSID SRL/n8n/edit_factory/frontend" && npm run build`
2. Dashboard section exists: `grep -n "Profile Activity" frontend/src/app/settings/page.tsx`
3. Quota input exists: `grep -n "Usage Limits" frontend/src/app/settings/page.tsx`
</verification>

<success_criteria>
- Settings page shows Profile Activity dashboard at top
- Dashboard displays project count, clip count, rendered count
- Dashboard shows monthly costs with visual progress bar when quota set
- Dashboard shows cost breakdown by service (ElevenLabs, Gemini)
- User can configure monthly quota in Usage Limits section
- Save button persists quota along with TTS and Postiz settings
</success_criteria>

<output>
After completion, create `.planning/phases/05-per-profile-postiz/05-04-SUMMARY.md`
</output>
