---
phase: 05-per-profile-postiz
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/api/routes.py
  - app/api/profiles_routes.py
  - app/services/cost_tracker.py
autonomous: true

must_haves:
  truths:
    - "TTS generation blocked when profile exceeds monthly quota"
    - "Profile dashboard endpoint returns video count and costs"
    - "Monthly costs calculated correctly per profile"
  artifacts:
    - path: "app/api/routes.py"
      provides: "Quota enforcement before TTS generation"
      contains: "quota_exceeded"
    - path: "app/api/profiles_routes.py"
      provides: "Dashboard endpoint"
      contains: "/profiles/{profile_id}/dashboard"
    - path: "app/services/cost_tracker.py"
      provides: "Monthly cost calculation"
      contains: "get_monthly_costs"
  key_links:
    - from: "app/api/routes.py"
      to: "app/services/cost_tracker.py"
      via: "get_monthly_costs check"
      pattern: "get_monthly_costs.*profile_id"
    - from: "app/api/profiles_routes.py"
      to: "supabase editai_projects/editai_clips"
      via: "count queries"
      pattern: "count.*exact"
---

<objective>
Add cost quota enforcement and profile activity dashboard API

Purpose: Prevent overspending on TTS API calls and provide visibility into per-profile activity
Output: Quota check before TTS generation, dashboard endpoint returning video counts and cost totals
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-per-profile-postiz/05-RESEARCH.md

@app/api/routes.py
@app/api/profiles_routes.py
@app/services/cost_tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add monthly cost calculation to cost_tracker.py</name>
  <files>app/services/cost_tracker.py</files>
  <action>
Add a method to calculate current month's costs for quota enforcement:

1. Add `get_monthly_costs(profile_id: str) -> float` method to CostTracker class:
```python
def get_monthly_costs(self, profile_id: str) -> float:
    """Get current calendar month's total costs for a profile."""
    from datetime import datetime

    # Get first day of current month
    now = datetime.now()
    month_start = now.replace(day=1, hour=0, minute=0, second=0, microsecond=0)

    if self._supabase:
        try:
            result = self._supabase.table("api_costs")\
                .select("estimated_cost")\
                .eq("profile_id", profile_id)\
                .gte("created_at", month_start.isoformat())\
                .execute()

            total = sum(float(row.get("estimated_cost", 0)) for row in result.data)
            return round(total, 4)
        except Exception as e:
            logger.warning(f"Failed to get monthly costs from Supabase: {e}")

    # Fallback to local log
    data = self._load_log()
    entries = data.get("entries", [])

    # Filter by profile and current month
    monthly_entries = [
        e for e in entries
        if e.get("details", {}).get("profile_id") == profile_id
        and e.get("timestamp", "").startswith(month_start.strftime("%Y-%m"))
    ]

    total = sum(e.get("cost_usd", 0) for e in monthly_entries)
    return round(total, 4)
```

2. Add helper function for quota check:
```python
def check_quota(self, profile_id: str, monthly_quota: float) -> tuple[bool, float, float]:
    """
    Check if profile has exceeded quota.

    Args:
        profile_id: Profile UUID
        monthly_quota: Monthly quota in USD (0 = unlimited)

    Returns:
        Tuple of (exceeded: bool, current_costs: float, quota: float)
    """
    if monthly_quota <= 0:
        return False, 0, 0  # Unlimited

    current = self.get_monthly_costs(profile_id)
    exceeded = current >= monthly_quota
    return exceeded, current, monthly_quota
```

This enables quota checking with a single call that returns all needed info.
  </action>
  <verify>
Python syntax: `python -c "from app.services.cost_tracker import get_cost_tracker; t = get_cost_tracker(); print(hasattr(t, 'get_monthly_costs'))"`
  </verify>
  <done>
CostTracker has get_monthly_costs() and check_quota() methods for quota enforcement
  </done>
</task>

<task type="auto">
  <name>Task 2: Add quota enforcement to TTS generation endpoint</name>
  <files>app/api/routes.py</files>
  <action>
Add quota check before TTS generation in the `/tts/generate` endpoint:

1. Find the TTS generate endpoint (POST /tts/generate)

2. Add quota check at the start of the endpoint, after profile context validation:
```python
# Check quota if profile has one set
supabase = get_supabase()
if supabase:
    try:
        profile_data = supabase.table("profiles")\
            .select("monthly_quota_usd")\
            .eq("id", profile.profile_id)\
            .single()\
            .execute()

        monthly_quota = float(profile_data.data.get("monthly_quota_usd", 0) or 0)

        if monthly_quota > 0:
            from app.services.cost_tracker import get_cost_tracker
            tracker = get_cost_tracker()
            exceeded, current, quota = tracker.check_quota(profile.profile_id, monthly_quota)

            if exceeded:
                raise HTTPException(
                    status_code=402,  # Payment Required
                    detail={
                        "error": "quota_exceeded",
                        "message": f"Monthly quota exceeded. Current: ${current:.2f}, Quota: ${quota:.2f}",
                        "current_costs": current,
                        "monthly_quota": quota
                    }
                )
    except HTTPException:
        raise  # Re-raise quota exception
    except Exception as e:
        logger.warning(f"Failed to check quota: {e}")
        # Continue without quota check on error (graceful degradation)
```

3. Import HTTPException if not already imported

Note: The quota check happens BEFORE starting the background task, so users get immediate feedback if quota exceeded. Provider-specific (ElevenLabs costs money, Edge/Coqui/Kokoro are free) quota is not enforced at this level - it's a total monthly spend limit.
  </action>
  <verify>
Grep for quota check: `grep -n "quota_exceeded" app/api/routes.py`
Python syntax: `python -c "from app.api.routes import router"`
  </verify>
  <done>
TTS generation endpoint rejects requests when profile exceeds monthly quota
  </done>
</task>

<task type="auto">
  <name>Task 3: Add profile dashboard endpoint</name>
  <files>app/api/profiles_routes.py</files>
  <action>
Add a dashboard endpoint to return profile activity summary:

1. Add new endpoint GET `/profiles/{profile_id}/dashboard`:
```python
@router.get("/profiles/{profile_id}/dashboard")
async def get_profile_dashboard(
    profile_id: str,
    profile: ProfileContext = Depends(get_profile_context),
    time_range: str = Query("30d", regex="^(7d|30d|90d|all)$")
):
    """
    Get profile activity dashboard data.
    Returns video counts, API costs, and recent activity.
    """
    # Verify ownership
    if profile.profile_id != profile_id:
        raise HTTPException(status_code=403, detail="Access denied to this profile")

    supabase = get_supabase()
    if not supabase:
        raise HTTPException(status_code=503, detail="Database not available")

    from datetime import datetime, timedelta

    # Calculate date filter
    now = datetime.now()
    if time_range == "7d":
        start_date = now - timedelta(days=7)
    elif time_range == "30d":
        start_date = now - timedelta(days=30)
    elif time_range == "90d":
        start_date = now - timedelta(days=90)
    else:
        start_date = None  # All time

    # Project count
    projects_query = supabase.table("editai_projects")\
        .select("id", count="exact")\
        .eq("profile_id", profile_id)
    if start_date:
        projects_query = projects_query.gte("created_at", start_date.isoformat())
    projects_result = projects_query.execute()

    # Clip count
    clips_query = supabase.table("editai_clips")\
        .select("id, final_status", count="exact")\
        .eq("profile_id", profile_id)
    if start_date:
        clips_query = clips_query.gte("created_at", start_date.isoformat())
    clips_result = clips_query.execute()

    # Count rendered clips (final_status = 'completed')
    rendered_count = sum(1 for c in clips_result.data if c.get("final_status") == "completed")

    # Get costs summary
    from app.services.cost_tracker import get_cost_tracker
    tracker = get_cost_tracker()
    costs = tracker.get_summary(profile_id=profile_id)

    # Get monthly costs for quota display
    monthly_costs = tracker.get_monthly_costs(profile_id)

    # Get profile quota
    profile_data = supabase.table("profiles")\
        .select("monthly_quota_usd")\
        .eq("id", profile_id)\
        .single()\
        .execute()
    monthly_quota = float(profile_data.data.get("monthly_quota_usd", 0) or 0)

    return {
        "profile_id": profile_id,
        "time_range": time_range,
        "stats": {
            "projects_count": projects_result.count or 0,
            "clips_count": clips_result.count or 0,
            "rendered_count": rendered_count
        },
        "costs": {
            "elevenlabs": costs.get("totals", {}).get("elevenlabs", 0),
            "gemini": costs.get("totals", {}).get("gemini", 0),
            "total": costs.get("total_all", 0),
            "monthly": monthly_costs,
            "monthly_quota": monthly_quota,
            "quota_remaining": max(0, monthly_quota - monthly_costs) if monthly_quota > 0 else None
        }
    }
```

2. Add Query import if needed: `from fastapi import ..., Query`

3. Add timedelta import if needed: `from datetime import datetime, timedelta`
  </action>
  <verify>
Python syntax: `python -c "from app.api.profiles_routes import router"`
Grep for dashboard: `grep -n "dashboard" app/api/profiles_routes.py`
  </verify>
  <done>
Profile dashboard endpoint returns video counts, cost totals, and quota status
  </done>
</task>

</tasks>

<verification>
1. Python imports: `python -c "from app.services.cost_tracker import get_cost_tracker; from app.api.routes import router; from app.api.profiles_routes import router"`
2. Dashboard endpoint exists: `grep -A5 "/dashboard" app/api/profiles_routes.py`
3. Quota enforcement exists: `grep -n "quota_exceeded" app/api/routes.py`
</verification>

<success_criteria>
- CostTracker.get_monthly_costs() calculates current month's costs per profile
- CostTracker.check_quota() returns exceeded status, current costs, and quota
- TTS generate endpoint returns 402 when quota exceeded
- Dashboard endpoint returns project/clip counts and cost breakdown
- Dashboard includes monthly costs, quota, and remaining balance
</success_criteria>

<output>
After completion, create `.planning/phases/05-per-profile-postiz/05-03-SUMMARY.md`
</output>
