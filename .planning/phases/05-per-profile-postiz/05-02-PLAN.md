---
phase: 05-per-profile-postiz
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/app/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter Postiz API URL in Settings page"
    - "User can enter Postiz API key in Settings page"
    - "User can test Postiz connection before saving"
    - "Postiz credentials saved to profile's tts_settings.postiz"
  artifacts:
    - path: "frontend/src/app/settings/page.tsx"
      provides: "Postiz configuration UI"
      contains: "Postiz Publishing"
  key_links:
    - from: "frontend/src/app/settings/page.tsx"
      to: "/api/v1/profiles/{id}"
      via: "apiPatch with tts_settings.postiz"
      pattern: "postiz.*api_url"
---

<objective>
Add Postiz configuration section to Settings page

Purpose: Enable users to configure per-profile Postiz API credentials from the UI
Output: Settings page with Postiz URL/key inputs, connection test button, and save functionality
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-per-profile-postiz/05-RESEARCH.md

@frontend/src/app/settings/page.tsx
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Postiz configuration section to Settings page</name>
  <files>frontend/src/app/settings/page.tsx</files>
  <action>
Extend the existing Settings page with a new Postiz configuration card below the TTS settings card:

1. Add new state variables for Postiz settings:
```typescript
const [postizUrl, setPostizUrl] = useState("")
const [postizKey, setPostizKey] = useState("")
const [postizEnabled, setPostizEnabled] = useState(false)
const [testingConnection, setTestingConnection] = useState(false)
const [connectionStatus, setConnectionStatus] = useState<"idle" | "success" | "error">("idle")
```

2. Update the TTSSettings interface to include postiz:
```typescript
interface TTSSettings {
  provider: string
  voice_id: string
  voice_name?: string
  postiz?: {
    api_url: string
    api_key: string
    enabled: boolean
  }
}
```

3. Update loadSettings useEffect to load Postiz settings:
```typescript
const postizSettings = data.tts_settings?.postiz || {}
setPostizUrl(postizSettings.api_url || "")
setPostizKey(postizSettings.api_key || "")
setPostizEnabled(postizSettings.enabled || false)
```

4. Add "Test Connection" function:
```typescript
const handleTestConnection = async () => {
  if (!postizUrl || !postizKey) {
    alert("Please enter Postiz API URL and API Key first")
    return
  }

  setTestingConnection(true)
  setConnectionStatus("idle")

  try {
    // Test using the current profile's credentials (will use saved or env fallback)
    const response = await apiGet("/postiz/status")
    if (!response.ok) throw new Error("Connection failed")

    const data = await response.json()
    if (data.connected) {
      setConnectionStatus("success")
      alert(`Connected successfully! Found ${data.integrations_count} social media accounts.`)
    } else {
      setConnectionStatus("error")
      alert(`Connection failed: ${data.error || "Unknown error"}`)
    }
  } catch (error) {
    setConnectionStatus("error")
    alert(error instanceof Error ? error.message : "Connection test failed")
  } finally {
    setTestingConnection(false)
  }
}
```

5. Update handleSave to include Postiz settings:
```typescript
const ttsSettings: TTSSettings = {
  provider,
  voice_id: voiceId,
  postiz: {
    api_url: postizUrl,
    api_key: postizKey,
    enabled: postizEnabled
  }
}

// Add voice name if available
const selectedVoice = voices.find(v => v.voice_id === voiceId)
if (selectedVoice) {
  ttsSettings.voice_name = selectedVoice.name
}
```

6. Add new Card for Postiz settings after TTS card:
```tsx
<Card>
  <CardHeader>
    <CardTitle>Postiz Publishing</CardTitle>
    <CardDescription>
      Configure social media publishing credentials for {currentProfile.name}
    </CardDescription>
  </CardHeader>
  <CardContent className="space-y-4">
    <div className="space-y-2">
      <label className="text-sm font-medium">Postiz API URL</label>
      <Input
        value={postizUrl}
        onChange={(e) => setPostizUrl(e.target.value)}
        placeholder="https://api.postiz.com"
        disabled={saving}
      />
      <p className="text-xs text-muted-foreground">
        The URL of your Postiz API server
      </p>
    </div>

    <div className="space-y-2">
      <label className="text-sm font-medium">Postiz API Key</label>
      <Input
        type="password"
        value={postizKey}
        onChange={(e) => setPostizKey(e.target.value)}
        placeholder="pk_live_..."
        disabled={saving}
      />
      <p className="text-xs text-muted-foreground">
        Your Postiz API key (found in Postiz settings)
      </p>
    </div>

    <div className="flex items-center gap-4">
      <Button
        variant="outline"
        onClick={handleTestConnection}
        disabled={testingConnection || !postizUrl || !postizKey}
      >
        {testingConnection ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            Testing...
          </>
        ) : (
          "Test Connection"
        )}
      </Button>
      {connectionStatus === "success" && (
        <span className="text-sm text-green-600">Connected</span>
      )}
      {connectionStatus === "error" && (
        <span className="text-sm text-red-600">Connection failed</span>
      )}
    </div>
  </CardContent>
</Card>
```

7. Add Input import if not present: `import { Input } from "@/components/ui/input"`

Note: The Postiz card should appear AFTER the TTS card, using the same pattern for spacing (space-y-6 on the parent container).
  </action>
  <verify>
Build check: `cd "/mnt/c/OBSID SRL/n8n/edit_factory/frontend" && npm run build 2>&1 | head -50`
Grep for Postiz section: `grep -n "Postiz Publishing" frontend/src/app/settings/page.tsx`
  </verify>
  <done>
Settings page has Postiz configuration section with URL input, API key input, and test connection button
  </done>
</task>

<task type="auto">
  <name>Task 2: Add connection status indicator and API key masking</name>
  <files>frontend/src/app/settings/page.tsx</files>
  <action>
Enhance the Postiz section with better UX:

1. Add state for showing/hiding API key:
```typescript
const [showApiKey, setShowApiKey] = useState(false)
```

2. Update the API key input to support show/hide:
```tsx
<div className="space-y-2">
  <label className="text-sm font-medium">Postiz API Key</label>
  <div className="flex gap-2">
    <Input
      type={showApiKey ? "text" : "password"}
      value={postizKey}
      onChange={(e) => setPostizKey(e.target.value)}
      placeholder="pk_live_..."
      disabled={saving}
      className="flex-1"
    />
    <Button
      type="button"
      variant="ghost"
      size="icon"
      onClick={() => setShowApiKey(!showApiKey)}
    >
      {showApiKey ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
    </Button>
  </div>
  <p className="text-xs text-muted-foreground">
    Your Postiz API key (found in Postiz settings)
  </p>
</div>
```

3. Add Eye and EyeOff imports: `import { ..., Eye, EyeOff } from "lucide-react"`

4. Add visual indicator for saved credentials:
```tsx
{postizUrl && postizKey && (
  <div className="flex items-center gap-2 p-3 bg-muted rounded-md">
    <div className={`w-2 h-2 rounded-full ${connectionStatus === "success" ? "bg-green-500" : "bg-yellow-500"}`} />
    <span className="text-sm">
      {connectionStatus === "success"
        ? "Credentials configured and verified"
        : "Credentials configured (not yet verified)"}
    </span>
  </div>
)}
```

5. Move the single Save button to save both TTS and Postiz settings together (it already does since ttsSettings includes postiz).

6. Update the success alert to mention both:
```typescript
alert("Settings saved successfully (TTS and Postiz)")
```
  </action>
  <verify>
Build check: `cd "/mnt/c/OBSID SRL/n8n/edit_factory/frontend" && npm run build 2>&1 | head -50`
Grep for Eye icons: `grep -n "Eye" frontend/src/app/settings/page.tsx`
  </verify>
  <done>
Settings page has API key show/hide toggle and visual connection status indicator
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd "/mnt/c/OBSID SRL/n8n/edit_factory/frontend" && npm run build`
2. Settings page loads: Manual verification at http://localhost:3000/settings
3. Postiz section visible: Grep confirms "Postiz Publishing" text exists
</verification>

<success_criteria>
- Settings page shows Postiz configuration card
- User can enter API URL and API key
- API key has show/hide toggle
- Test Connection button validates credentials
- Save button persists Postiz settings to profile
- Visual indicator shows configuration status
</success_criteria>

<output>
After completion, create `.planning/phases/05-per-profile-postiz/05-02-SUMMARY.md`
</output>
