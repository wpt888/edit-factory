---
phase: 05-per-profile-postiz
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/postiz_service.py
  - app/api/postiz_routes.py
  - app/api/profiles_routes.py
autonomous: true

must_haves:
  truths:
    - "Profile-specific Postiz credentials loaded from database"
    - "Publishing uses profile's own Postiz API key"
    - "Cache invalidation occurs when credentials change"
  artifacts:
    - path: "app/services/postiz_service.py"
      provides: "Profile-aware Postiz factory"
      contains: "get_postiz_publisher(profile_id"
    - path: "app/api/postiz_routes.py"
      provides: "Profile-isolated publishing endpoints"
      contains: "get_postiz_publisher(profile.profile_id)"
  key_links:
    - from: "app/api/postiz_routes.py"
      to: "app/services/postiz_service.py"
      via: "get_postiz_publisher(profile_id)"
      pattern: "get_postiz_publisher\\(profile"
    - from: "app/services/postiz_service.py"
      to: "profiles.tts_settings.postiz"
      via: "Supabase query"
      pattern: "tts_settings.*postiz"
---

<objective>
Refactor Postiz service from singleton to profile-aware factory pattern

Purpose: Enable each profile to have its own Postiz API credentials, preventing cross-posting between stores
Output: Profile-specific Postiz publisher instances loaded from database, cache invalidation on credential changes
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-per-profile-postiz/05-RESEARCH.md

@app/services/postiz_service.py
@app/api/postiz_routes.py
@app/api/profiles_routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor postiz_service.py to profile-aware factory</name>
  <files>app/services/postiz_service.py</files>
  <action>
Refactor the Postiz service from global singleton to profile-aware factory pattern:

1. Replace global `_postiz_publisher` singleton with `_postiz_instances: Dict[str, PostizPublisher]` dict keyed by profile_id

2. Modify `get_postiz_publisher()` signature to require `profile_id: str` parameter:
   - Load profile's tts_settings from Supabase
   - Extract postiz config from `tts_settings.postiz` (api_url, api_key)
   - Fall back to environment variables if profile has no Postiz config
   - Raise ValueError if neither profile config nor env vars exist
   - Cache instance in `_postiz_instances[profile_id]`
   - Return cached instance on subsequent calls

3. Add `reset_postiz_publisher(profile_id: Optional[str] = None)` function:
   - If profile_id provided: remove only that profile's cached instance
   - If None: clear all cached instances
   - Used when credentials change in Settings page

4. Update `is_postiz_configured()` to accept optional profile_id:
   - If profile_id: check profile's tts_settings.postiz
   - If None: check global env vars (backward compatibility)

Pattern reference from research:
```python
_postiz_instances: Dict[str, PostizPublisher] = {}

def get_postiz_publisher(profile_id: str) -> PostizPublisher:
    if profile_id in _postiz_instances:
        return _postiz_instances[profile_id]

    # Load from database
    supabase = get_supabase()
    result = supabase.table("profiles").select("tts_settings").eq("id", profile_id).single().execute()

    postiz_config = result.data.get("tts_settings", {}).get("postiz", {})
    api_url = postiz_config.get("api_url") or os.getenv("POSTIZ_API_URL")
    api_key = postiz_config.get("api_key") or os.getenv("POSTIZ_API_KEY")

    if not api_url or not api_key:
        raise ValueError(f"Profile {profile_id} has no Postiz credentials")

    publisher = PostizPublisher(api_url=api_url, api_key=api_key)
    _postiz_instances[profile_id] = publisher
    return publisher
```

Import get_supabase from library_routes (same pattern as postiz_routes.py uses).
  </action>
  <verify>
Python syntax check: `python -c "from app.services.postiz_service import get_postiz_publisher, reset_postiz_publisher"`
Verify signature: function requires profile_id parameter
  </verify>
  <done>
Postiz service uses profile-aware factory pattern with instance caching and cache invalidation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update postiz_routes.py to use profile-specific publishers</name>
  <files>app/api/postiz_routes.py</files>
  <action>
Update all Postiz route endpoints to pass profile_id to the factory:

1. `/status` endpoint:
   - Change `publisher = get_postiz_publisher()` to `publisher = get_postiz_publisher(profile.profile_id)`
   - Wrap in try/except to catch ValueError (no credentials configured)
   - Return `configured=False` with helpful error message if no credentials

2. `/integrations` endpoint:
   - Change `publisher = get_postiz_publisher()` to `publisher = get_postiz_publisher(profile.profile_id)`
   - Catch ValueError and return 400 with "Postiz not configured for this profile"

3. `/upload` endpoint:
   - Change `publisher = get_postiz_publisher()` to `publisher = get_postiz_publisher(profile.profile_id)`
   - Catch ValueError and return 400 with helpful message

4. `/bulk-upload` endpoint:
   - Change `publisher = get_postiz_publisher()` to `publisher = get_postiz_publisher(profile.profile_id)`

5. `/publish` endpoint:
   - Change `publisher = get_postiz_publisher()` to `publisher = get_postiz_publisher(profile.profile_id)`
   - Update `_publish_clip_task` to use `get_postiz_publisher(profile_id)` inside the task

6. `/bulk-publish` endpoint:
   - Update `_bulk_publish_task` to use `get_postiz_publisher(profile_id)` inside the task

7. Background tasks `_publish_clip_task` and `_bulk_publish_task`:
   - Both already receive `profile_id` parameter
   - Change `publisher = get_postiz_publisher()` to `publisher = get_postiz_publisher(profile_id)`

Pattern for error handling:
```python
try:
    publisher = get_postiz_publisher(profile.profile_id)
except ValueError as e:
    raise HTTPException(status_code=400, detail=str(e))
```
  </action>
  <verify>
Server starts without errors: `cd "/mnt/c/OBSID SRL/n8n/edit_factory" && timeout 5 python -c "from app.api.postiz_routes import router" || true`
Grep for old pattern: `grep -n "get_postiz_publisher()" app/api/postiz_routes.py` should return nothing
  </verify>
  <done>
All Postiz routes use profile-specific publisher instances
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cache invalidation to profiles PATCH endpoint</name>
  <files>app/api/profiles_routes.py</files>
  <action>
Update the profiles PATCH endpoint to invalidate Postiz cache when tts_settings change:

1. In the PATCH `/profiles/{profile_id}` endpoint, after successfully updating the profile:
   - Check if `tts_settings` was in the update payload
   - If yes, call `reset_postiz_publisher(profile_id)` to clear cached instance
   - Log the cache invalidation

2. Add import at top: `from app.services.postiz_service import reset_postiz_publisher`

Pattern:
```python
# After profile update succeeds
if "tts_settings" in updates:
    from app.services.postiz_service import reset_postiz_publisher
    reset_postiz_publisher(profile_id)
    logger.info(f"[Profile {profile_id}] Reset Postiz publisher cache after settings update")
```

This ensures that when a user saves new Postiz credentials in Settings, the next publish operation uses the new credentials immediately.
  </action>
  <verify>
Python syntax check: `python -c "from app.api.profiles_routes import router"`
Grep for reset call: `grep -n "reset_postiz_publisher" app/api/profiles_routes.py`
  </verify>
  <done>
Postiz cache invalidation triggered when profile tts_settings change
  </done>
</task>

</tasks>

<verification>
1. Python imports work: `python -c "from app.services.postiz_service import get_postiz_publisher, reset_postiz_publisher; from app.api.postiz_routes import router"`
2. Server starts: `cd "/mnt/c/OBSID SRL/n8n/edit_factory" && timeout 10 python run.py &` then check for errors
3. No old singleton pattern: `grep -r "get_postiz_publisher()" app/` should return only comments or no results
</verification>

<success_criteria>
- Postiz service loads credentials from profile's tts_settings.postiz
- Each profile gets its own cached PostizPublisher instance
- Cache cleared when profile settings updated
- All routes pass profile_id to get_postiz_publisher()
- Falls back to env vars if profile has no Postiz config
</success_criteria>

<output>
After completion, create `.planning/phases/05-per-profile-postiz/05-01-SUMMARY.md`
</output>
