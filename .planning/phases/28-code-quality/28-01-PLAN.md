---
phase: 28-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/product_generate_routes.py
  - app/api/feed_routes.py
  - app/api/tts_routes.py
  - app/api/product_routes.py
  - app/api/script_routes.py
  - app/api/postiz_routes.py
  - app/api/assembly_routes.py
  - app/api/pipeline_routes.py
  - app/api/profile_routes.py
  - app/services/postiz_service.py
  - app/api/library_routes.py
autonomous: true
requirements:
  - QUAL-01
  - QUAL-03

must_haves:
  truths:
    - "Every backend module that accesses Supabase imports get_supabase from app.db — no local redefinitions exist"
    - "Log output contains no MUTE DEBUG lines"
    - "No local _get_supabase or get_supabase function definitions exist outside app/db.py"
  artifacts:
    - path: "app/db.py"
      provides: "Single Supabase client singleton"
      contains: "def get_supabase"
    - path: "app/api/library_routes.py"
      provides: "Render endpoint without debug noise"
  key_links:
    - from: "app/api/product_generate_routes.py"
      to: "app/db.py"
      via: "from app.db import get_supabase"
      pattern: "from app\\.db import get_supabase"
    - from: "app/api/feed_routes.py"
      to: "app/db.py"
      via: "from app.db import get_supabase"
      pattern: "from app\\.db import get_supabase"
    - from: "app/api/postiz_routes.py"
      to: "app/db.py"
      via: "from app.db import get_supabase"
      pattern: "from app\\.db import get_supabase"
---

<objective>
Centralize all Supabase client access through app/db.py and remove debug log noise.

Purpose: Eliminate 10 duplicate get_supabase() definitions scattered across route and service files, and clean up [MUTE DEBUG] log lines that pollute log output. This reduces maintenance burden (one place to change Supabase config) and makes logs useful for real debugging.

Output: All backend files import get_supabase from app.db; no [MUTE DEBUG] lines in logs.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/db.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace all duplicate Supabase client definitions with app.db import</name>
  <files>
    app/api/product_generate_routes.py
    app/api/feed_routes.py
    app/api/tts_routes.py
    app/api/product_routes.py
    app/api/script_routes.py
    app/api/postiz_routes.py
    app/api/assembly_routes.py
    app/api/pipeline_routes.py
    app/api/profile_routes.py
    app/services/postiz_service.py
  </files>
  <action>
    In each of the 10 files listed below, remove the local get_supabase/_get_supabase function definition and replace it with `from app.db import get_supabase` at the top of the file (in the imports section).

    **Files with local `_get_supabase()` that call create_client directly (4 files):**
    1. `app/api/product_generate_routes.py` — delete the `_get_supabase()` function (~lines 88-92), add `from app.db import get_supabase` to imports, replace all `_get_supabase()` calls with `get_supabase()`
    2. `app/api/feed_routes.py` — delete the `_get_supabase()` function (~lines 53-57), add `from app.db import get_supabase` to imports, replace all `_get_supabase()` calls with `get_supabase()`
    3. `app/api/tts_routes.py` — delete the `_get_supabase()` function (~line 237+), add `from app.db import get_supabase` to imports, replace all `_get_supabase()` calls with `get_supabase()`
    4. `app/api/product_routes.py` — delete the `_get_supabase()` function (~line 29+), add `from app.db import get_supabase` to imports, replace all `_get_supabase()` calls with `get_supabase()`

    **Files with local `get_supabase()` that wrap or redefine (5 files):**
    5. `app/api/script_routes.py` — delete local `get_supabase()` (~line 20+), add `from app.db import get_supabase` to imports
    6. `app/api/postiz_routes.py` — delete local `get_supabase()` (~line 92+) which wraps library_routes import, add `from app.db import get_supabase` to imports
    7. `app/api/assembly_routes.py` — delete local `get_supabase()` (~line 27+), add `from app.db import get_supabase` to imports
    8. `app/api/pipeline_routes.py` — delete local `get_supabase()` (~line 31+), add `from app.db import get_supabase` to imports
    9. `app/api/profile_routes.py` — delete local `get_supabase()` (~line 22+), add `from app.db import get_supabase` to imports

    **Service file:**
    10. `app/services/postiz_service.py` — delete local `_get_supabase()` (~line 309+), add `from app.db import get_supabase` to imports, replace `_get_supabase()` calls with `get_supabase()`

    **Important:** Some files (like postiz_routes.py) have local get_supabase that wraps the library_routes import — these should be replaced with direct app.db import. The app.db version is already a singleton with error handling, so no functionality is lost.

    After editing, verify no local definitions remain:
    `grep -rn "def get_supabase\|def _get_supabase" app/ | grep -v "app/db.py"` should return empty.
  </action>
  <verify>
    1. `grep -rn "def get_supabase\|def _get_supabase" app/ | grep -v "app/db.py"` returns nothing
    2. `grep -rn "from app.db import get_supabase" app/` shows all 10 files plus existing ones (main.py, auth.py, segments_routes.py, tts_library_routes.py, library_routes.py, elevenlabs_account_manager.py, assembly_service.py)
    3. `python -c "from app.main import app; print('OK')"` succeeds (no import errors)
  </verify>
  <done>All 10 duplicate Supabase client definitions removed. Every backend file accesses Supabase via `from app.db import get_supabase`. No local create_client calls remain outside app/db.py.</done>
</task>

<task type="auto">
  <name>Task 2: Remove [MUTE DEBUG] log lines and clean up debug print statements</name>
  <files>
    app/api/library_routes.py
  </files>
  <action>
    In `app/api/library_routes.py`, find and remove all logger.info calls containing `[MUTE DEBUG]`. There are 9 instances:
    - Line ~802: `logger.info(f"[MUTE DEBUG] /generate-from-segments called...")`
    - Line ~803: `logger.info(f"[MUTE DEBUG] Request parameters:...")`
    - Line ~1091: `logger.info(f"[MUTE DEBUG] Project {project_id}: mute_source_voice=...")`
    - Line ~1093: `logger.info(f"[MUTE DEBUG] Starting voice detection...")`
    - Line ~1196: `logger.info(f"[MUTE DEBUG] Segment {seg['id'][:8]}:...")`
    - Line ~1204: `logger.info(f"[MUTE DEBUG] Found {len(overlapping_mutes)}...")`
    - Line ~1216: `logger.info(f"[MUTE DEBUG] Applying audio filter...")`
    - Line ~1224: `logger.info(f"[MUTE DEBUG] Applying noise cancelling...")`
    - Line ~1239: `logger.info(f"[MUTE DEBUG] FFmpeg command:...")`

    Delete each of these lines entirely. Do NOT replace them with different log levels — they are temporary debug artifacts that were marked for removal. The surrounding code logic should remain untouched.

    Note: print() statements in voice_cloning_service.py, edge_tts_service.py, and vocal_remover.py are inside `if __name__ == "__main__"` test blocks and are standard Python practice — leave those alone.
  </action>
  <verify>
    1. `grep -rn "MUTE DEBUG" app/` returns nothing
    2. `python -c "from app.api.library_routes import router; print('OK')"` succeeds (no syntax errors from deletions)
  </verify>
  <done>All 9 [MUTE DEBUG] log lines removed from library_routes.py. Log output is clean of debug noise.</done>
</task>

</tasks>

<verification>
1. `grep -rn "def get_supabase\|def _get_supabase" app/ | grep -v "app/db.py"` — returns empty (no duplicate definitions)
2. `grep -rn "MUTE DEBUG" app/` — returns empty (no debug noise)
3. `grep -rn "from app.db import get_supabase" app/` — shows 17+ files all importing from central location
4. `python -c "from app.main import app; print('imports OK')"` — no import errors
</verification>

<success_criteria>
- Zero local get_supabase/_get_supabase definitions outside app/db.py
- Zero [MUTE DEBUG] lines in any backend file
- All backend modules that need Supabase import from app.db
- Application starts without import errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-code-quality/28-01-SUMMARY.md`
</output>
