---
phase: 16-multi-variant-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - frontend/src/app/pipeline/page.tsx
  - frontend/src/components/navbar.tsx
autonomous: true
must_haves:
  truths:
    - "User can enter idea, context, variant count, and AI provider on the pipeline page"
    - "User sees N generated scripts as editable cards after clicking Generate"
    - "User can preview individual variants showing segment match confidence scores"
    - "User can select which variants to render and trigger batch render"
    - "User sees per-variant render progress with status badges and download links"
  artifacts:
    - path: "frontend/src/app/pipeline/page.tsx"
      provides: "Multi-variant pipeline page with full workflow"
      min_lines: 200
    - path: "frontend/src/components/navbar.tsx"
      provides: "Pipeline navigation link"
      contains: "Pipeline"
  key_links:
    - from: "frontend/src/app/pipeline/page.tsx"
      to: "/api/v1/pipeline/generate"
      via: "apiPost in handleGenerate"
      pattern: "apiPost.*pipeline/generate"
    - from: "frontend/src/app/pipeline/page.tsx"
      to: "/api/v1/pipeline/preview"
      via: "apiPost in handlePreview"
      pattern: "apiPost.*pipeline/preview"
    - from: "frontend/src/app/pipeline/page.tsx"
      to: "/api/v1/pipeline/render"
      via: "apiPost in handleRender"
      pattern: "apiPost.*pipeline/render"
    - from: "frontend/src/app/pipeline/page.tsx"
      to: "/api/v1/pipeline/status"
      via: "apiGet in polling useEffect"
      pattern: "apiGet.*pipeline/status"
---

<objective>
Create frontend pipeline page that provides a unified end-to-end workflow: enter idea -> generate N scripts -> preview segment matches per variant -> select and batch render -> track progress and download.

Purpose: This replaces the separate Scripts + Assembly pages workflow with a single, streamlined multi-variant pipeline experience. Users see all variants side by side and control the entire flow from one page.

Output: `frontend/src/app/pipeline/page.tsx` with step-based workflow and navbar link.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-multi-variant-pipeline/16-01-SUMMARY.md

# Key source files to reference for UI patterns:
@frontend/src/app/scripts/page.tsx
@frontend/src/app/assembly/page.tsx
@frontend/src/lib/api.ts
@frontend/src/components/navbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pipeline page with step-based workflow</name>
  <files>frontend/src/app/pipeline/page.tsx</files>
  <action>
Create `frontend/src/app/pipeline/page.tsx` as a "use client" page with the following step-based workflow.

**State management:**
```
// Step tracking
step: number (1=input, 2=scripts, 3=preview, 4=render)

// Step 1: Input
idea: string
context: string
variantCount: number (default 3)
provider: string (default "gemini")
isGenerating: boolean
error: string | null

// Step 2: Scripts
pipelineId: string | null
scripts: string[]  (editable)

// Step 3: Preview
previewingIndex: number | null
previews: Record<number, PreviewData>  (keyed by variant index)
previewError: string | null

// Step 4: Render
selectedVariants: Set<number>  (which variants user wants to render)
isRendering: boolean
variantStatuses: VariantStatus[]
```

**TypeScript interfaces:**
```typescript
interface MatchPreview {
  srt_index: number;
  srt_text: string;
  srt_start: number;
  srt_end: number;
  segment_id: string | null;
  segment_keywords: string[];
  matched_keyword: string | null;
  confidence: number;
}

interface PreviewData {
  audio_duration: number;
  srt_content: string;
  matches: MatchPreview[];
  total_phrases: number;
  matched_count: number;
  unmatched_count: number;
}

interface VariantStatus {
  variant_index: number;
  status: "pending" | "processing" | "completed" | "failed";
  progress: number;
  current_step: string;
  final_video_path?: string;
  error?: string;
}
```

**Layout:** Full-width page (max-w-7xl) with step indicator at top.

**Step indicator:** Horizontal row of 4 steps showing: 1. Idea Input -> 2. Review Scripts -> 3. Preview Matches -> 4. Render Videos. Active step highlighted with primary color. Completed steps show checkmark. Use simple div-based step indicator (no external component needed).

**Step 1 — Idea Input:**
- Same layout as Scripts page left column: idea textarea (5 rows), context textarea (3 rows), variant count Select (1-10), provider Select (Gemini/Claude)
- "Generate Scripts" button — calls `apiPost("/pipeline/generate", {idea, context, variant_count, provider})`
- On success: store pipelineId, scripts; advance to step 2
- Error display via Alert component

**Step 2 — Review Scripts:**
- Display scripts as editable Card grid (2 columns on lg, 1 on mobile)
- Each card: "Script {N}" title, word count badge, editable Textarea (6 rows, font-mono)
- Word count and estimated duration (~2.5 words/sec) displayed per card
- Scripts are editable (user can refine before preview)
- "Preview All Matches" button at bottom — for each script index, call `apiPost("/pipeline/preview/{pipelineId}/{index}", {elevenlabs_model})` sequentially
- While previewing, show loading state per card
- On all previews done: advance to step 3
- "Back to Input" button to go back to step 1

**Step 3 — Preview & Select:**
- Show variant cards in grid (2 cols on lg)
- Each variant card shows:
  - "Variant {N}" title
  - Match summary: audio duration, matched/unmatched counts
  - Top 3 matches with confidence badges (green for matched, red for unmatched)
  - Checkbox to select for rendering (default: all selected)
- "Render Selected ({count})" button at bottom
- Clicking render: calls `apiPost("/pipeline/render/{pipelineId}", {variant_indices: [...selectedVariants], preset_name, elevenlabs_model, ...default subtitle/filter settings})`
- On success: advance to step 4, start polling
- "Back to Scripts" button

**Step 4 — Render Progress:**
- Show variant cards in grid (2 cols on lg)
- Each card shows:
  - "Variant {N}" title with status Badge (processing=secondary, completed=default/green, failed=destructive)
  - Progress bar (0-100%)
  - Current step text
  - If completed: "Download" button linking to `http://localhost:8000/api/v1/library/files/${encodeURIComponent(path)}`
  - If failed: error Alert
- Poll `apiGet("/pipeline/status/{pipelineId}")` every 2 seconds
- Stop polling when all variants are completed or failed
- "Start New Pipeline" button to reset all state and go to step 1

**UI components to use (all already available):**
- Button, Card, CardContent, CardHeader, CardTitle, CardDescription
- Badge, Label, Textarea, Select, SelectContent, SelectItem, SelectTrigger, SelectValue
- Alert, AlertDescription
- Checkbox (from @/components/ui/checkbox)
- Icons from lucide-react: Sparkles, Loader2, Play, Download, Film, CheckCircle, XCircle, AlertCircle, ArrowLeft, ArrowRight

**Patterns to follow:**
- Same apiGet/apiPost import pattern as scripts/page.tsx and assembly/page.tsx
- Same useEffect polling pattern as assembly/page.tsx (with cleanup)
- Same formatTime/formatDuration helpers as assembly/page.tsx
- Same responsive grid pattern (grid-cols-1 lg:grid-cols-2)

**Do NOT:**
- Create any new component files (everything inline in page.tsx)
- Add any new npm dependencies
- Modify any backend files
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit 2>&1 | grep -c "error" || echo "0 errors"` — expect 0 TypeScript errors
Verify file exists: `ls frontend/src/app/pipeline/page.tsx`
  </verify>
  <done>
Pipeline page exists at /pipeline with 4-step workflow: idea input -> script review -> preview with selection -> batch render with progress tracking and download links.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Pipeline link to navbar</name>
  <files>frontend/src/components/navbar.tsx</files>
  <action>
In `frontend/src/components/navbar.tsx`, add a "Pipeline" entry to the navLinks array.

Position it FIRST in the navLinks array (before "Librarie") since the pipeline is the primary workflow for v4 script-first video production. The pipeline page is the main entry point for creating new videos.

Add: `{ label: "Pipeline", href: "/pipeline" }` as the first item in the navLinks array.

**Do NOT** modify any other part of navbar.tsx.
  </action>
  <verify>
Run: `grep -c "Pipeline" frontend/src/components/navbar.tsx` — expect at least 1
Verify navbar renders: check that the navLinks array contains the Pipeline entry
  </verify>
  <done>
Pipeline link appears in navbar as the first navigation item, making it the primary entry point for the script-first video production workflow.
  </done>
</task>

<task type="auto">
  <name>Task 3: Visual verification with Playwright screenshot</name>
  <files>frontend/tests/verify-pipeline-page.spec.ts</files>
  <action>
Create a Playwright test that navigates to `/pipeline` and takes a screenshot to verify the page renders correctly.

```typescript
import { test } from '@playwright/test';

test('Verify pipeline page UI', async ({ page }) => {
  await page.goto('/pipeline');
  await page.waitForLoadState('networkidle');
  await page.waitForTimeout(1000);
  await page.screenshot({
    path: 'screenshots/verify-pipeline-page.png',
    fullPage: true
  });
});
```

Run the test with the frontend dev server running:
`cd frontend && npx playwright test tests/verify-pipeline-page.spec.ts --reporter=list`

Show the screenshot to verify the page layout.

Note: This test requires the frontend dev server to be running (`npm run dev`). If the dev server is not running, start it first. If the test cannot run (e.g., server not available), verify the page manually by checking that `page.tsx` compiles without TypeScript errors instead.
  </action>
  <verify>
Screenshot exists at `frontend/screenshots/verify-pipeline-page.png` OR TypeScript compilation passes with no errors.
  </verify>
  <done>
Pipeline page visually verified — renders with step indicator, input form, and proper layout matching existing page patterns.
  </done>
</task>

</tasks>

<verification>
1. `frontend/src/app/pipeline/page.tsx` exists and compiles without TypeScript errors
2. `frontend/src/components/navbar.tsx` contains "Pipeline" link
3. Pipeline page calls all 4 backend endpoints: /pipeline/generate, /pipeline/preview, /pipeline/render, /pipeline/status
4. Page has 4-step workflow with step indicator
5. Screenshot or TypeScript check confirms page renders correctly
</verification>

<success_criteria>
- Pipeline page exists at /pipeline with complete 4-step workflow
- User can generate scripts, preview matches, select variants, and batch render
- Per-variant progress tracking with download links for completed videos
- Pipeline link appears in navbar as primary navigation item
- Page follows existing UI patterns (two-column grid, Card components, Badge status indicators)
</success_criteria>

<output>
After completion, create `.planning/phases/16-multi-variant-pipeline/16-02-SUMMARY.md`
</output>
