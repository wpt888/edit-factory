---
phase: 03-frontend-profile-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/contexts/profile-context.tsx
  - frontend/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "Profile context provides currentProfile and profiles array to consumers"
    - "Profile selection persists across browser refresh via localStorage"
    - "API calls automatically include X-Profile-Id header when profile is selected"
  artifacts:
    - path: "frontend/src/contexts/profile-context.tsx"
      provides: "ProfileProvider context and useProfile hook"
      exports: ["ProfileProvider", "useProfile"]
      min_lines: 80
    - path: "frontend/src/lib/api.ts"
      provides: "API client with automatic X-Profile-Id header injection"
      contains: "X-Profile-Id"
  key_links:
    - from: "frontend/src/contexts/profile-context.tsx"
      to: "localStorage"
      via: "getItem/setItem for profile persistence"
      pattern: "localStorage\\.(get|set)Item.*editai"
    - from: "frontend/src/contexts/profile-context.tsx"
      to: "/api/v1/profiles"
      via: "apiGet for fetching profiles on mount"
      pattern: "apiGet.*profiles"
    - from: "frontend/src/lib/api.ts"
      to: "localStorage"
      via: "reading profile ID for header injection"
      pattern: "localStorage\\.getItem.*profile"
---

<objective>
Create the profile state management foundation: React Context with localStorage persistence and automatic API header injection.

Purpose: This is the foundational layer that all profile-aware components will consume. Without this, no profile switching or data isolation is possible.

Output: ProfileProvider context wrapper and modified api.ts with automatic X-Profile-Id header injection.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-frontend-profile-ui/03-RESEARCH.md

# Source files to modify/reference
@frontend/src/lib/api.ts
@frontend/src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfileProvider context with localStorage persistence</name>
  <files>frontend/src/contexts/profile-context.tsx</files>
  <action>
Create new file `frontend/src/contexts/profile-context.tsx` implementing:

1. Profile interface matching backend schema:
```typescript
interface Profile {
  id: string;
  name: string;
  description?: string;
  is_default: boolean;
  created_at: string;
}
```

2. ProfileContextType interface with:
   - currentProfile: Profile | null
   - profiles: Profile[]
   - setCurrentProfile: (profile: Profile) => void
   - refreshProfiles: () => Promise<void>
   - isLoading: boolean

3. ProfileProvider component that:
   - Uses "use client" directive (required for hooks)
   - Creates context with createContext
   - On mount: hydrates from localStorage first (instant UI), then fetches fresh from GET /profiles
   - Auto-selects profile: stored ID > default profile > first profile
   - Persists currentProfile.id to localStorage on change
   - Memoizes context value to prevent unnecessary re-renders
   - Storage keys: "editai_current_profile_id", "editai_profiles"

4. useProfile hook that throws if used outside ProfileProvider

Pattern from RESEARCH.md - use React Context + localStorage hybrid. Handle SSR by only accessing localStorage in useEffect (browser-only).

AVOID: Calling localStorage at module level (SSR error). AVOID: Not memoizing context value (causes re-renders).
  </action>
  <verify>
File exists at frontend/src/contexts/profile-context.tsx and exports ProfileProvider and useProfile. TypeScript compilation passes: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
ProfileProvider context created with localStorage persistence, auto-fetch on mount, and profile auto-selection logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Modify api.ts to auto-inject X-Profile-Id header</name>
  <files>frontend/src/lib/api.ts</files>
  <action>
Modify `frontend/src/lib/api.ts` to automatically inject X-Profile-Id header from localStorage:

1. In the `apiFetch` function, add profile ID injection:
   - Read profile ID from localStorage: `localStorage.getItem("editai_current_profile_id")`
   - Guard for SSR: Only access localStorage if `typeof window !== "undefined"`
   - Inject as header if present: `{ "X-Profile-Id": profileId }`
   - Allow custom headers to override (spread customHeaders after profile header)

2. Keep all existing functionality intact (apiGet, apiPost, apiPatch, apiPut, apiDelete)

The backend already handles missing X-Profile-Id gracefully (auto-selects default), so this is a convenience that ensures all API calls are profile-scoped once a profile is selected.

AVOID: Breaking existing API functions. AVOID: Injecting header when profileId is null/undefined (would send "null" string).
  </action>
  <verify>
TypeScript compilation passes: `cd frontend && npx tsc --noEmit`. Manual inspection shows X-Profile-Id injection in apiFetch function.
  </verify>
  <done>
api.ts automatically injects X-Profile-Id header for all API calls when a profile is selected.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd frontend && npx tsc --noEmit`
2. ProfileProvider exports are correct: grep for "export.*ProfileProvider" and "export.*useProfile"
3. api.ts contains X-Profile-Id injection: grep for "X-Profile-Id"
4. localStorage keys match between context and api.ts: both use "editai_current_profile_id"
</verification>

<success_criteria>
- frontend/src/contexts/profile-context.tsx exists with ProfileProvider and useProfile exports
- frontend/src/lib/api.ts automatically injects X-Profile-Id header
- TypeScript compilation passes without errors
- No SSR-incompatible localStorage access at module level
</success_criteria>

<output>
After completion, create `.planning/phases/03-frontend-profile-ui/03-01-SUMMARY.md`
</output>
