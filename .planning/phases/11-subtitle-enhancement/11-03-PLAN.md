---
phase: 11-subtitle-enhancement
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - frontend/src/types/video-processing.ts
  - frontend/src/hooks/use-subtitle-settings.ts
  - frontend/src/components/subtitle-enhancement-controls.tsx
  - frontend/src/app/library/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can enable shadow effects on subtitles with configurable depth 0-4px via checkbox + slider"
    - "User can enable glow/outline effects on subtitle text with configurable blur 0-10 via checkbox + slider"
    - "User can enable adaptive font sizing toggle (auto-reduces font for long text)"
    - "Subtitle enhancement controls visible in library render dialog below existing subtitle settings"
    - "Shadow/glow/adaptive settings sent to backend render endpoint as form data"
    - "Settings persist in localStorage across sessions via existing useSubtitleSettings hook"
  artifacts:
    - path: "frontend/src/types/video-processing.ts"
      provides: "Extended SubtitleSettings with shadow/glow/adaptive fields"
      contains: "shadowDepth"
    - path: "frontend/src/components/subtitle-enhancement-controls.tsx"
      provides: "SubtitleEnhancementControls component with checkbox + slider pattern"
      exports: ["SubtitleEnhancementControls"]
    - path: "frontend/src/app/library/page.tsx"
      provides: "Render dialog with subtitle enhancement controls and formData submission"
      contains: "SubtitleEnhancementControls"
  key_links:
    - from: "frontend/src/app/library/page.tsx"
      to: "backend render endpoint"
      via: "formData.append for shadow_depth, enable_glow, glow_blur, adaptive_sizing"
      pattern: "formData.append.*shadow_depth"
    - from: "frontend/src/components/subtitle-enhancement-controls.tsx"
      to: "frontend/src/types/video-processing.ts"
      via: "SubtitleSettings import"
      pattern: "import.*SubtitleSettings"
---

<objective>
Create the frontend subtitle enhancement UI controls and wire them into the library page render dialog.

Purpose: Provides user-facing controls for all three subtitle enhancement features (SUB-01 shadow, SUB-02 glow, SUB-03 adaptive sizing). Follows Phase 9's checkbox-shows-sliders pattern. Sends settings to backend via form data.
Output: Extended SubtitleSettings type, SubtitleEnhancementControls component, updated library page with controls and form data submission. Visual verification via Playwright screenshot.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-subtitle-enhancement/11-RESEARCH.md
@frontend/src/types/video-processing.ts (extend SubtitleSettings interface)
@frontend/src/hooks/use-subtitle-settings.ts (merge with defaults pattern already handles new optional fields)
@frontend/src/components/video-enhancement-controls.tsx (Phase 9 pattern reference for checkbox + slider UI)
@frontend/src/app/library/page.tsx (integration target: render dialog around lines 2312-2320)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SubtitleSettings type, create SubtitleEnhancementControls component, and integrate into library page</name>
  <files>frontend/src/types/video-processing.ts, frontend/src/components/subtitle-enhancement-controls.tsx, frontend/src/app/library/page.tsx</files>
  <action>
1. **Extend SubtitleSettings interface** in `frontend/src/types/video-processing.ts`:
   Add these optional fields to the existing `SubtitleSettings` interface (after `marginV?: number;`):
   ```typescript
   // Shadow effects (Phase 11 - SUB-01)
   shadowDepth?: number;        // 0-4, default 0 (disabled)
   shadowColor?: string;         // Hex color, default "#000000"
   borderStyle?: number;         // 1=outline+shadow, 3=box, default 1

   // Glow effects (Phase 11 - SUB-02)
   enableGlow?: boolean;         // Default false
   glowBlur?: number;            // 0-10, default 0 (disabled)

   // Adaptive sizing (Phase 11 - SUB-03)
   adaptiveSizing?: boolean;     // Default false
   ```

   Add new defaults to `DEFAULT_SUBTITLE_SETTINGS`:
   ```typescript
   // Phase 11 defaults
   shadowDepth: 0,
   shadowColor: "#000000",
   borderStyle: 1,
   enableGlow: false,
   glowBlur: 0,
   adaptiveSizing: false,
   ```

2. **Create SubtitleEnhancementControls component** at `frontend/src/components/subtitle-enhancement-controls.tsx`:
   Follow the EXACT pattern from `video-enhancement-controls.tsx` (Phase 9):
   - "use client" directive
   - Import Slider, Checkbox, Label from @/components/ui/*
   - Import SubtitleSettings from @/types/video-processing

   Props interface:
   ```typescript
   interface SubtitleEnhancementControlsProps {
     settings: SubtitleSettings
     onSettingsChange: (updates: Partial<SubtitleSettings>) => void
     disabled?: boolean
   }
   ```

   Three sections (same checkbox-shows-sliders pattern as Phase 9):

   **Shadow Effect (SUB-01):**
   - Checkbox "Shadow Effect" — checked when `(settings.shadowDepth ?? 0) > 0`, on check set shadowDepth to 2, on uncheck set to 0
   - When checked, show slider: label "Depth: {value}px", min=1, max=4, step=1
   - Helper text: "Higher values = deeper shadow (improves readability on bright backgrounds)"

   **Glow/Outline Effect (SUB-02):**
   - Checkbox "Glow/Outline Effect" — checked when `settings.enableGlow ?? false`, on check set enableGlow=true + glowBlur=3, on uncheck set enableGlow=false + glowBlur=0
   - When checked, show slider: label "Intensity: {value}", min=1, max=10, step=1
   - Helper text: "Higher values = wider glow (best for busy/dark backgrounds)"

   **Adaptive Font Sizing (SUB-03):**
   - Checkbox "Auto-size Text" — checked when `settings.adaptiveSizing ?? false`
   - When checked, show info text (no slider needed): "Automatically reduces font size for long text (40+ characters) to prevent overflow. Base size: {settings.fontSize}px"

3. **Integrate into library page** (`frontend/src/app/library/page.tsx`):

   a. Add import (near the VideoEnhancementControls import ~line 93):
   ```typescript
   import { SubtitleEnhancementControls } from "@/components/subtitle-enhancement-controls"
   ```

   b. Add SubtitleEnhancementControls in the render dialog, AFTER the existing subtitle settings Tabs and BEFORE the "Video Enhancement (optional)" section (~line 2311-2312). Add:
   ```tsx
   {/* Subtitle Enhancement (Phase 11) */}
   <div className="mb-4">
     <Label className="text-sm mb-2 block">Subtitle Enhancement (optional):</Label>
     <SubtitleEnhancementControls
       settings={subtitleSettings}
       onSettingsChange={(updates) => {
         setSubtitleSettings(prev => ({ ...prev, ...updates }));
       }}
       disabled={rendering}
     />
   </div>
   ```

   Note: `subtitleSettings` and `setSubtitleSettings` should already exist in the library page (used by the subtitle settings tabs). Find the correct state variable names by searching for `useSubtitleSettings` usage.

   c. Add form data submission for subtitle enhancement params in the render function (after the existing Phase 9 filter formData.appends ~line 861):
   ```typescript
   // Subtitle enhancement (Phase 11)
   formData.append("shadow_depth", (subtitleSettings.shadowDepth ?? 0).toString());
   formData.append("enable_glow", (subtitleSettings.enableGlow ?? false).toString());
   formData.append("glow_blur", (subtitleSettings.glowBlur ?? 0).toString());
   formData.append("adaptive_sizing", (subtitleSettings.adaptiveSizing ?? false).toString());
   ```

   IMPORTANT: Find the actual state variable name for subtitle settings by searching the file. It may be from `useSubtitleSettings("library")` hook or a local useState. Match the existing pattern exactly.
  </action>
  <verify>
Build check: `cd "/mnt/c/OBSID SRL/n8n/edit_factory/frontend" && npx next build 2>&1 | tail -20` (or `npx tsc --noEmit` for faster type check)
Grep for integration: `grep -n "SubtitleEnhancementControls" frontend/src/app/library/page.tsx`
Grep for form data: `grep -n "shadow_depth\|enable_glow\|glow_blur\|adaptive_sizing" frontend/src/app/library/page.tsx`
  </verify>
  <done>
  - SubtitleSettings type extended with shadowDepth, shadowColor, borderStyle, enableGlow, glowBlur, adaptiveSizing
  - DEFAULT_SUBTITLE_SETTINGS updated with Phase 11 defaults
  - SubtitleEnhancementControls component created with checkbox + slider pattern
  - Component integrated into library render dialog between subtitle settings and video enhancement
  - Form data includes all 4 subtitle enhancement params for backend
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Subtitle enhancement controls in library page render dialog with shadow, glow, and adaptive sizing options</what-built>
  <how-to-verify>
  Take a Playwright screenshot of the library page render dialog showing the subtitle enhancement controls:

  1. Create and run a Playwright test that:
     - Navigates to /library
     - Waits for page load
     - Clicks on a clip to open the render dialog (or navigates to a state showing the export panel)
     - Takes a screenshot showing the subtitle enhancement controls (shadow checkbox/slider, glow checkbox/slider, adaptive sizing checkbox)
  2. Show the screenshot to verify:
     - Shadow Effect checkbox with depth slider (1-4) appears when checked
     - Glow/Outline Effect checkbox with intensity slider (1-10) appears when checked
     - Auto-size Text checkbox with info text appears when checked
     - Controls positioned between subtitle settings tabs and video enhancement section
     - Consistent styling with existing Phase 9 video enhancement controls
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` in frontend/ — no type errors
2. `grep "shadowDepth" frontend/src/types/video-processing.ts` — field exists in interface and defaults
3. `grep "SubtitleEnhancementControls" frontend/src/app/library/page.tsx` — component imported and rendered
4. `grep "shadow_depth" frontend/src/app/library/page.tsx` — formData.append present
5. Playwright screenshot confirms visual layout
</verification>

<success_criteria>
- User can see shadow/glow/adaptive controls in library render dialog
- Checkbox + slider pattern matches Phase 9 video enhancement controls
- Settings sent to backend as form data on render
- TypeScript build passes with no errors
- Settings persist via localStorage (useSubtitleSettings hook merges defaults)
</success_criteria>

<output>
After completion, create `.planning/phases/11-subtitle-enhancement/11-03-SUMMARY.md`
</output>
