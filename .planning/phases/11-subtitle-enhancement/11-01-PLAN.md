---
phase: 11-subtitle-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/subtitle_styler.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "SubtitleStyleConfig.to_force_style_string() produces valid ASS force_style with Shadow, Outline, BackColour, BorderStyle parameters"
    - "calculate_adaptive_font_size() returns reduced font size for text exceeding 40 characters"
    - "build_subtitle_filter() produces complete FFmpeg subtitles filter string with escaped path and force_style"
    - "SubtitleStyleConfig.from_dict() converts frontend subtitle_settings dict including shadow/glow fields"
  artifacts:
    - path: "app/services/subtitle_styler.py"
      provides: "SubtitleStyleConfig dataclass, calculate_adaptive_font_size(), build_subtitle_filter()"
      exports: ["SubtitleStyleConfig", "calculate_adaptive_font_size", "build_subtitle_filter"]
    - path: "requirements.txt"
      provides: "srt library dependency"
      contains: "srt"
  key_links:
    - from: "app/services/subtitle_styler.py"
      to: "srt library"
      via: "import srt; srt.parse()"
      pattern: "import srt"
---

<objective>
Create the subtitle styling service that builds FFmpeg ASS force_style strings with shadow depth, glow effects, and adaptive font sizing.

Purpose: Provides the backend foundation for all three subtitle enhancement requirements (SUB-01 shadow, SUB-02 glow, SUB-03 adaptive sizing). Follows Phase 9 pattern of dedicated service with stdlib dataclass.
Output: `app/services/subtitle_styler.py` with SubtitleStyleConfig, calculate_adaptive_font_size(), build_subtitle_filter(). Updated `requirements.txt` with `srt` library.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-subtitle-enhancement/11-RESEARCH.md
@app/services/video_filters.py (Phase 9 pattern reference for dataclass service design)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subtitle_styler.py service with SubtitleStyleConfig, adaptive sizing, and filter builder</name>
  <files>app/services/subtitle_styler.py, requirements.txt</files>
  <action>
1. Add `srt` to `requirements.txt` (alphabetical placement, just the package name `srt`). Then run `pip install srt` in the venv.

2. Create `app/services/subtitle_styler.py` with the following components. Use the research code examples as the implementation reference (11-RESEARCH.md "Complete Subtitle Style Builder Service" section):

**SubtitleStyleConfig dataclass** (stdlib dataclass, NOT Pydantic — per v3 decision 09-01):
- Basic text properties: font_size (48), font_family ("Montserrat"), primary_color ("&H00FFFFFF"), outline_color ("&H00000000"), outline_width (3), bold (1), alignment (2), margin_v (50)
- Shadow effects (SUB-01): shadow_depth (0, range 0-4), shadow_color ("&H80000000")
- Glow effects (SUB-02): enable_glow (False), glow_blur (0, range 0-10)
- Style controls: border_style (1)
- Video resolution: video_width (1080), video_height (1920)

Methods:
- `to_force_style_string() -> str`: Build comma-separated ASS force_style. Always include PlayResX/Y, FontName, FontSize, PrimaryColour, Bold, Alignment, MarginV. If glow enabled and glow_blur > 0: increase outline width by glow_blur, use semi-transparent OutlineColour (&H80 alpha prefix). If shadow_depth > 0: add Shadow={depth}, BackColour={shadow_color}, BorderStyle. Else Shadow=0.
- `from_dict(settings: dict, video_width: int, video_height: int) -> SubtitleStyleConfig` (static): Convert frontend subtitle_settings dict. Include hex_to_ass() helper for color conversion (hex -> &H00BBGGRR). Handle font_family CSS variable prefix stripping. Convert positionY to alignment (<=20 -> top-center alignment 8, else bottom-center alignment 2) and margin_v. Add extra margin for shadow_depth > 2 (shadow_depth * 2). Clamp margin_v minimum at 50. Map new fields: shadowDepth, shadowColor, enableGlow, glowBlur, borderStyle.

**calculate_adaptive_font_size(srt_path, base_font_size=48, min_font_size=32, max_chars_threshold=40, max_chars_limit=60) -> Tuple[int, int]**:
- Read SRT file with UTF-8 first, fallback to latin-1 on UnicodeDecodeError
- Parse with `srt.parse()`, find longest line across all subtitles (strip HTML tags like <i>, <b>, <u>)
- Apply linear interpolation: fontSize = maxSize - ((maxSize - minSize) * (textLength - minLength) / (maxLength - minLength))
- Return (calculated_font_size, max_line_length) tuple
- On any exception, log error and return (base_font_size, 0)

**build_subtitle_filter(srt_path, subtitle_settings, video_width, video_height) -> str**:
- Copy settings dict to avoid mutation
- If adaptiveSizing enabled: call calculate_adaptive_font_size(), override fontSize in copied settings
- Build SubtitleStyleConfig via from_dict()
- Get force_style string
- Escape srt_path for FFmpeg (backslash -> forward slash, single quotes, colons, brackets)
- Return: `subtitles='{escaped_path}':force_style='{force_style}'`

Use `logging.getLogger(__name__)` for all log messages. Follow video_filters.py as the service pattern reference.
  </action>
  <verify>
Run: `cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "from app.services.subtitle_styler import SubtitleStyleConfig, calculate_adaptive_font_size, build_subtitle_filter; c = SubtitleStyleConfig(shadow_depth=2, enable_glow=True, glow_blur=3); fs = c.to_force_style_string(); print(fs); assert 'Shadow=2' in fs; assert 'PlayResX=1080' in fs; print('OK')"`

Verify srt is importable: `python -c "import srt; print('srt imported OK')"`
  </verify>
  <done>
  - SubtitleStyleConfig produces force_style string with Shadow, Outline, BackColour, BorderStyle, PlayResX/PlayResY parameters
  - calculate_adaptive_font_size returns reduced size for long text and base size for short text
  - build_subtitle_filter produces complete FFmpeg subtitles filter with escaped path and force_style
  - srt library installed and importable
  - from_dict() handles all new fields (shadowDepth, shadowColor, enableGlow, glowBlur, adaptiveSizing)
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.services.subtitle_styler import SubtitleStyleConfig, calculate_adaptive_font_size, build_subtitle_filter; print('All imports OK')"` — passes
2. `python -c "from app.services.subtitle_styler import SubtitleStyleConfig; c = SubtitleStyleConfig(shadow_depth=3); s = c.to_force_style_string(); assert 'Shadow=3' in s; print('Shadow OK')"` — passes
3. `python -c "from app.services.subtitle_styler import SubtitleStyleConfig; c = SubtitleStyleConfig(enable_glow=True, glow_blur=5, outline_width=3); s = c.to_force_style_string(); assert 'Outline=8' in s; print('Glow OK')"` — passes (outline_width 3 + glow_blur 5 = 8)
4. `python -c "import srt; print('srt library OK')"` — passes
5. `grep -q 'srt' requirements.txt` — passes
</verification>

<success_criteria>
- app/services/subtitle_styler.py exists with SubtitleStyleConfig dataclass, calculate_adaptive_font_size(), build_subtitle_filter()
- SubtitleStyleConfig.to_force_style_string() generates valid ASS format with shadow/glow support
- srt library added to requirements.txt and importable
- All verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-subtitle-enhancement/11-01-SUMMARY.md`
</output>
