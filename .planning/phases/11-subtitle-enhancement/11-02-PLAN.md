---
phase: 11-subtitle-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - app/api/library_routes.py
autonomous: true

must_haves:
  truths:
    - "Render endpoint accepts subtitle enhancement parameters (shadow_depth, enable_glow, glow_blur, adaptive_sizing) as Form fields"
    - "_render_with_preset() uses build_subtitle_filter() from subtitle_styler instead of inline ASS construction"
    - "Subtitle settings dict passed to build_subtitle_filter() includes shadow/glow/adaptive fields from Form params"
    - "Existing subtitle rendering behavior preserved when new parameters are at defaults (shadow=0, glow=false, adaptive=false)"
  artifacts:
    - path: "app/api/library_routes.py"
      provides: "Render endpoint with subtitle enhancement params, refactored _render_with_preset()"
      contains: "build_subtitle_filter"
  key_links:
    - from: "app/api/library_routes.py"
      to: "app/services/subtitle_styler.py"
      via: "from app.services.subtitle_styler import build_subtitle_filter"
      pattern: "build_subtitle_filter"
    - from: "render_final_clip endpoint"
      to: "_render_final_clip_task"
      via: "background_tasks.add_task with subtitle params"
      pattern: "shadow_depth|enable_glow|glow_blur|adaptive_sizing"
---

<objective>
Integrate the subtitle styling service into the render pipeline by refactoring _render_with_preset() and adding subtitle enhancement Form parameters to the render endpoint.

Purpose: Connects the subtitle_styler service (Plan 01) to the actual video rendering pipeline. Replaces inline ASS force_style construction with the dedicated service. Adds Form parameters so the frontend can pass shadow/glow/adaptive settings.
Output: Modified `app/api/library_routes.py` with new subtitle Form params in render endpoint, subtitle params threaded through _render_final_clip_task, and _render_with_preset() using build_subtitle_filter().
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-subtitle-enhancement/11-RESEARCH.md
@.planning/phases/11-subtitle-enhancement/11-01-SUMMARY.md
@app/api/library_routes.py (integration target — lines 1622-1690 render endpoint, 1700-1860 task function, 2360-2465 _render_with_preset)
@app/services/subtitle_styler.py (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subtitle enhancement Form params to render endpoint and thread through task function</name>
  <files>app/api/library_routes.py</files>
  <action>
1. **Add import** at top of library_routes.py (near the video_filters import on line ~23):
   ```python
   from app.services.subtitle_styler import build_subtitle_filter
   ```

2. **Add Form parameters** to `render_final_clip()` endpoint (after the existing Phase 9 filter params, before `profile: ProfileContext`):
   ```python
   # Subtitle enhancement (Phase 11)
   shadow_depth: int = Form(default=0),
   enable_glow: str = Form(default="false"),
   glow_blur: int = Form(default=0),
   adaptive_sizing: str = Form(default="false"),
   ```
   Note: enable_glow and adaptive_sizing are strings because HTML forms send strings (same pattern as enable_denoise).

3. **Parse boolean strings** (add after existing `enable_color_bool` line ~1649):
   ```python
   enable_glow_bool = enable_glow.lower() in ("true", "1", "yes", "on")
   adaptive_sizing_bool = adaptive_sizing.lower() in ("true", "1", "yes", "on")
   ```

4. **Thread subtitle params** through `background_tasks.add_task()` call to `_render_final_clip_task` (add after the Phase 9 filter params ~line 1688):
   ```python
   # Subtitle enhancement (Phase 11)
   shadow_depth=shadow_depth,
   enable_glow=enable_glow_bool,
   glow_blur=glow_blur,
   adaptive_sizing=adaptive_sizing_bool
   ```

5. **Add params to `_render_final_clip_task()` function signature** (after the Phase 9 params ~line 1713):
   ```python
   # Subtitle enhancement (Phase 11)
   shadow_depth: int = 0,
   enable_glow: bool = False,
   glow_blur: int = 0,
   adaptive_sizing: bool = False
   ```

6. **Inject subtitle enhancement settings into subtitle_settings dict** before the `_render_with_preset()` call (~line 1841). After the SRT file creation block (if content_data and srt_content), add:
   ```python
   # Inject Phase 11 subtitle enhancement settings into subtitle_settings dict
   if content_data and content_data.get("subtitle_settings"):
       content_data["subtitle_settings"]["shadowDepth"] = shadow_depth
       content_data["subtitle_settings"]["enableGlow"] = enable_glow
       content_data["subtitle_settings"]["glowBlur"] = glow_blur
       content_data["subtitle_settings"]["adaptiveSizing"] = adaptive_sizing
   ```
   This merges the per-render enhancement params into the existing subtitle_settings dict before it's passed to _render_with_preset().
  </action>
  <verify>
Check syntax: `cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "from app.api.library_routes import router; print('library_routes imports OK')"`
Grep for new params: `grep -n "shadow_depth\|enable_glow\|glow_blur\|adaptive_sizing" app/api/library_routes.py | head -20`
  </verify>
  <done>
  - render_final_clip endpoint accepts shadow_depth, enable_glow, glow_blur, adaptive_sizing Form params
  - Boolean string parsing for enable_glow and adaptive_sizing
  - Params threaded through _render_final_clip_task
  - Subtitle enhancement settings injected into subtitle_settings dict before render
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor _render_with_preset() subtitle section to use build_subtitle_filter()</name>
  <files>app/api/library_routes.py</files>
  <action>
Replace the inline subtitle construction in `_render_with_preset()` (lines ~2435-2461) with a call to `build_subtitle_filter()` from the subtitle_styler service.

**Replace this block** (the current subtitle section starting at `# Add subtitles if available`):
```python
    # Add subtitles if available
    if srt_path and srt_path.exists() and subtitle_settings:
        # Build ASS style from settings
        font_size = subtitle_settings.get("fontSize", 48)
        font_family = subtitle_settings.get("fontFamily", "Montserrat").split(",")[0].strip()
        text_color = _hex_to_ass_color(subtitle_settings.get("textColor", "#FFFFFF"))
        outline_color = _hex_to_ass_color(subtitle_settings.get("outlineColor", "#000000"))
        outline_width = subtitle_settings.get("outlineWidth", 3)
        position_y = subtitle_settings.get("positionY", 85)

        # Convert position Y to margin
        margin_v = int((100 - position_y) / 100 * preset['height'] * 0.5)

        # Escape path for Windows
        srt_escaped = str(srt_path).replace("\\", "/").replace(":", "\\:")

        subtitles_filter = (
            f"subtitles='{srt_escaped}':"
            f"force_style='FontName={font_family},"
            f"FontSize={font_size},"
            f"PrimaryColour={text_color},"
            f"OutlineColour={outline_color},"
            f"Outline={outline_width},"
            f"MarginV={margin_v},"
            f"Alignment=2'"
        )
        filters.append(subtitles_filter)
```

**With:**
```python
    # Add subtitles if available (Phase 11: uses subtitle_styler service for shadow/glow/adaptive)
    if srt_path and srt_path.exists() and subtitle_settings:
        subtitles_filter = build_subtitle_filter(
            srt_path=srt_path,
            subtitle_settings=subtitle_settings,
            video_width=preset.get('width', 1080),
            video_height=preset.get('height', 1920)
        )
        filters.append(subtitles_filter)
        logger.info(f"Added subtitle filter with enhancement settings")
```

This replaces ~20 lines of inline ASS construction with a single service call. The `build_subtitle_filter()` function handles:
- Shadow depth and color (SUB-01)
- Glow effects via increased outline + semi-transparent color (SUB-02)
- Adaptive font sizing via SRT parsing (SUB-03)
- Path escaping for Windows
- All existing font/color/position settings

The `_hex_to_ass_color()` helper function (lines ~2348-2358) can remain in the file since it may be used elsewhere; do NOT remove it.
  </action>
  <verify>
Check syntax: `cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "from app.api.library_routes import router; print('library_routes OK after refactor')"`
Verify build_subtitle_filter is used: `grep -n "build_subtitle_filter" app/api/library_routes.py`
Verify old inline code is gone: `grep -c "FontName={font_family}" app/api/library_routes.py` should return 0
  </verify>
  <done>
  - _render_with_preset() subtitle section replaced with build_subtitle_filter() call
  - Shadow, glow, and adaptive sizing settings flow from subtitle_settings dict through to ASS force_style
  - Existing subtitle behavior preserved when enhancement params at defaults
  - Path escaping handled by subtitle_styler service
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.api.library_routes import router; print('OK')"` — imports successfully
2. `grep -c "build_subtitle_filter" app/api/library_routes.py` — returns at least 2 (import + usage)
3. `grep -c "shadow_depth" app/api/library_routes.py` — returns 4+ (Form param, boolean parse, thread, task param)
4. `grep -c "FontName={font_family}" app/api/library_routes.py` — returns 0 (old inline code removed)
5. Backend server starts: `timeout 5 python -c "import uvicorn; from app.main import app; print('App OK')"` or similar
</verification>

<success_criteria>
- Render endpoint accepts all 4 new subtitle enhancement params
- _render_with_preset() uses build_subtitle_filter() instead of inline ASS construction
- Subtitle settings dict includes shadow/glow/adaptive fields when passed to render
- No regressions: existing render behavior preserved when new params at defaults
</success_criteria>

<output>
After completion, create `.planning/phases/11-subtitle-enhancement/11-02-SUMMARY.md`
</output>
