---
phase: 04-tts-provider-selection
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/tts_routes.py
  - frontend/src/components/navbar.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Settings page is accessible from navbar"
    - "Voices endpoint returns voice_id field matching frontend interface"
    - "TTS generate endpoint calls correct service methods"
    - "Voice cloning endpoint accepts correct form field and returns correct response"
  artifacts:
    - path: "frontend/src/components/navbar.tsx"
      provides: "Navigation link to /settings"
      contains: "Settings"
    - path: "app/api/tts_routes.py"
      provides: "Fixed TTS API endpoints"
      exports: ["list_voices", "generate_tts", "clone_voice"]
  key_links:
    - from: "frontend/src/components/navbar.tsx"
      to: "/settings"
      via: "navLinks array"
      pattern: "href.*settings"
    - from: "frontend/src/app/settings/page.tsx"
      to: "app/api/tts_routes.py"
      via: "apiGet /tts/voices"
      pattern: "voice_id"
---

<objective>
Fix 6 API bugs blocking Phase 4 goal achievement

Purpose: Phase 4 TTS provider selection implemented but verification found 6 bugs preventing actual use. All bugs are in API contract mismatches between frontend and backend.

Output: Working TTS endpoints that match frontend expectations, accessible Settings page
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tts-provider-selection/04-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Settings link to navbar</name>
  <files>frontend/src/components/navbar.tsx</files>
  <action>
Add Settings to the navLinks array at line 8-13.

Current navLinks:
```typescript
const navLinks = [
  { label: "Librarie", href: "/librarie" },
  { label: "Export", href: "/library" },
  { label: "Segments", href: "/segments" },
  { label: "Usage", href: "/usage" },
];
```

Add Settings after Usage:
```typescript
const navLinks = [
  { label: "Librarie", href: "/librarie" },
  { label: "Export", href: "/library" },
  { label: "Segments", href: "/segments" },
  { label: "Usage", href: "/usage" },
  { label: "Settings", href: "/settings" },
];
```
  </action>
  <verify>grep -n "Settings" frontend/src/components/navbar.tsx shows Settings in navLinks array</verify>
  <done>Settings link appears in navbar navigation</done>
</task>

<task type="auto">
  <name>Task 2: Fix voices endpoint field name</name>
  <files>app/api/tts_routes.py</files>
  <action>
Fix the /tts/voices endpoint at line 127-137 to return "voice_id" instead of "id".

Current code (line 129-136):
```python
return {
    "provider": provider,
    "voices": [
        {
            "id": voice.id,  # BUG: should be "voice_id"
            "name": voice.name,
            ...
        }
        for voice in voices
    ]
}
```

Change to:
```python
return {
    "provider": provider,
    "voices": [
        {
            "voice_id": voice.id,  # FIXED: matches frontend Voice interface
            "name": voice.name,
            "language": voice.language,
            "gender": voice.gender
        }
        for voice in voices
    ]
}
```

This matches frontend/src/app/settings/page.tsx Voice interface:
```typescript
interface Voice {
  voice_id: string
  name: string
  language?: string
}
```
  </action>
  <verify>grep -A5 '"voice_id"' app/api/tts_routes.py shows correct field in response</verify>
  <done>Voices endpoint returns voice_id field matching frontend expectation</done>
</task>

<task type="auto">
  <name>Task 3: Fix TTS generate method call and result attribute</name>
  <files>app/api/tts_routes.py</files>
  <action>
Fix two bugs in _generate_tts_background function (lines 148-229):

BUG 1 - Line 185: Wrong method name
Current: `result = await tts_service.generate(...)`
Fix: `result = await tts_service.generate_audio(...)`

The TTSService base class (app/services/tts/base.py line 77-97) defines:
```python
@abstractmethod
async def generate_audio(
    self,
    text: str,
    voice_id: str,
    output_path: Path,
    **kwargs
) -> TTSResult:
```

Note: generate_audio requires output_path parameter. Add this:
```python
# Generate output path
output_path = Path(tts_service.output_dir) / f"tts_{job_id}.mp3"

# Generate audio
result = await tts_service.generate_audio(
    text=text,
    voice_id=voice_id,
    output_path=output_path,
    language=language
)
```

BUG 2 - Lines 202 and 217: Wrong attribute name
Current: `result.duration`
Fix: `result.duration_seconds`

The TTSResult dataclass (app/services/tts/base.py line 25-32) defines:
```python
@dataclass
class TTSResult:
    audio_path: Path
    duration_seconds: float  # NOT "duration"
    provider: str
    voice_id: str
    cost: float
```

Change both occurrences:
- Line 202: `"duration": result.duration` -> `"duration": result.duration_seconds`
- Line 217: `"duration": result.duration` -> `"duration": result.duration_seconds`
  </action>
  <verify>grep -n "generate_audio\|duration_seconds" app/api/tts_routes.py shows both fixes applied</verify>
  <done>TTS generate endpoint calls correct method and uses correct attribute</done>
</task>

<task type="auto">
  <name>Task 4: Fix clone-voice endpoint</name>
  <files>app/api/tts_routes.py</files>
  <action>
Fix three bugs in clone_voice endpoint (lines 297-407):

BUG 1 - Line 300: Wrong form field name
Current: `audio_sample: UploadFile = File(...)`
Fix: `audio_file: UploadFile = File(...)`

The frontend (frontend/src/components/tts/voice-cloning-upload.tsx line 70) sends:
```typescript
formData.append("audio_file", selectedFile)
```

Also update all references to audio_sample in the function:
- Line 327: `audio_sample.content_type` -> `audio_file.content_type`
- Line 330: `audio_sample.content_type` -> `audio_file.content_type`
- Line 339: `audio_sample.filename` -> `audio_file.filename`
- Line 343: `await audio_sample.read()` -> `await audio_file.read()`

BUG 2 - Line 372: Return type mismatch
Current:
```python
voice_id = await coqui_service.clone_voice(
    audio_path=temp_path,
    voice_name=voice_name
)
```

The clone_voice method returns TTSVoice object, not a string.
Fix:
```python
cloned_voice = await coqui_service.clone_voice(
    audio_path=temp_path,
    voice_name=voice_name
)
```

BUG 3 - Lines 380, 386-390: Missing voice_name and incorrect response
Current:
```python
logger.info(f"... Cloned voice '{voice_name}' with ID: {voice_id}")
...
return {
    "voice_id": voice_id,
    "duration": duration,
    "warnings": warnings
}
```

Fix - use cloned_voice object attributes:
```python
logger.info(f"... Cloned voice '{cloned_voice.name}' with ID: {cloned_voice.id}")
...
return {
    "voice_id": cloned_voice.id,
    "voice_name": cloned_voice.name,
    "duration": duration,
    "warnings": warnings
}
```

The frontend expects voice_name in response (line 95 voice-cloning-upload.tsx):
```typescript
setSuccess(`Voice "${data.voice_name}" cloned successfully!`)
```
  </action>
  <verify>grep -n "audio_file\|cloned_voice\|voice_name" app/api/tts_routes.py shows all fixes applied</verify>
  <done>Clone-voice endpoint accepts correct form field and returns complete response</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
All 6 bugs fixed:
1. Settings link added to navbar
2. Voices endpoint returns voice_id field
3. TTS generate calls generate_audio() method
4. TTS generate uses duration_seconds attribute
5. Clone-voice accepts audio_file form field
6. Clone-voice returns voice_name in response
  </what-built>
  <how-to-verify>
1. Start the development server:
   - Backend: `python run.py` (from project root)
   - Frontend: `cd frontend && npm run dev`

2. Open http://localhost:3000 in browser

3. Verify Settings link appears in navbar (after Usage)

4. Click Settings link - should navigate to /settings page

5. On Settings page:
   - Select "Edge TTS" provider (free, no API key needed)
   - Verify voices dropdown populates with voice options
   - Select any voice
   - Click "Save Settings" - should show success alert

6. If Coqui XTTS is available (PyTorch installed):
   - Select "Coqui XTTS" provider
   - Upload a 6+ second audio file
   - Enter a voice name
   - Click "Clone Voice"
   - Should show success message with voice name
  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After Task 4, run these checks before human verification:

```bash
# Verify Settings link in navbar
grep -n "Settings" frontend/src/components/navbar.tsx

# Verify voice_id field in voices endpoint
grep -A10 "for voice in voices" app/api/tts_routes.py | head -15

# Verify generate_audio method call
grep -n "generate_audio" app/api/tts_routes.py

# Verify duration_seconds attribute
grep -n "duration_seconds" app/api/tts_routes.py

# Verify audio_file form field
grep -n "audio_file.*File" app/api/tts_routes.py

# Verify voice_name in clone response
grep -n "voice_name" app/api/tts_routes.py
```

All checks should show the fixed code.
</verification>

<success_criteria>
- Settings page accessible from navbar (link visible, navigates correctly)
- Voices endpoint returns {voice_id, name, language, gender} format
- TTS generation creates audio files without AttributeError
- Voice cloning accepts uploads and returns {voice_id, voice_name, duration, warnings}
- Human verification confirms end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/04-tts-provider-selection/04-08-SUMMARY.md`
</output>
