---
phase: 04-tts-provider-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/006_add_tts_settings_to_profiles.sql
  - app/services/tts/__init__.py
  - app/services/tts/base.py
  - app/services/tts/factory.py
autonomous: true

must_haves:
  truths:
    - "TTS service abstraction allows pluggable provider implementations"
    - "Profile can store TTS settings as structured JSONB"
    - "Factory function returns correct provider based on string identifier"
  artifacts:
    - path: "supabase/migrations/006_add_tts_settings_to_profiles.sql"
      provides: "Database schema for TTS settings storage"
      contains: "tts_settings JSONB"
    - path: "app/services/tts/base.py"
      provides: "TTSService abstract base class"
      exports: ["TTSService", "TTSVoice", "TTSResult"]
    - path: "app/services/tts/factory.py"
      provides: "TTS provider factory function"
      exports: ["get_tts_service"]
  key_links:
    - from: "app/services/tts/factory.py"
      to: "app/services/tts/base.py"
      via: "imports TTSService base class"
      pattern: "from.*base.*import.*TTSService"
---

<objective>
Create TTS service abstraction layer and database schema for multi-provider support.

Purpose: Establish foundation for pluggable TTS providers with unified interface. This enables Phase 4's multi-provider TTS selection (ElevenLabs, Edge, Coqui, Kokoro) with consistent API.

Output: TTSService abstract base class, factory function, and database migration for profile TTS settings.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-tts-provider-selection/04-RESEARCH.md

# Existing files to understand patterns
@app/services/elevenlabs_tts.py
@app/services/edge_tts_service.py
@supabase/migrations/002_create_profiles_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for TTS settings</name>
  <files>supabase/migrations/006_add_tts_settings_to_profiles.sql</files>
  <action>
Create SQL migration to add TTS settings columns to profiles table:

1. Add `tts_settings` JSONB column with default structure:
```json
{
  "provider": "edge",
  "elevenlabs": {"voice_id": null, "model": "eleven_multilingual_v2", "stability": 0.57, "similarity_boost": 0.75},
  "edge": {"voice": "en-US-GuyNeural", "rate": "+0%", "pitch": "+0Hz"},
  "coqui": {"model": "xtts_v2", "use_gpu": true},
  "kokoro": {"voice": "af"}
}
```

2. Add `cloned_voices` JSONB array column (default empty array) for storing voice cloning metadata.

3. Add index on `tts_settings->>'provider'` for fast lookups.

4. Use IF NOT EXISTS for idempotent migration.

Include header comment with migration number, purpose, and execution instructions (Supabase Dashboard SQL Editor).
  </action>
  <verify>
File exists at supabase/migrations/006_add_tts_settings_to_profiles.sql with:
- ALTER TABLE profiles ADD COLUMN tts_settings JSONB
- ALTER TABLE profiles ADD COLUMN cloned_voices JSONB
- CREATE INDEX for provider lookup
  </verify>
  <done>Migration file ready for manual application via Supabase Dashboard SQL Editor.</done>
</task>

<task type="auto">
  <name>Task 2: Create TTS service abstraction layer</name>
  <files>
    app/services/tts/__init__.py
    app/services/tts/base.py
    app/services/tts/factory.py
  </files>
  <action>
Create TTS service module with abstract base class and factory pattern:

**base.py:**
1. Create `TTSVoice` dataclass with fields: id, name, language, gender, provider, requires_cloning, cost_per_1k_chars
2. Create `TTSResult` dataclass with fields: audio_path, duration_seconds, provider, voice_id, cost
3. Create `TTSService` abstract base class with:
   - Constructor accepting output_dir (Path)
   - Abstract property `provider_name` -> str
   - Abstract property `cost_per_1k_chars` -> float
   - Abstract async method `list_voices(language: Optional[str]) -> List[TTSVoice]`
   - Abstract async method `generate_audio(text, voice_id, output_path, **kwargs) -> TTSResult`
   - Abstract async method `supports_voice_cloning() -> bool`
   - Default async method `clone_voice(sample_audio_path, voice_name)` that raises NotImplementedError

Use from abc import ABC, abstractmethod. Type hints from typing and pathlib.

**factory.py:**
1. Create `get_tts_service(provider: str, profile_id: str, voice_id: Optional[str] = None) -> TTSService`
2. Factory returns appropriate service based on provider string:
   - "elevenlabs" -> ElevenLabsTTSService (import will be added in 04-02)
   - "edge" -> EdgeTTSService (import will be added in 04-02)
   - "coqui" -> CoquiTTSService (import will be added in 04-03)
   - "kokoro" -> KokoroTTSService (import will be added in 04-04)
3. For now, use conditional imports with try/except and raise NotImplementedError if provider not yet implemented
4. Profile-scoped output directory: settings.output_dir / "tts" / profile_id / provider

**__init__.py:**
Export TTSService, TTSVoice, TTSResult, get_tts_service for clean imports.
  </action>
  <verify>
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "from app.services.tts import TTSService, TTSVoice, TTSResult, get_tts_service; print('Imports OK')"
```
Should print "Imports OK" without errors.
  </verify>
  <done>
TTS service module exists with abstract base class and factory function. Provider implementations to be added in subsequent plans.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists with correct SQL syntax
2. TTS module imports without errors
3. TTSService is abstract (cannot be instantiated directly)
4. Factory function exists and raises NotImplementedError for unimplemented providers
</verification>

<success_criteria>
- Migration file ready for Supabase Dashboard application
- `from app.services.tts import TTSService, get_tts_service` works
- TTSService cannot be instantiated (abstract)
- get_tts_service("unknown", "test") raises ValueError
</success_criteria>

<output>
After completion, create `.planning/phases/04-tts-provider-selection/04-01-SUMMARY.md`
</output>
