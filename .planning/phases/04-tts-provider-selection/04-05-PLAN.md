---
phase: 04-tts-provider-selection
plan: 05
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - app/api/tts_routes.py
  - app/main.py
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/tts/providers returns list with cost info"
    - "GET /api/v1/tts/voices returns provider-specific voices"
    - "POST /api/v1/tts/generate creates background job and returns job_id"
    - "POST /api/v1/tts/clone-voice validates audio and creates cloned voice"
  artifacts:
    - path: "app/api/tts_routes.py"
      provides: "TTS API endpoints"
      exports: ["router"]
    - path: "app/main.py"
      provides: "Router mounting"
      contains: "tts_routes"
  key_links:
    - from: "app/api/tts_routes.py"
      to: "app/services/tts/factory.py"
      via: "imports get_tts_service"
      pattern: "from app.services.tts import get_tts_service"
    - from: "app/main.py"
      to: "app/api/tts_routes.py"
      via: "mounts router"
      pattern: "include_router.*tts_routes"
---

<objective>
Create TTS API routes for provider listing, voice listing, generation, and voice cloning.

Purpose: Expose TTS service layer via REST API. Enables frontend to select providers, list voices, generate audio, and clone voices.

Output: /api/v1/tts/* endpoints with background job pattern for generation.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-tts-provider-selection/04-RESEARCH.md

# Required context
@app/services/tts/base.py
@app/services/tts/factory.py
@app/api/routes.py
@app/api/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TTS API routes</name>
  <files>app/api/tts_routes.py</files>
  <action>
Create tts_routes.py with TTS endpoints following existing route patterns:

1. Imports:
   - FastAPI: APIRouter, UploadFile, File, Form, HTTPException, BackgroundTasks, Depends
   - ProfileContext, get_profile_context from app.api.auth
   - get_tts_service from app.services.tts
   - get_job_storage from app.services.job_storage
   - get_settings from app.config
   - Standard library: uuid, logging, Path

2. Router setup:
```python
router = APIRouter(prefix="/tts", tags=["tts"])
logger = logging.getLogger(__name__)
```

3. Define provider metadata constant with availability checks:
```python
def _get_providers():
    settings = get_settings()
    return [
        {"id": "edge", "name": "Edge TTS", "description": "Microsoft Edge voices, free", "cost_per_1k_chars": 0.0, "available": True, "supports_voice_cloning": False},
        {"id": "elevenlabs", "name": "ElevenLabs", "description": "Premium quality voices", "cost_per_1k_chars": 0.22, "available": bool(settings.elevenlabs_api_key), "supports_voice_cloning": False},
        {"id": "coqui", "name": "Coqui XTTS", "description": "Voice cloning, 17 languages", "cost_per_1k_chars": 0.0, "available": True, "supports_voice_cloning": True},
        {"id": "kokoro", "name": "Kokoro TTS", "description": "Fast lightweight TTS", "cost_per_1k_chars": 0.0, "available": _check_kokoro_available(), "supports_voice_cloning": False},
    ]
```

4. Endpoints:

**GET /providers** - List TTS providers with cost info
- No auth required (public info)
- Return {"providers": [provider list]}

**GET /voices** - List voices for provider
- Query params: provider (required), language (optional)
- Requires profile context
- Call tts_service.list_voices()
- Return {"provider": str, "voices": [voice list]}

**POST /generate** - Generate TTS audio (background job)
- Form params: text, provider, voice_id, language (default "en")
- Requires profile context
- Create job via job_storage.create_job()
- Add background task _generate_tts_background()
- Return {"job_id": str, "status": "processing", "estimated_time_seconds": float}

**POST /clone-voice** - Clone voice from audio sample
- Form params: voice_name
- File: audio_sample (UploadFile)
- Requires profile context
- Validate MIME type (audio/mpeg, audio/wav, audio/x-wav, audio/ogg, audio/mp4)
- Validate file size (max 10MB)
- Save to temp, validate duration >= 6 seconds using librosa
- Call coqui_service.clone_voice()
- Store metadata in profile's cloned_voices JSONB via Supabase
- Return {"voice_id": str, "duration": float, "warnings": []}

5. Helper function _generate_tts_background():
- Get TTS service via factory
- Generate audio
- Log cost if > 0
- Update job status to completed with audio_path

6. Helper function _check_kokoro_available():
- Run subprocess espeak-ng --version
- Return True if returncode == 0
  </action>
  <verify>
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
from app.api.tts_routes import router
print(f'Routes: {[r.path for r in router.routes]}')
assert any('/providers' in str(r.path) for r in router.routes)
assert any('/voices' in str(r.path) for r in router.routes)
assert any('/generate' in str(r.path) for r in router.routes)
print('TTS routes OK')
"
```
  </verify>
  <done>
TTS API routes exist: /providers, /voices, /generate, /clone-voice.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount TTS router in main.py</name>
  <files>app/main.py</files>
  <action>
Update main.py to mount TTS router:

1. Add import:
```python
from app.api import tts_routes
```

2. Mount router with other routers:
```python
app.include_router(tts_routes.router, prefix="/api/v1")
```

Place after existing router mounts (routes, library_routes, segments_routes, postiz_routes).
  </action>
  <verify>
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
from app.main import app
routes = [r.path for r in app.routes]
assert any('/tts' in str(r) for r in routes), 'TTS routes not mounted'
print('TTS router mounted in main.py')
"
```
  </verify>
  <done>
TTS router mounted at /api/v1/tts/*.
  </done>
</task>

</tasks>

<verification>
1. tts_routes.py exists with router
2. Router has /providers, /voices, /generate, /clone-voice endpoints
3. main.py mounts tts_routes.router
4. Server starts without errors: `uvicorn app.main:app --reload`
5. GET /api/v1/tts/providers returns provider list
</verification>

<success_criteria>
- All TTS endpoints functional
- Provider list includes cost info and availability
- Voice list respects provider parameter
- Generate creates background job
- Clone validates audio duration
- Router mounted in main.py
</success_criteria>

<output>
After completion, create `.planning/phases/04-tts-provider-selection/04-05-SUMMARY.md`
</output>
