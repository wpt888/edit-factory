---
phase: 04-tts-provider-selection
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/services/tts/kokoro.py
  - app/services/tts/factory.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Kokoro TTS generates audio via TTSService interface"
    - "espeak-ng availability checked at instantiation with clear error"
    - "Preset voices returned via list_voices()"
  artifacts:
    - path: "app/services/tts/kokoro.py"
      provides: "Kokoro TTSService implementation"
      exports: ["KokoroTTSService"]
  key_links:
    - from: "app/services/tts/kokoro.py"
      to: "app/services/tts/base.py"
      via: "extends TTSService"
      pattern: "class KokoroTTSService.*TTSService"
---

<objective>
Implement Kokoro TTS service with preset voices.

Purpose: Add lightweight free local TTS engine as fast alternative. Enables TTS-04 (Kokoro integration).

Output: KokoroTTSService class with espeak-ng validation and preset voices.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-tts-provider-selection/04-RESEARCH.md

# Required context from 04-01
@app/services/tts/base.py
@app/services/tts/factory.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Kokoro TTS dependencies</name>
  <files>requirements.txt</files>
  <action>
Add Kokoro TTS dependencies to requirements.txt:

```
# TTS - Kokoro (lightweight, fast, requires espeak-ng system dependency)
kokoro>=0.9.4
```

Add comment explaining espeak-ng system dependency requirement:
```
# IMPORTANT: Kokoro requires espeak-ng system dependency
# Linux: apt-get install espeak-ng
# macOS: brew install espeak-ng
# Windows: https://github.com/espeak-ng/espeak-ng/releases
```

Note: soundfile is already added by 04-03.
  </action>
  <verify>
```bash
grep -E "^kokoro|espeak-ng" "/mnt/c/OBSID SRL/n8n/edit_factory/requirements.txt"
```
Should show kokoro dependency and espeak-ng comment.
  </verify>
  <done>
Kokoro TTS dependency added to requirements.txt with system dependency note.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KokoroTTSService</name>
  <files>app/services/tts/kokoro.py</files>
  <action>
Create KokoroTTSService implementing TTSService interface:

1. Import from base.py: TTSService, TTSVoice, TTSResult
2. Import subprocess for espeak-ng check
3. Import asyncio for async execution

4. Define preset voices as constant:
```python
KOKORO_VOICES = [
    {"id": "af", "name": "American English Female", "language": "en", "gender": "female"},
    {"id": "am", "name": "American English Male", "language": "en", "gender": "male"},
    {"id": "bf", "name": "British English Female", "language": "en", "gender": "female"},
    {"id": "bm", "name": "British English Male", "language": "en", "gender": "male"},
    {"id": "default", "name": "Default Voice", "language": "en", "gender": "neutral"},
]
```

5. Class KokoroTTSService(TTSService):
   - Constructor: output_dir, default_voice="af"
   - Call _check_espeak_available() in constructor, raise RuntimeError if not found with clear instructions

6. Implement _check_espeak_available():
   - Run subprocess: ["espeak-ng", "--version"]
   - Return True if returncode == 0
   - Return False on FileNotFoundError or timeout
   - Log espeak-ng version on success

7. Implement abstract properties:
   - provider_name -> "kokoro"
   - cost_per_1k_chars -> 0.0 (free)

8. Implement abstract methods:
   - list_voices(): Return KOKORO_VOICES converted to TTSVoice objects
   - generate_audio(text, voice_id, output_path, **kwargs):
     - Lazy import kokoro inside method
     - Generate audio using kokoro library
     - Calculate duration using librosa
     - Return TTSResult with cost=0.0
   - supports_voice_cloning() -> False

9. Use lazy import for kokoro library inside generate_audio() to avoid import-time dependency issues.
  </action>
  <verify>
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
import ast
with open('app/services/tts/kokoro.py') as f:
    tree = ast.parse(f.read())
classes = [n.name for n in ast.walk(tree) if isinstance(n, ast.ClassDef)]
print(f'Classes: {classes}')
assert 'KokoroTTSService' in classes, 'KokoroTTSService not found'
print('KokoroTTSService structure OK')
"
```
  </verify>
  <done>
KokoroTTSService exists with espeak-ng validation and preset voices.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update factory for Kokoro provider</name>
  <files>app/services/tts/factory.py</files>
  <action>
Update factory.py to support Kokoro provider:

1. Add lazy import for KokoroTTSService inside get_tts_service():
```python
elif provider == "kokoro":
    from app.services.tts.kokoro import KokoroTTSService
    return KokoroTTSService(
        output_dir=output_dir,
        default_voice=voice_id or "af"
    )
```

2. Keep other providers unchanged.

3. Remove NotImplementedError for "kokoro" case if present.
  </action>
  <verify>
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
import ast
with open('app/services/tts/factory.py') as f:
    content = f.read()
assert 'kokoro' in content.lower()
assert 'KokoroTTSService' in content
print('Factory includes Kokoro provider')
"
```
  </verify>
  <done>
Factory returns KokoroTTSService for "kokoro" provider with lazy import.
  </done>
</task>

</tasks>

<verification>
1. requirements.txt includes kokoro>=0.9.4
2. KokoroTTSService class exists and extends TTSService
3. KokoroTTSService checks espeak-ng in constructor
4. list_voices() returns 5 preset voices
5. Factory includes "kokoro" case with lazy import
</verification>

<success_criteria>
- KokoroTTSService implements full TTSService interface
- Preset voices available via list_voices()
- espeak-ng check raises RuntimeError with installation instructions if missing
- Factory returns KokoroTTSService for "kokoro" provider
- No import-time dependency loading (lazy import pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/04-tts-provider-selection/04-04-SUMMARY.md`
</output>
