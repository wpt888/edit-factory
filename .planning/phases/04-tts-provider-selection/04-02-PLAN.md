---
phase: 04-tts-provider-selection
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/services/tts/elevenlabs.py
  - app/services/tts/edge.py
  - app/services/tts/factory.py
autonomous: true

must_haves:
  truths:
    - "ElevenLabs TTS generates audio via TTSService interface"
    - "Edge TTS generates audio via TTSService interface"
    - "Both providers report accurate cost information"
    - "Factory returns correct implementation for elevenlabs and edge providers"
  artifacts:
    - path: "app/services/tts/elevenlabs.py"
      provides: "ElevenLabs TTSService implementation"
      exports: ["ElevenLabsTTSService"]
    - path: "app/services/tts/edge.py"
      provides: "Edge TTSService implementation"
      exports: ["EdgeTTSService"]
  key_links:
    - from: "app/services/tts/elevenlabs.py"
      to: "app/services/tts/base.py"
      via: "extends TTSService"
      pattern: "class ElevenLabsTTSService.*TTSService"
    - from: "app/services/tts/edge.py"
      to: "app/services/tts/base.py"
      via: "extends TTSService"
      pattern: "class EdgeTTSService.*TTSService"
    - from: "app/services/tts/factory.py"
      to: "app/services/tts/elevenlabs.py"
      via: "imports and returns"
      pattern: "from.*elevenlabs.*import.*ElevenLabsTTSService"
---

<objective>
Refactor existing ElevenLabs and Edge TTS services to implement TTSService interface.

Purpose: Migrate existing TTS implementations to unified interface, enabling seamless provider switching while preserving existing functionality.

Output: ElevenLabsTTSService and EdgeTTSService classes implementing TTSService abstract base class.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-tts-provider-selection/04-RESEARCH.md

# Required context from 04-01
@app/services/tts/base.py
@app/services/tts/factory.py

# Existing implementations to refactor
@app/services/elevenlabs_tts.py
@app/services/edge_tts_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ElevenLabsTTSService</name>
  <files>app/services/tts/elevenlabs.py</files>
  <action>
Create ElevenLabsTTSService implementing TTSService interface:

1. Import from base.py: TTSService, TTSVoice, TTSResult
2. Class ElevenLabsTTSService(TTSService):
   - Constructor: api_key, voice_id, model_id, output_dir
   - Store voice settings (stability=0.57, similarity_boost=0.75, style=0.22, use_speaker_boost=True)

3. Implement abstract properties:
   - provider_name -> "elevenlabs"
   - cost_per_1k_chars -> 0.22

4. Implement abstract methods:
   - list_voices(): Make API call to ElevenLabs GET /voices endpoint, convert to TTSVoice list
   - generate_audio(): Use existing logic from elevenlabs_tts.py, return TTSResult with cost calculation
   - supports_voice_cloning() -> False (ElevenLabs cloning is separate paid feature)

5. Use httpx for async HTTP calls (convert existing sync code to async)

6. Preserve cost tracking integration: call get_cost_tracker().log_elevenlabs_tts() after generation

7. Keep original elevenlabs_tts.py intact for backward compatibility (video_processor.py still uses it)
  </action>
  <verify>
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
from app.services.tts.elevenlabs import ElevenLabsTTSService
from app.services.tts.base import TTSService
assert issubclass(ElevenLabsTTSService, TTSService)
print('ElevenLabsTTSService implements TTSService')
"
```
  </verify>
  <done>
ElevenLabsTTSService exists, extends TTSService, implements all abstract methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EdgeTTSService</name>
  <files>app/services/tts/edge.py</files>
  <action>
Create EdgeTTSService implementing TTSService interface:

1. Import from base.py: TTSService, TTSVoice, TTSResult
2. Class EdgeTTSService(TTSService):
   - Constructor: output_dir, default_voice (default "en-US-GuyNeural")

3. Implement abstract properties:
   - provider_name -> "edge"
   - cost_per_1k_chars -> 0.0 (free)

4. Implement abstract methods:
   - list_voices(language): Use edge_tts.list_voices(), convert to TTSVoice list. Cache result.
   - generate_audio(text, voice_id, output_path, rate="+0%", pitch="+0Hz"): Use edge_tts.Communicate, return TTSResult with cost=0.0
   - supports_voice_cloning() -> False

5. Use existing async pattern from edge_tts_service.py. Already async-ready.

6. Get audio duration using librosa.get_duration() for TTSResult.duration_seconds

7. Keep original edge_tts_service.py intact for backward compatibility.
  </action>
  <verify>
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
from app.services.tts.edge import EdgeTTSService
from app.services.tts.base import TTSService
assert issubclass(EdgeTTSService, TTSService)
print('EdgeTTSService implements TTSService')
"
```
  </verify>
  <done>
EdgeTTSService exists, extends TTSService, implements all abstract methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update factory with provider imports</name>
  <files>app/services/tts/factory.py</files>
  <action>
Update factory.py to import and return ElevenLabs and Edge implementations:

1. Add imports at top:
```python
from app.services.tts.elevenlabs import ElevenLabsTTSService
from app.services.tts.edge import EdgeTTSService
```

2. Update get_tts_service() function:
   - For "elevenlabs": return ElevenLabsTTSService with api_key from settings
   - For "edge": return EdgeTTSService
   - Keep "coqui" and "kokoro" as NotImplementedError for now

3. Import get_settings from app.config for API key access
  </action>
  <verify>
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
from app.services.tts import get_tts_service
edge = get_tts_service('edge', 'test-profile')
print(f'Edge provider: {edge.provider_name}, cost: {edge.cost_per_1k_chars}')
"
```
Should print: Edge provider: edge, cost: 0.0
  </verify>
  <done>
Factory returns ElevenLabsTTSService for "elevenlabs" and EdgeTTSService for "edge". Other providers pending.
  </done>
</task>

</tasks>

<verification>
1. ElevenLabsTTSService is subclass of TTSService
2. EdgeTTSService is subclass of TTSService
3. get_tts_service("edge", "test") returns EdgeTTSService instance
4. get_tts_service("elevenlabs", "test") returns ElevenLabsTTSService instance (requires API key env var)
5. Both services have correct cost_per_1k_chars values
</verification>

<success_criteria>
- Both service classes implement TTSService interface completely
- Factory returns correct instances for "elevenlabs" and "edge"
- Original services (elevenlabs_tts.py, edge_tts_service.py) still work for backward compatibility
- No import errors in any module
</success_criteria>

<output>
After completion, create `.planning/phases/04-tts-provider-selection/04-02-SUMMARY.md`
</output>
