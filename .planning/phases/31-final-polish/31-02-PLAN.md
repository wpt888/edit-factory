---
phase: 31-final-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/app/usage/page.tsx
  - frontend/src/app/librarie/page.tsx
  - frontend/src/hooks/use-polling.ts
autonomous: true
requirements: [FE-02, FE-03, FE-05]
must_haves:
  truths:
    - "usage/page.tsx data-fetch GET calls use apiGetWithRetry instead of apiGet"
    - "librarie/page.tsx data-fetch GET calls use apiGetWithRetry instead of raw apiGet/apiFetch"
    - "usePolling hook uses apiFetch from @/lib/api instead of raw fetch with local API_URL"
  artifacts:
    - path: "frontend/src/app/usage/page.tsx"
      provides: "Retry-capable data fetching"
      contains: "apiGetWithRetry"
    - path: "frontend/src/app/librarie/page.tsx"
      provides: "Retry-capable data fetching"
      contains: "apiGetWithRetry"
    - path: "frontend/src/hooks/use-polling.ts"
      provides: "Centralized API client usage in polling"
      contains: "apiFetch"
  key_links:
    - from: "frontend/src/hooks/use-polling.ts"
      to: "frontend/src/lib/api.ts"
      via: "apiFetch import"
      pattern: "import.*apiFetch.*from.*@/lib/api"
    - from: "frontend/src/app/usage/page.tsx"
      to: "frontend/src/lib/api.ts"
      via: "apiGetWithRetry import"
      pattern: "apiGetWithRetry"
---

<objective>
Close remaining frontend integration gaps from the v6 audit: adopt apiGetWithRetry in usage and librarie pages, and refactor usePolling to use the centralized apiFetch client instead of raw fetch.

Purpose: Ensure all frontend data fetching goes through the centralized API client with timeout, retry, and error handling — no raw fetch() calls remain for API communication.
Output: Updated usage/page.tsx, librarie/page.tsx, and use-polling.ts.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/lib/api.ts
@frontend/src/hooks/use-polling.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Adopt apiGetWithRetry in usage/page.tsx and librarie/page.tsx</name>
  <files>
    frontend/src/app/usage/page.tsx
    frontend/src/app/librarie/page.tsx
  </files>
  <action>
1. In `frontend/src/app/usage/page.tsx`:
   - The file has 3 `apiGet()` calls (lines ~105, 120, 121, 142) for data fetching.
   - Add `apiGetWithRetry` to the import from `@/lib/api` (keep `apiGet` only if still used elsewhere for blob downloads).
   - Replace `apiGet("/gemini/status")` with `apiGetWithRetry("/gemini/status")`
   - Replace `apiGet("/costs")` with `apiGetWithRetry("/costs")`
   - Replace `apiGet("/usage")` with `apiGetWithRetry("/usage")`
   - Replace `apiGet("/costs/all")` with `apiGetWithRetry("/costs/all")`
   - Remove `apiGet` from import if no longer used in the file.

2. In `frontend/src/app/librarie/page.tsx`:
   - Line ~380 has `const res = await apiGet(url)` — this is a data-fetch GET for downloading/streaming a file blob.
   - Check context: if it's a blob download (binary response), it should stay as `apiGet` per project convention (blob downloads are not retry candidates — see 30-03 decision).
   - If it IS a JSON data-fetch (not blob), replace with `apiGetWithRetry(url)`.
   - Verify the import already includes `apiGetWithRetry` (line 41 shows it does).

NOTE: Per Phase 30-03 decision, blob download calls (binary fetches) should remain as apiGet. Only JSON data-fetch GETs should use apiGetWithRetry. Check the context of each call before replacing.
  </action>
  <verify>
    - `grep -n "apiGet(" frontend/src/app/usage/page.tsx` — should show only apiGetWithRetry (or apiGet only for blob downloads)
    - `grep -c "apiGetWithRetry" frontend/src/app/usage/page.tsx` — count >= 3
  </verify>
  <done>usage/page.tsx uses apiGetWithRetry for all JSON data-fetch GET calls; librarie/page.tsx blob downloads correctly remain as apiGet</done>
</task>

<task type="auto">
  <name>Task 2: Refactor usePolling to use apiFetch instead of raw fetch</name>
  <files>
    frontend/src/hooks/use-polling.ts
  </files>
  <action>
Replace the raw `fetch()` call and local `API_URL` constant in usePolling with `apiFetch` from `@/lib/api`.

Current code (line 33, 85):
```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000/api/v1";
// ...
const response = await fetch(`${API_URL}${endpoint}`);
```

Replace with:
```typescript
import { apiFetch } from "@/lib/api";
// ...
const response = await apiFetch(endpoint);
```

Changes:
1. Add `import { apiFetch } from "@/lib/api";` at top of file
2. Remove the local `const API_URL = ...` line (apiFetch handles URL construction internally)
3. Replace `fetch(`${API_URL}${endpoint}`)` with `apiFetch(endpoint)` on line 85
4. The `apiFetch` function already handles: URL prefix, timeout, profile header injection, and throws on non-2xx (via ApiError). The existing error handling in the catch block should work — but note that apiFetch throws ApiError (not generic Error) on HTTP errors, so the `if (!response.ok)` check after fetch can be removed since apiFetch already throws.
5. Remove the `if (!response.ok) { throw new Error(...) }` block since apiFetch handles this.
6. Keep the `.json()` call on the response since apiFetch returns a Response object.

The exponential backoff logic in the catch block should remain unchanged — it still handles errors the same way.
  </action>
  <verify>
    - `grep "raw.*fetch\|fetch(" frontend/src/hooks/use-polling.ts` — no raw fetch calls
    - `grep "API_URL" frontend/src/hooks/use-polling.ts` — no local API_URL constant
    - `grep "apiFetch" frontend/src/hooks/use-polling.ts` — present
    - Frontend builds without errors: `cd frontend && npx next build 2>&1 | tail -5`
  </verify>
  <done>usePolling uses apiFetch from @/lib/api; no raw fetch() or local API_URL constant remains; exponential backoff preserved</done>
</task>

</tasks>

<verification>
1. `grep -c "apiGetWithRetry" frontend/src/app/usage/page.tsx` — at least 3
2. `grep "apiFetch" frontend/src/hooks/use-polling.ts` — present
3. `grep "API_URL" frontend/src/hooks/use-polling.ts` — no matches
4. `grep "fetch(" frontend/src/hooks/use-polling.ts` — only apiFetch, no raw fetch
5. `cd frontend && npx next build` — succeeds without errors
</verification>

<success_criteria>
- usage/page.tsx uses apiGetWithRetry for all JSON data-fetch GETs
- librarie/page.tsx blob downloads remain apiGet (per 30-03 convention)
- usePolling uses apiFetch from @/lib/api — no raw fetch() or local API_URL
- Frontend builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/31-final-polish/31-02-SUMMARY.md`
</output>
