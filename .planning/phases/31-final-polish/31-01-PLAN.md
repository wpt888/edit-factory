---
phase: 31-final-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - app/services/cost_tracker.py
  - app/services/job_storage.py
  - app/services/tts_library_service.py
  - app/api/routes.py
  - app/api/library_routes.py
  - app/api/tts_library_routes.py
autonomous: true
requirements: [TEST-01, QUAL-01]
must_haves:
  truths:
    - "pip install -r requirements.txt installs pytest without extra manual steps"
    - "cost_tracker.py, job_storage.py, tts_library_service.py use get_supabase() from app.db — no local create_client calls"
    - "All TTS endpoints use validate_tts_text_length() helper instead of inline MAX_TTS_CHARS comparisons"
  artifacts:
    - path: "requirements.txt"
      provides: "pytest dependency"
      contains: "pytest"
    - path: "app/services/cost_tracker.py"
      provides: "Centralized Supabase client usage"
      contains: "from app.db import get_supabase"
    - path: "app/services/job_storage.py"
      provides: "Centralized Supabase client usage"
      contains: "from app.db import get_supabase"
    - path: "app/services/tts_library_service.py"
      provides: "Centralized Supabase client usage"
      contains: "from app.db import get_supabase"
  key_links:
    - from: "app/services/cost_tracker.py"
      to: "app/db.py"
      via: "get_supabase() import"
      pattern: "from app\\.db import get_supabase"
    - from: "app/api/routes.py"
      to: "app/api/validators.py"
      via: "validate_tts_text_length import"
      pattern: "from app\\.api\\.validators import.*validate_tts_text_length"
---

<objective>
Close remaining backend tech debt from the v6 audit: add pytest to requirements.txt, centralize Supabase client in 3 services that still use local create_client, and replace inline MAX_TTS_CHARS comparisons with the validate_tts_text_length() helper.

Purpose: Eliminate the last backend integration gaps so a fresh venv install runs tests and all services use the canonical patterns established in earlier phases.
Output: Updated requirements.txt, 3 service files using get_supabase(), and 3 route files using validate_tts_text_length().
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/db.py
@app/api/validators.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pytest to requirements.txt and centralize Supabase client in 3 services</name>
  <files>
    requirements.txt
    app/services/cost_tracker.py
    app/services/job_storage.py
    app/services/tts_library_service.py
  </files>
  <action>
1. Add `pytest` to requirements.txt (append at end, no version pin needed for personal project).

2. In `app/services/cost_tracker.py`:
   - Replace the local `from supabase import create_client` + `self._supabase = create_client(settings.supabase_url, settings.supabase_key)` block with `from app.db import get_supabase` and `self._supabase = get_supabase()`.
   - Keep the same try/except fallback structure (if get_supabase() returns None or raises, fall back to in-memory).

3. In `app/services/job_storage.py`:
   - Same pattern: replace `from supabase import create_client` + `self._supabase = create_client(...)` with `from app.db import get_supabase` + `self._supabase = get_supabase()`.
   - Preserve existing fallback behavior (in-memory when Supabase unavailable).

4. In `app/services/tts_library_service.py`:
   - Replace `from supabase import create_client` + `supabase = create_client(...)` with `from app.db import get_supabase` + `supabase = get_supabase()`.
   - Preserve existing error handling.

IMPORTANT: The app.db.get_supabase() function returns a singleton client or None. These services already handle None/failure gracefully — just swap the initialization call.
  </action>
  <verify>
    - `grep -r "create_client" app/services/cost_tracker.py app/services/job_storage.py app/services/tts_library_service.py` returns no matches
    - `grep "pytest" requirements.txt` returns a match
    - `grep "from app.db import get_supabase" app/services/cost_tracker.py app/services/job_storage.py app/services/tts_library_service.py` returns matches in all 3 files
  </verify>
  <done>pytest is in requirements.txt; cost_tracker.py, job_storage.py, tts_library_service.py all import get_supabase from app.db with no local create_client calls remaining</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline MAX_TTS_CHARS comparisons with validate_tts_text_length() helper</name>
  <files>
    app/api/routes.py
    app/api/library_routes.py
    app/api/tts_library_routes.py
  </files>
  <action>
The `validate_tts_text_length(text)` helper in `app/api/validators.py` strips the text, checks length, raises HTTPException(400) if too long, and returns the stripped text. Replace all inline `if len(...) > MAX_TTS_CHARS: raise HTTPException(...)` blocks with a single call to this helper.

1. In `app/api/routes.py` (3 locations):
   - Add `validate_tts_text_length` to the existing validators import line (already imports `validate_upload_size, MAX_TTS_CHARS`)
   - Line ~1051: Replace `if len(text) > MAX_TTS_CHARS: raise HTTPException(...)` with `text = validate_tts_text_length(text)`
   - Line ~1223: Replace `if len(tts_text) > MAX_TTS_CHARS: raise HTTPException(...)` with `tts_text = validate_tts_text_length(tts_text, "tts_text")`
   - Line ~1290: Replace the `if len(tts_text) > MAX_TTS_CHARS: raise ValueError(...)` with `tts_text = validate_tts_text_length(tts_text, "tts_text")` (note: this one raises ValueError inside a try block — validate_tts_text_length raises HTTPException which is fine since it's at endpoint level, but verify the surrounding try/except still works or adjust)
   - Keep `MAX_TTS_CHARS` in the import if it's used elsewhere in the file; remove if not.

2. In `app/api/library_routes.py` (1 location):
   - Add `validate_tts_text_length` to the existing validators import
   - Line ~854: Replace the `if request.generate_tts and request.tts_text and len(request.tts_text.strip()) > MAX_TTS_CHARS: raise HTTPException(...)` with: keep the `if request.generate_tts and request.tts_text:` guard, then call `validate_tts_text_length(request.tts_text, "tts_text")`
   - Remove `MAX_TTS_CHARS` from import if no longer used

3. In `app/api/tts_library_routes.py` (2 locations):
   - Add `validate_tts_text_length` to the existing validators import
   - Line ~201: Replace inline check with `validate_tts_text_length(request.tts_text.strip(), "tts_text")`
   - Line ~276: Same replacement
   - Remove `MAX_TTS_CHARS` from import if no longer used
  </action>
  <verify>
    - `grep -n "len.*MAX_TTS_CHARS" app/api/routes.py app/api/library_routes.py app/api/tts_library_routes.py` returns only the validators.py definition (no inline comparisons in route files)
    - `grep "validate_tts_text_length" app/api/routes.py app/api/library_routes.py app/api/tts_library_routes.py` shows imports in all 3 files
  </verify>
  <done>All TTS endpoints use validate_tts_text_length() helper from validators.py; no inline MAX_TTS_CHARS comparisons remain in route files</done>
</task>

</tasks>

<verification>
1. `grep -r "create_client" app/services/cost_tracker.py app/services/job_storage.py app/services/tts_library_service.py` — no matches
2. `grep "pytest" requirements.txt` — match found
3. `grep -c "validate_tts_text_length" app/api/routes.py app/api/library_routes.py app/api/tts_library_routes.py` — count > 0 in each
4. `grep -c "len.*MAX_TTS_CHARS" app/api/routes.py app/api/library_routes.py app/api/tts_library_routes.py` — 0 in each
5. `cd /path/to/project && python -c "from app.services.cost_tracker import CostTracker; print('OK')"` — no import errors
</verification>

<success_criteria>
- pytest installable from requirements.txt
- Zero create_client calls in cost_tracker.py, job_storage.py, tts_library_service.py
- Zero inline MAX_TTS_CHARS comparisons in route files (all use validate_tts_text_length)
</success_criteria>

<output>
After completion, create `.planning/phases/31-final-polish/31-01-SUMMARY.md`
</output>
