---
phase: 07-platform-export-presets
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - app/api/library_routes.py
autonomous: true

must_haves:
  truths:
    - "Final render uses keyframe controls (-g, -keyint_min) from preset"
    - "Audio encoded at 192k bitrate in final render"
    - "Platform-specific CRF applied during encoding"
    - "GPU encoding uses correct NVENC parameters"
    - "CPU encoding uses x264 with preset parameters"
  artifacts:
    - path: "app/api/library_routes.py"
      provides: "Updated _render_with_preset with keyframe controls and preset integration"
      contains: '"-g"'
  key_links:
    - from: "app/api/library_routes.py"
      to: "app/services/encoding_presets.py"
      via: "get_preset import and to_ffmpeg_params usage"
      pattern: "from app\\.services\\.encoding_presets import"
---

<objective>
Integrate the encoding presets service into the final render pipeline, adding keyframe controls and professional encoding parameters.

Purpose: Ensures exported videos use platform-optimized encoding with proper keyframe intervals for platform recompression compatibility.

Output: Updated `_render_with_preset` function using preset parameters including -g and -keyint_min
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-platform-export-presets/07-RESEARCH.md
@.planning/phases/07-platform-export-presets/07-01-SUMMARY.md

# Current implementation to modify
@app/api/library_routes.py
@app/services/encoding_presets.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update _render_with_preset to use keyframe controls</name>
  <files>app/api/library_routes.py</files>
  <action>
Modify `_render_with_preset` function in `app/api/library_routes.py` to add keyframe controls:

1. **Add import at top of file** (after existing imports):
   ```python
   from app.services.encoding_presets import get_preset, EncodingPreset
   ```

2. **Update video encoding section** (around line 2379-2390) to add keyframe params:

   **Before filters/video codec settings, add keyframe extraction from preset:**
   ```python
   # Get keyframe settings from preset (fallback to 60 for 2-sec GOP at 30fps)
   gop_size = preset.get("gop_size", 60)
   keyint_min = preset.get("keyint_min", 60)
   ```

   **Replace hardcoded encoding params with:**
   ```python
   # Video encoding (optimized for social media)
   cmd.extend([
       "-c:v", preset.get("video_codec", "libx264"),
       "-profile:v", preset.get("video_profile", "high"),
       "-level:v", preset.get("video_level", "4.0"),
       "-crf", str(preset.get("crf", 18)),
       "-preset", preset.get("video_preset", "medium"),
       # Keyframe controls for platform compatibility (ENC-03)
       "-g", str(gop_size),
       "-keyint_min", str(keyint_min),
       "-sc_threshold", "0",  # Disable scene change detection for consistent keyframes
       "-bf", "2",
       "-maxrate", preset.get("video_bitrate", "10M"),
       "-bufsize", str(int(preset.get("video_bitrate", "10M").replace("M", "")) * 2) + "M",
       "-r", str(preset.get("fps", 30))
   ])
   ```

3. **Update audio encoding section** to use 192k default (around line 2393-2400):
   ```python
   cmd.extend([
       "-c:a", preset.get("audio_codec", "aac"),
       "-b:a", preset.get("audio_bitrate", "192k"),  # ENC-04: 192k standard
       "-ar", str(preset.get("audio_sample_rate", 48000)),
       "-map", "0:v:0",
       "-map", "1:a:0"
   ])
   ```

4. **Add logging** for encoding params used:
   ```python
   logger.info(f"Encoding with: CRF={preset.get('crf', 18)}, GOP={gop_size}, audio={preset.get('audio_bitrate', '192k')}")
   ```

Important:
- Keep existing filter chain logic (scale, crop, subtitles)
- Keep existing silent audio handling
- Add keyframe params AFTER -preset, BEFORE -maxrate
- Use preset dict values with safe defaults
  </action>
  <verify>
1. Check import exists:
```bash
grep -n "from app.services.encoding_presets import" "/mnt/c/OBSID SRL/n8n/edit_factory/app/api/library_routes.py" | head -2
```

2. Check keyframe params in _render_with_preset:
```bash
grep -A5 '"-g"' "/mnt/c/OBSID SRL/n8n/edit_factory/app/api/library_routes.py" | head -10
```

3. Check 192k audio bitrate:
```bash
grep -n '"192k"' "/mnt/c/OBSID SRL/n8n/edit_factory/app/api/library_routes.py"
```

4. Verify Python syntax:
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "from app.api import library_routes; print('Import OK')"
```
  </verify>
  <done>
- _render_with_preset includes -g and -keyint_min parameters
- Audio bitrate defaults to 192k
- Encoding params logged for debugging
- Import added for encoding_presets module
  </done>
</task>

<task type="auto">
  <name>Task 2: Update database presets with keyframe columns</name>
  <files>N/A - Database operation via Supabase</files>
  <action>
Update the existing export presets in the database to include keyframe parameters.

**Option A - If columns exist:** Update preset values via API call:
```python
# Run this in Python to update presets
import os
from supabase import create_client

supabase = create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_KEY"))

presets_to_update = [
    {
        "name": "tiktok",
        "display_name": "TikTok",
        "crf": 20,
        "video_preset": "medium",
        "gop_size": 60,
        "keyint_min": 60,
        "audio_bitrate": "192k"
    },
    {
        "name": "instagram_reels",
        "display_name": "Instagram Reels",
        "crf": 18,
        "video_preset": "slow",
        "gop_size": 60,
        "keyint_min": 60,
        "audio_bitrate": "192k"
    },
    {
        "name": "youtube_shorts",
        "display_name": "YouTube Shorts",
        "crf": 18,
        "video_preset": "slow",
        "gop_size": 60,
        "keyint_min": 60,
        "audio_bitrate": "192k"
    },
    {
        "name": "generic",
        "display_name": "Generic High Quality",
        "crf": 20,
        "video_preset": "medium",
        "gop_size": 60,
        "keyint_min": 60,
        "audio_bitrate": "192k",
        "is_default": True
    }
]

for preset in presets_to_update:
    name = preset.pop("name")
    # Upsert: update if exists, insert if not
    result = supabase.table("editai_export_presets").upsert(
        {"name": name, **preset},
        on_conflict="name"
    ).execute()
    print(f"Updated preset: {name}")
```

**Option B - If columns don't exist:** First add columns via Supabase SQL editor:
```sql
-- Add missing columns (run in Supabase SQL editor if needed)
ALTER TABLE editai_export_presets
ADD COLUMN IF NOT EXISTS video_preset TEXT DEFAULT 'medium',
ADD COLUMN IF NOT EXISTS gop_size INTEGER DEFAULT 60,
ADD COLUMN IF NOT EXISTS keyint_min INTEGER DEFAULT 60;

-- Update audio_bitrate to 192k
UPDATE editai_export_presets SET audio_bitrate = '192k' WHERE audio_bitrate = '128k' OR audio_bitrate = '320k';
```

Then run the Python upsert script.

Important:
- Check existing column names first
- Use upsert to handle both insert and update cases
- Preserve existing presets like "instagram_reels" (the current default)
  </action>
  <verify>
Query presets to verify:
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
import os
from dotenv import load_dotenv
load_dotenv()
from supabase import create_client

supabase = create_client(os.getenv('SUPABASE_URL'), os.getenv('SUPABASE_KEY'))
result = supabase.table('editai_export_presets').select('name,crf,audio_bitrate,gop_size,keyint_min,video_preset').execute()
for p in result.data:
    print(f\"{p['name']}: CRF={p.get('crf')}, audio={p.get('audio_bitrate')}, gop={p.get('gop_size')}\")
"
```

Expected output:
- All presets show CRF 18-20
- All presets show audio_bitrate=192k
- All presets show gop_size=60
  </verify>
  <done>
- Database presets have gop_size and keyint_min columns
- All presets updated with correct values
- Audio bitrate is 192k across all presets
- CRF values are 18-20 (professional range)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end encoding integration</name>
  <files>N/A - Integration verification</files>
  <action>
Verify the complete integration works:

1. **Start the backend server:**
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python run.py &
# Wait for startup
sleep 5
```

2. **Test preset API endpoint:**
```bash
curl -s http://localhost:8000/api/v1/library/export-presets | python -m json.tool | head -30
```

Should return presets with keyframe params.

3. **Verify FFmpeg command would be correct:**
Create a test that checks the command construction without actually rendering:

```python
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
# Simulate what _render_with_preset would build
preset = {
    'name': 'instagram_reels',
    'width': 1080,
    'height': 1920,
    'fps': 30,
    'crf': 18,
    'video_preset': 'slow',
    'gop_size': 60,
    'keyint_min': 60,
    'audio_bitrate': '192k',
    'video_codec': 'libx264',
    'video_bitrate': '10M'
}

# Build expected params
gop_size = preset.get('gop_size', 60)
keyint_min = preset.get('keyint_min', 60)

cmd = ['ffmpeg', '-y', '-i', 'input.mp4']
cmd.extend([
    '-c:v', preset.get('video_codec', 'libx264'),
    '-crf', str(preset.get('crf', 18)),
    '-preset', preset.get('video_preset', 'medium'),
    '-g', str(gop_size),
    '-keyint_min', str(keyint_min),
    '-sc_threshold', '0',
    '-b:a', preset.get('audio_bitrate', '192k'),
])
cmd.append('output.mp4')

# Verify critical params
assert '-g' in cmd, 'Missing -g'
assert '60' in cmd, 'Missing gop value'
assert '-keyint_min' in cmd, 'Missing -keyint_min'
assert '192k' in cmd, 'Missing 192k audio'
assert '-crf' in cmd, 'Missing -crf'
assert '18' in cmd, 'Missing crf value'

print('Command validation PASSED')
print('Sample command:', ' '.join(cmd[:15]), '...')
"
```

4. **Kill test server:**
```bash
pkill -f "python run.py" || true
```
  </action>
  <verify>
1. API returns presets with keyframe params
2. FFmpeg command includes -g, -keyint_min, 192k audio, CRF 18-20
3. No Python import errors
  </verify>
  <done>
- Export presets API returns presets with all encoding params
- FFmpeg command construction includes keyframe controls
- Integration is complete and verified
  </done>
</task>

</tasks>

<verification>
1. `_render_with_preset` includes -g and -keyint_min parameters
2. Database presets have correct CRF (18-20), audio (192k), keyframe (60) values
3. Export presets API returns complete preset data
4. FFmpeg commands would include all required encoding params
</verification>

<success_criteria>
- ENC-01 satisfied: Platform-specific presets applied during export
- ENC-02 satisfied: CRF 18-20, preset medium/slow used in render
- ENC-03 satisfied: Keyframe controls (-g 60, -keyint_min 60) added to FFmpeg command
- ENC-04 satisfied: Audio encoded at 192k bitrate
- ENC-05 implicitly satisfied: Presets are data-driven (database + code fallbacks)
</success_criteria>

<output>
After completion, create `.planning/phases/07-platform-export-presets/07-02-SUMMARY.md`
</output>
