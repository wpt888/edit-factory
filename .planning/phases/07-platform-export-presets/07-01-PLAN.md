---
phase: 07-platform-export-presets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/encoding_presets.py
autonomous: true

must_haves:
  truths:
    - "EncodingPreset Pydantic model validates preset configuration"
    - "Four platform presets are defined (TikTok, Reels, YouTube Shorts, Generic)"
    - "get_preset() returns correct preset by platform name"
    - "list_presets() returns all available presets for API"
    - "to_ffmpeg_params() generates correct FFmpeg parameters"
  artifacts:
    - path: "app/services/encoding_presets.py"
      provides: "Platform-specific encoding preset definitions with Pydantic validation"
      exports: ["EncodingPreset", "get_preset", "list_presets", "PRESETS", "PRESET_TIKTOK", "PRESET_REELS", "PRESET_YOUTUBE_SHORTS", "PRESET_GENERIC"]
      min_lines: 80
  key_links:
    - from: "app/services/encoding_presets.py"
      to: "pydantic.BaseModel"
      via: "model inheritance"
      pattern: "class EncodingPreset\\(BaseModel\\)"
---

<objective>
Create the encoding presets service module with Pydantic-validated preset definitions for TikTok, Instagram Reels, YouTube Shorts, and Generic platforms.

Purpose: Establishes data-driven, validated encoding configuration that can be extended without code changes. Professional encoding parameters (CRF 18-20, 192k audio, keyframe controls) are defined as code-first constants.

Output: `app/services/encoding_presets.py` with EncodingPreset model and four platform presets
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-platform-export-presets/07-RESEARCH.md

# Existing service pattern
@app/services/elevenlabs_tts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create encoding_presets.py service module</name>
  <files>app/services/encoding_presets.py</files>
  <action>
Create `app/services/encoding_presets.py` with:

1. **EncodingPreset Pydantic model** with these fields:
   - `name: str` - Display name
   - `platform: Literal["tiktok", "reels", "youtube_shorts", "generic"]`
   - `description: str` - Human-readable description
   - `codec: str = "libx264"` - Video codec
   - `crf: int = Field(ge=0, le=51, default=20)` - Quality (lower = better)
   - `preset: Literal["ultrafast", "superfast", "veryfast", "faster", "fast", "medium", "slow", "slower", "veryslow"] = "medium"` - Encoding speed
   - `gop_size: int = Field(ge=1, default=60)` - Keyframe interval (-g param)
   - `keyint_min: int = Field(ge=1, default=60)` - Min keyframe interval
   - `audio_bitrate: str = Field(pattern=r"^\d+k$", default="192k")` - Audio bitrate
   - `audio_codec: str = "aac"`
   - `audio_sample_rate: int = 48000`
   - `target_bitrate_mbps: float = Field(gt=0, default=5.0)` - Informational
   - `max_file_size_mb: Optional[int] = None` - Platform limit (informational)

2. **to_ffmpeg_params(use_gpu: bool = False) -> list** method that returns FFmpeg parameters:
   - For GPU: use h264_nvenc, preset p4, -cq instead of -crf
   - For CPU: use libx264 with full preset params
   - Both include: -g, -keyint_min, -sc_threshold 0, -bf 2, audio params, -pix_fmt yuv420p

3. **Four preset constants:**
   - `PRESET_TIKTOK`: CRF 20, preset medium, gop 60, 192k audio, max 500MB
   - `PRESET_REELS`: CRF 18, preset slow, gop 60, 192k audio, max 4000MB
   - `PRESET_YOUTUBE_SHORTS`: CRF 18, preset slow, gop 60, 192k audio, no max
   - `PRESET_GENERIC`: CRF 20, preset medium, gop 60, 192k audio, no max

4. **PRESETS dict** mapping platform names to preset objects

5. **Helper functions:**
   - `get_preset(platform: str) -> EncodingPreset` - Returns preset by name, fallback to generic
   - `list_presets() -> list[dict]` - Returns list of preset summaries for API

Important: Use research patterns from 07-RESEARCH.md. Match the existing service pattern (singleton function, logging).
  </action>
  <verify>
Run Python import test:
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "
from app.services.encoding_presets import EncodingPreset, get_preset, list_presets, PRESETS
print('Presets:', list(PRESETS.keys()))
preset = get_preset('tiktok')
print(f'TikTok: CRF={preset.crf}, audio={preset.audio_bitrate}, gop={preset.gop_size}')
params = preset.to_ffmpeg_params(use_gpu=False)
print('FFmpeg params contain -g:', '-g' in params)
print('FFmpeg params:', params[:10])
"
```
Should output:
- Presets: ['tiktok', 'reels', 'youtube_shorts', 'generic']
- TikTok: CRF=20, audio=192k, gop=60
- FFmpeg params contain -g: True
  </verify>
  <done>
- EncodingPreset model exists with all required fields
- Four platform presets defined with correct CRF/audio/keyframe values
- get_preset() returns correct preset
- to_ffmpeg_params() generates valid FFmpeg parameter list including -g and -keyint_min
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for encoding presets</name>
  <files>tests/test_encoding_presets.py</files>
  <action>
Create `tests/test_encoding_presets.py` with pytest tests:

1. **test_preset_validation()** - Verify Pydantic validates fields (invalid CRF > 51 should raise)
2. **test_all_presets_exist()** - Verify PRESETS dict has all 4 platforms
3. **test_get_preset_returns_correct()** - Verify get_preset('tiktok') returns PRESET_TIKTOK
4. **test_get_preset_fallback()** - Verify unknown platform returns PRESET_GENERIC
5. **test_ffmpeg_params_cpu()** - Verify to_ffmpeg_params(use_gpu=False) contains correct params
6. **test_ffmpeg_params_gpu()** - Verify to_ffmpeg_params(use_gpu=True) uses h264_nvenc
7. **test_audio_bitrate_192k()** - Verify all presets use 192k audio
8. **test_keyframe_params()** - Verify all presets have gop_size and keyint_min set to 60
9. **test_list_presets()** - Verify list_presets() returns list of dicts with id, name, platform

Use pytest patterns. Each test should be self-contained.
  </action>
  <verify>
Run tests:
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -m pytest tests/test_encoding_presets.py -v
```
All 9 tests should pass.
  </verify>
  <done>
- Test file exists at tests/test_encoding_presets.py
- All 9 tests pass
- Tests verify CRF range, audio bitrate, keyframe params, GPU/CPU switching
  </done>
</task>

</tasks>

<verification>
1. Module imports without errors
2. All 4 presets have correct values (CRF 18-20, audio 192k, gop 60)
3. FFmpeg params include keyframe controls (-g, -keyint_min)
4. Unit tests pass
</verification>

<success_criteria>
- `app/services/encoding_presets.py` exists with validated Pydantic model
- Four platform presets with professional encoding settings
- ENC-02 partially satisfied: CRF 18-20, preset medium/slow defined
- ENC-03 partially satisfied: Keyframe controls defined in preset model
- ENC-04 partially satisfied: 192k audio bitrate defined
</success_criteria>

<output>
After completion, create `.planning/phases/07-platform-export-presets/07-01-SUMMARY.md`
</output>
