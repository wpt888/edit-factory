---
phase: 18-video-composition
plan: 02
type: execute
wave: 2
depends_on:
  - 18-01
files_modified:
  - app/services/product_video_compositor.py
autonomous: true
requirements:
  - COMP-02
  - COMP-03
  - COMP-04

must_haves:
  truths:
    - "Product name, price, and brand appear as text overlays on the video"
    - "Sale price renders alongside original price (muted gray) when product has a sale_price"
    - "A sale badge overlay appears in a corner when the product has a sale_price"
    - "A CTA text overlay appears at the bottom of the video with configurable text"
  artifacts:
    - path: "app/services/product_video_compositor.py"
      provides: "Complete composition with text overlays, sale badge, CTA"
      contains: "ensure_sale_badge"
  key_links:
    - from: "app/services/product_video_compositor.py"
      to: "app/services/textfile_helper.py"
      via: "build_multi_drawtext for all product text"
      pattern: "build_multi_drawtext"
    - from: "app/services/product_video_compositor.py"
      to: "FFmpeg overlay filter"
      via: "filter_complex with badge PNG input"
      pattern: "filter_complex.*overlay"
---

<objective>
Add complete text overlay system (product name, brand, price, sale price, CTA), sale badge PNG overlay, and upgrade the compositor to use `filter_complex` when badge overlay is needed. Test against a realistic product scenario with sale pricing.

Purpose: Completes the visual composition layer so generated videos have all product information displayed professionally. Without this, videos would show only the animated image with no product context.
Output: Updated `app/services/product_video_compositor.py` with full overlay system.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-video-composition/18-RESEARCH.md
@.planning/phases/18-video-composition/18-01-SUMMARY.md
@app/services/textfile_helper.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add full text overlay system, sale badge, and CTA to compositor</name>
  <files>app/services/product_video_compositor.py</files>
  <action>
Update `app/services/product_video_compositor.py` to add:

1. **`ensure_sale_badge(badge_dir)` function:**
   - Generates a red "REDUCERE" badge PNG using FFmpeg lavfi: `color=c=red:s=220x80` + `drawtext=text='REDUCERE':fontsize=30:fontcolor=white:x=(w-text_w)/2:y=(h-text_h)/2`
   - Saves to `{badge_dir}/_sale_badge.png`
   - Returns the Path
   - Skip generation if file already exists (cache)
   - Use solid red (no alpha) to avoid transparency issues

2. **`_build_text_overlays(product, cta_text)` function — replace the basic version from Plan 18-01:**
   Build overlay specs list using `build_multi_drawtext`:

   Layout for portrait 1080x1920 (safe zones: avoid top 150px, bottom 200px for TikTok UI):

   a. **Product name** — y=160, fontsize=48, white text, black@0.6 box, truncate to 60 chars
   b. **Brand** — y=230, fontsize=32, white@0.85 text, black@0.5 box (skip if no brand)
   c. **Price display** — two variants:
      - When `is_on_sale=True` (product has `sale_price` and it is less than `price`):
        - Sale price: y=1650, fontsize=56, yellow text, black@0.7 box — format: `"{sale_price}"`
        - Original price in muted gray: y=1720, fontsize=32, gray text, black@0.5 box — format: `"Pret initial: {price}"` (no strikethrough — use muted style per research recommendation)
      - When not on sale:
        - Regular price: y=1650, fontsize=56, white text, black@0.7 box
   d. **CTA** — y=1820, fontsize=44, white text on red@0.85 box, centered horizontally: x='(w-text_w)/2'

   Determine `is_on_sale` from product dict: `bool(product.get('sale_price')) and float(product.get('sale_price', 0)) < float(product.get('price', 0))`

   Returns `(is_on_sale, combined_vf_string, list_of_tmp_paths)`

3. **Update `compose_product_video()` to use `filter_complex` when on-sale:**

   The function must handle two code paths:

   a. **Not on sale (no badge):** Use `-vf` with scale+pad + optional zoompan + text overlays. This is simpler and avoids filter_complex overhead.

   b. **On sale (with badge):** Use `-filter_complex` because badge PNG is a second input:
      ```
      ffmpeg -loop 1 -framerate 25 -i product.jpg -i badge.png -filter_complex "
        [0:v]scale=...pad=...,zoompan=...,{text_overlays}[vid];
        [vid][1:v]overlay=x=W-w-20:y=20[out]
      " -map [out] -t {duration} -c:v libx264 -preset veryfast -crf 20 -pix_fmt yuv420p output.mp4
      ```
      Badge positioned at top-right: `overlay=x=W-w-20:y=20`

   Key details:
   - Call `ensure_sale_badge()` only when `is_on_sale=True`
   - Badge dir: `output/product_videos/` (create if missing)
   - The text overlay string from `build_multi_drawtext` works in both `-vf` and `filter_complex` — it is a comma-separated chain of drawtext filters
   - In `filter_complex` mode, wrap the entire video processing in pad labels: chain ends with `[vid]` before badge overlay

4. **Update `CompositorConfig` to add `output_dir` field:**
   ```python
   output_dir: Path = Path("output/product_videos")
   ```
   Used for badge storage location.
  </action>
  <verify>
Test with a sale product scenario:
```bash
cd "/mnt/c/OBSID SRL/n8n/edit_factory"
python -c "
from pathlib import Path
from app.services.product_video_compositor import compose_product_video, CompositorConfig
import subprocess, os

# Create test image
subprocess.run(['ffmpeg', '-y', '-f', 'lavfi', '-i', 'color=c=white:s=800x800', '-vframes', '1', '/tmp/test_product.jpg'], capture_output=True, check=True)

# Test 1: Product WITH sale price (triggers badge overlay + filter_complex)
product_sale = {
    'title': 'Pantofi sport barbati Nike Air Max',
    'brand': 'Nike',
    'price': 599.99,
    'sale_price': 399.99,
    'raw_price_str': '599,99 RON',
    'raw_sale_price_str': '399,99 RON',
}
cfg = CompositorConfig(duration_s=15, use_zoompan=False)
compose_product_video(Path('/tmp/test_product.jpg'), Path('/tmp/test_sale.mp4'), product_sale, cfg)
size = os.path.getsize('/tmp/test_sale.mp4')
print(f'Sale video size: {size} bytes')
assert size > 10000, 'Sale video too small'

# Test 2: Product WITHOUT sale price (no badge, uses -vf)
product_regular = {
    'title': 'Tricou casual barbati',
    'brand': 'Zara',
    'price': 149.99,
    'raw_price_str': '149,99 RON',
}
compose_product_video(Path('/tmp/test_product.jpg'), Path('/tmp/test_regular.mp4'), product_regular, cfg)
size = os.path.getsize('/tmp/test_regular.mp4')
print(f'Regular video size: {size} bytes')
assert size > 10000, 'Regular video too small'

# Test 3: Verify badge PNG was created
assert Path('output/product_videos/_sale_badge.png').exists(), 'Badge not created'

print('PASS: All overlay scenarios work')
"
```
  </verify>
  <done>
Complete text overlay system works: product name, brand, price (regular and sale variants), CTA text all render on the video. Sale badge PNG overlays in the top-right corner when product is on sale. Both `-vf` (no badge) and `filter_complex` (with badge) code paths produce valid MP4 output. All text uses `textfile=` pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify composition with Romanian diacritics and multiple durations</name>
  <files>app/services/product_video_compositor.py</files>
  <action>
Run a comprehensive verification that exercises all COMP requirements:

1. **Romanian diacritics test** — Use a real Romanian product name with diacritics (ă, î, ș, ț, â):
   ```python
   product = {
       'title': 'Șosete bărbați din bumbac — Mărimea 42-44',
       'brand': 'Nortia',
       'price': 29.99,
       'sale_price': 19.99,
       'raw_price_str': '29,99 RON',
       'raw_sale_price_str': '19,99 RON',
   }
   ```
   Compose a 15s video and verify it completes without FFmpeg errors.

2. **Duration control test** — Compose videos at 15, 30, 45, 60 seconds (use `use_zoompan=False` for speed) and verify each output duration matches using `ffprobe`:
   ```bash
   ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 /tmp/test_15s.mp4
   ```
   Each should be within 1 second of the target duration.

3. **Ken Burns test** — Compose one video with `use_zoompan=True` for 15 seconds. Verify it completes and the output is valid. This confirms the zoompan pipeline end-to-end.

4. **CTA text customization test** — Compose with `cta_text="Cumpara acum pe nortia.ro!"` and verify no FFmpeg errors.

If any test fails, fix the issue in product_video_compositor.py before marking done.
  </action>
  <verify>
All 4 test categories pass:
- Romanian diacritics video produces valid MP4 with no FFmpeg stderr errors
- Duration outputs for 15/30/45/60s all within +/-1s of target
- Ken Burns (zoompan=True) 15s video completes successfully
- Custom CTA text video completes successfully

```bash
# Quick duration check
ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 /tmp/test_15s.mp4
# Should output ~15.0
```
  </verify>
  <done>
All COMP requirements verified: Ken Burns animation runs full duration (COMP-01), text overlays render with Romanian diacritics (COMP-02), sale badge appears for on-sale products (COMP-03), CTA text is configurable (COMP-04), duration control produces correct-length videos for all valid durations (COMP-06).
  </done>
</task>

</tasks>

<verification>
1. Product videos render with all text overlays (name, brand, price, sale price, CTA)
2. Sale badge appears on sale products, absent on regular products
3. Romanian diacritics render correctly in all text overlays
4. Duration control works for 15/30/45/60 seconds
5. Both zoompan (Ken Burns) and simple-scale code paths work
6. All text overlays use textfile= pattern (grep for `text=` in filter strings should find none)
</verification>

<success_criteria>
- All 5 success criteria from ROADMAP Phase 18 are met
- COMP-01: Ken Burns zoom/pan animation works
- COMP-02: Product name, price, sale price, brand display correctly
- COMP-03: Sale badge overlay appears for on-sale products
- COMP-04: CTA text overlay is configurable and renders correctly
- COMP-06: Duration control produces correct-length videos
</success_criteria>

<output>
After completion, create `.planning/phases/18-video-composition/18-02-SUMMARY.md`
</output>
