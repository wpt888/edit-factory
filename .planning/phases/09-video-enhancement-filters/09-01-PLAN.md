---
phase: 09-video-enhancement-filters
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/video_filters.py
  - app/services/encoding_presets.py
autonomous: true

must_haves:
  truths:
    - "VideoFilters dataclass exists with DenoiseConfig, SharpenConfig, ColorConfig"
    - "Filter chain builds in correct order: denoise -> sharpen -> color"
    - "EncodingPreset has video_filters field (default: all disabled)"
  artifacts:
    - path: "app/services/video_filters.py"
      provides: "Filter configuration dataclasses with validation and FFmpeg string generation"
      contains: "class VideoFilters"
    - path: "app/services/encoding_presets.py"
      provides: "EncodingPreset with VideoFilters integration"
      contains: "video_filters"
  key_links:
    - from: "app/services/video_filters.py"
      to: "app/services/encoding_presets.py"
      via: "VideoFilters import"
      pattern: "from app.services.video_filters import"
---

<objective>
Create video enhancement filter configuration service with dataclasses for denoise, sharpen, and color correction settings.

Purpose: Establish typed filter configuration that validates parameters and generates FFmpeg filter strings. This foundation enables the render pipeline to apply optional video quality enhancement.

Output: New video_filters.py service + updated encoding_presets.py with VideoFilters field
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-video-enhancement-filters/09-RESEARCH.md

# Existing patterns
@app/services/encoding_presets.py
@app/services/audio_normalizer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video_filters.py service</name>
  <files>app/services/video_filters.py</files>
  <action>
Create new service file with three filter configuration dataclasses plus a VideoFilters orchestrator:

1. **DenoiseConfig** (hqdn3d filter):
   - `enabled: bool = False`
   - `luma_spatial: float = 2.0` (range 0-10, conservative default lower than FFmpeg's 4.0)
   - Auto-derive chroma_spatial (luma * 0.75), luma_temporal (luma * 1.5), chroma_temporal
   - `validate()` method for range checking
   - `to_filter_string()` returns "hqdn3d=2.0:1.5:3.0:2.25" or None if disabled

2. **SharpenConfig** (unsharp filter):
   - `enabled: bool = False`
   - `luma_amount: float = 0.5` (range -2 to 5, conservative default)
   - `matrix_size: int = 5` (odd, range 3-23)
   - `chroma_amount: float = 0.0` LOCKED at zero (never sharpen chroma - prevents color artifacts)
   - `to_filter_string()` returns "unsharp=5:5:0.5:5:5:0.0" or None if disabled

3. **ColorConfig** (eq filter):
   - `enabled: bool = False`
   - `brightness: float = 0.0` (range -1 to 1)
   - `contrast: float = 1.0` (range 0-3, 1.0 = no change)
   - `saturation: float = 1.0` (range 0-3, 1.0 = no change)
   - `to_filter_string()` only includes non-default params, returns "eq=brightness=0.05:contrast=1.1" or None

4. **VideoFilters** (orchestrator):
   - `denoise: DenoiseConfig`
   - `sharpen: SharpenConfig`
   - `color: ColorConfig`
   - `build_filter_chain() -> list[str]` returns ordered list: denoise -> sharpen -> color (empty strings filtered)
   - `has_any_enabled() -> bool`
   - `estimate_performance_impact() -> str` returns "None", "Low (<10%)", "Medium (10-20%)", "High (>20%)"

Use `@dataclass` from stdlib (not Pydantic) for simplicity. Add logging for enabled filters.

Reference: 09-RESEARCH.md "Code Examples" section for complete implementation patterns.
  </action>
  <verify>
Run: `cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "from app.services.video_filters import VideoFilters, DenoiseConfig, SharpenConfig, ColorConfig; vf = VideoFilters(); vf.denoise.enabled = True; vf.sharpen.enabled = True; print(vf.build_filter_chain())"`
Expected: List with denoise filter first, then sharpen filter (correct order)
  </verify>
  <done>
video_filters.py exists with all four classes, imports work, build_filter_chain returns ordered list
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend EncodingPreset with VideoFilters</name>
  <files>app/services/encoding_presets.py</files>
  <action>
Update encoding_presets.py to include VideoFilters field:

1. Add import at top: `from app.services.video_filters import VideoFilters`

2. Add field to EncodingPreset class (after audio normalization fields):
   ```python
   # Video enhancement filters (Phase 9)
   video_filters: VideoFilters = Field(default_factory=VideoFilters)
   ```

3. All existing presets (PRESET_TIKTOK, PRESET_REELS, PRESET_YOUTUBE_SHORTS, PRESET_GENERIC) automatically get `video_filters=VideoFilters()` which defaults to all filters disabled.

4. Update list_presets() to include video_filters info:
   ```python
   "video_filters_enabled": preset.video_filters.has_any_enabled()
   ```

No changes to to_ffmpeg_params() - filter application happens in _render_with_preset().
  </action>
  <verify>
Run: `cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "from app.services.encoding_presets import get_preset; p = get_preset('tiktok'); print(f'Preset: {p.name}, Filters enabled: {p.video_filters.has_any_enabled()}')"`
Expected: "Preset: TikTok, Filters enabled: False"
  </verify>
  <done>
EncodingPreset has video_filters field, all presets have default VideoFilters (disabled), imports work without circular dependency
  </done>
</task>

</tasks>

<verification>
1. Import check: `python -c "from app.services.video_filters import VideoFilters; from app.services.encoding_presets import get_preset"`
2. Filter chain order: VideoFilters with denoise+sharpen+color enabled returns list in correct order (denoise first)
3. Disabled by default: All presets have video_filters.has_any_enabled() == False
4. Filter strings valid: Each filter config produces valid FFmpeg filter syntax
</verification>

<success_criteria>
- video_filters.py exists with DenoiseConfig, SharpenConfig, ColorConfig, VideoFilters
- EncodingPreset has video_filters field with default VideoFilters()
- build_filter_chain() returns filters in denoise -> sharpen -> color order
- All existing presets work unchanged (video_filters defaults to disabled)
- No import errors or circular dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/09-video-enhancement-filters/09-01-SUMMARY.md`
</output>
