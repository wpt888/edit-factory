---
phase: 09-video-enhancement-filters
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - app/api/library_routes.py
autonomous: true

must_haves:
  truths:
    - "User can pass enable_denoise, denoise_strength parameters to render endpoint"
    - "User can pass enable_sharpen, sharpen_amount parameters to render endpoint"
    - "User can pass enable_color, brightness, contrast, saturation parameters to render endpoint"
    - "Filters applied in correct order: denoise -> sharpen -> color (before subtitles)"
    - "Filter processing skipped when all filters disabled (no overhead)"
  artifacts:
    - path: "app/api/library_routes.py"
      provides: "Render endpoint with filter parameter support and pipeline integration"
      contains: "enable_denoise"
  key_links:
    - from: "app/api/library_routes.py"
      to: "app/services/video_filters.py"
      via: "VideoFilters import and filter chain building"
      pattern: "from app.services.video_filters import"
    - from: "_render_with_preset"
      to: "hqdn3d|unsharp|eq"
      via: "FFmpeg -vf filter chain"
      pattern: "hqdn3d=|unsharp=|eq="
---

<objective>
Integrate video enhancement filters into the render pipeline, adding filter parameters to the render endpoint and modifying _render_with_preset() to apply the filter chain.

Purpose: Enable backend to accept filter configuration from frontend and apply optional denoise/sharpen/color correction during video rendering.

Output: Modified library_routes.py with filter-aware rendering
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-video-enhancement-filters/09-RESEARCH.md
@.planning/phases/09-video-enhancement-filters/09-01-SUMMARY.md

# Implementation targets
@app/api/library_routes.py
@app/services/video_filters.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter parameters to render endpoint</name>
  <files>app/api/library_routes.py</files>
  <action>
Modify the render endpoint (find the endpoint that calls _render_with_preset, likely `/library/projects/{project_id}/clips/{clip_id}/render`) to accept filter parameters as Form data:

1. Add import at top:
   ```python
   from app.services.video_filters import VideoFilters, DenoiseConfig, SharpenConfig, ColorConfig
   ```

2. Add new Form parameters to the render endpoint function signature:
   ```python
   # Video enhancement filters (Phase 9)
   enable_denoise: str = Form(default="false"),
   denoise_strength: float = Form(default=2.0),
   enable_sharpen: str = Form(default="false"),
   sharpen_amount: float = Form(default=0.5),
   enable_color: str = Form(default="false"),
   brightness: float = Form(default=0.0),
   contrast: float = Form(default=1.0),
   saturation: float = Form(default=1.0),
   ```

3. Parse boolean strings (HTML forms send strings):
   ```python
   enable_denoise_bool = enable_denoise.lower() in ("true", "1", "yes", "on")
   enable_sharpen_bool = enable_sharpen.lower() in ("true", "1", "yes", "on")
   enable_color_bool = enable_color.lower() in ("true", "1", "yes", "on")
   ```

4. Pass filter parameters to _render_with_preset() call:
   ```python
   _render_with_preset(
       video_path=...,
       audio_path=...,
       srt_path=...,
       subtitle_settings=...,
       preset=...,
       output_path=...,
       # Video enhancement filters
       enable_denoise=enable_denoise_bool,
       denoise_strength=denoise_strength,
       enable_sharpen=enable_sharpen_bool,
       sharpen_amount=sharpen_amount,
       enable_color=enable_color_bool,
       brightness=brightness,
       contrast=contrast,
       saturation=saturation,
   )
   ```

Note: Forms send strings, so use str type with Form() and parse to bool manually. Float parameters work directly.
  </action>
  <verify>
Check file has new Form parameters: `grep -n "enable_denoise" app/api/library_routes.py`
Expected: Multiple lines showing Form parameter definition and usage
  </verify>
  <done>
Render endpoint accepts enable_denoise, denoise_strength, enable_sharpen, sharpen_amount, enable_color, brightness, contrast, saturation parameters
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate filters into _render_with_preset()</name>
  <files>app/api/library_routes.py</files>
  <action>
Update _render_with_preset() function to apply video enhancement filters:

1. Add new parameters to function signature:
   ```python
   def _render_with_preset(
       video_path: Path,
       audio_path: Optional[Path],
       srt_path: Optional[Path],
       subtitle_settings: Optional[dict],
       preset: dict,
       output_path: Path,
       # Video enhancement filters (Phase 9)
       enable_denoise: bool = False,
       denoise_strength: float = 2.0,
       enable_sharpen: bool = False,
       sharpen_amount: float = 0.5,
       enable_color: bool = False,
       brightness: float = 0.0,
       contrast: float = 1.0,
       saturation: float = 1.0,
   ):
   ```

2. After scale/crop filters (around line 2347-2348) and BEFORE subtitles filter, add enhancement filters:
   ```python
   # Scale to fill portrait frame
   filters.append(f"scale={preset['width']}:{preset['height']}:force_original_aspect_ratio=increase")
   filters.append(f"crop={preset['width']}:{preset['height']}")

   # Video enhancement filters (Phase 9) - apply AFTER scale/crop, BEFORE subtitles
   # Order: denoise -> sharpen -> color (critical - don't sharpen noise)
   if enable_denoise:
       # hqdn3d filter: luma_spatial:chroma_spatial:luma_temporal:chroma_temporal
       chroma_spatial = denoise_strength * 0.75
       luma_temporal = denoise_strength * 1.5
       chroma_temporal = chroma_spatial * 1.5
       filters.append(f"hqdn3d={denoise_strength:.1f}:{chroma_spatial:.1f}:{luma_temporal:.1f}:{chroma_temporal:.1f}")
       logger.info(f"Applying denoise filter: luma_spatial={denoise_strength}")

   if enable_sharpen:
       # unsharp filter: luma_msize_x:luma_msize_y:luma_amount:chroma_msize_x:chroma_msize_y:chroma_amount
       # NEVER sharpen chroma (chroma_amount=0.0) - prevents color artifacts
       matrix_size = 5  # Standard 5x5 kernel
       filters.append(f"unsharp={matrix_size}:{matrix_size}:{sharpen_amount:.2f}:{matrix_size}:{matrix_size}:0.0")
       logger.info(f"Applying sharpen filter: luma_amount={sharpen_amount}")

   if enable_color:
       # eq filter: only include non-default parameters
       color_params = []
       if abs(brightness) > 0.001:
           color_params.append(f"brightness={brightness:.2f}")
       if abs(contrast - 1.0) > 0.001:
           color_params.append(f"contrast={contrast:.2f}")
       if abs(saturation - 1.0) > 0.001:
           color_params.append(f"saturation={saturation:.2f}")

       if color_params:
           filters.append(f"eq={':'.join(color_params)}")
           logger.info(f"Applying color correction: {', '.join(color_params)}")

   # Subtitles (existing code - must be AFTER enhancement filters)
   if srt_path and srt_path.exists() and subtitle_settings:
       # ... existing subtitle code ...
   ```

Key points:
- Insert enhancement filters AFTER scale/crop
- Insert enhancement filters BEFORE subtitles (don't sharpen burned-in text)
- Filter order is locked: denoise -> sharpen -> color (don't allow user to reorder)
- chroma_amount=0.0 for sharpen (never sharpen chroma channel)
- Only add eq parameters that differ from defaults (efficiency)
  </action>
  <verify>
Run a test render with filters enabled via API or check code structure:
`grep -A5 "Video enhancement filters" app/api/library_routes.py`
Expected: Shows filter insertion code with hqdn3d, unsharp, eq filters in correct order
  </verify>
  <done>
_render_with_preset() applies denoise, sharpen, color filters in correct order (after scale/crop, before subtitles), logs enabled filters
  </done>
</task>

</tasks>

<verification>
1. Endpoint accepts filter params: `grep "enable_denoise.*Form" app/api/library_routes.py` shows parameter definition
2. Filter order correct: Enhancement filters appear after scale/crop, before subtitles in code
3. No overhead when disabled: Filters only added to filter chain when enabled (conditional append)
4. Chroma protected: Sharpen filter uses chroma_amount=0.0 (grep for "0.0" in unsharp line)
5. Logging present: Logger.info calls for each enabled filter type
</verification>

<success_criteria>
- Render endpoint accepts 8 new filter parameters (enable_denoise, denoise_strength, enable_sharpen, sharpen_amount, enable_color, brightness, contrast, saturation)
- _render_with_preset() inserts filters in order: scale/crop -> denoise -> sharpen -> color -> subtitles
- Filters only applied when enabled (no overhead for disabled filters)
- Sharpen filter never touches chroma channel (chroma_amount=0.0)
- Filter application logged for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/09-video-enhancement-filters/09-02-SUMMARY.md`
</output>
