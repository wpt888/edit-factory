---
phase: 02-backend-profile-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/auth.py
  - app/api/profile_routes.py
  - app/main.py
autonomous: true

must_haves:
  truths:
    - "API returns list of user's profiles when GET /api/v1/profiles called"
    - "API creates new profile when POST /api/v1/profiles called with name"
    - "API returns 400 when trying to delete default profile"
    - "Routes with get_profile_context auto-select default profile when X-Profile-Id header missing"
    - "Routes return 404 when X-Profile-Id is invalid UUID"
    - "Routes return 403 when X-Profile-Id belongs to different user"
  artifacts:
    - path: "app/api/auth.py"
      provides: "ProfileContext class and get_profile_context dependency"
      contains: "class ProfileContext"
    - path: "app/api/profile_routes.py"
      provides: "Profile CRUD endpoints"
      exports: ["router"]
    - path: "app/main.py"
      provides: "Profile router registration"
      contains: "profile_routes"
  key_links:
    - from: "app/api/profile_routes.py"
      to: "profiles table"
      via: "Supabase client"
      pattern: 'supabase\.table\("profiles"\)'
    - from: "app/api/auth.py"
      to: "profiles table"
      via: "get_profile_context queries"
      pattern: 'supabase\.table\("profiles"\)'
---

<objective>
Create Profile CRUD API endpoints and the get_profile_context dependency for profile-aware route validation.

Purpose: This foundational plan establishes the profile management API and the reusable dependency that all other routes will use to validate X-Profile-Id headers. Without this, no route can be made profile-aware.

Output: Working /api/v1/profiles endpoints (CRUD), ProfileContext class, and get_profile_context() dependency ready for use in other routes.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-backend-profile-context/02-CONTEXT.md
@.planning/phases/02-backend-profile-context/02-RESEARCH.md
@.planning/phases/01-database-foundation/01-01-SUMMARY.md

# Source files to modify
@app/api/auth.py
@app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ProfileContext and get_profile_context to auth.py</name>
  <files>app/api/auth.py</files>
  <action>
Add ProfileContext dataclass and get_profile_context dependency to auth.py following the existing get_current_user pattern.

1. Add imports at top:
   - `from dataclasses import dataclass`
   - `from typing import Optional`
   - `from fastapi import Header`

2. Create ProfileContext class after AuthUser:
```python
@dataclass
class ProfileContext:
    """Profile context for request."""
    profile_id: str
    user_id: str
```

3. Add Supabase client getter (similar to library_routes.py pattern):
```python
_supabase_client = None

def _get_supabase():
    """Get Supabase client for auth queries."""
    global _supabase_client
    if _supabase_client is None:
        try:
            from supabase import create_client
            settings = get_settings()
            if settings.supabase_url and settings.supabase_key:
                _supabase_client = create_client(settings.supabase_url, settings.supabase_key)
        except Exception as e:
            logger.error(f"Failed to init Supabase in auth: {e}")
    return _supabase_client
```

4. Create get_profile_context dependency:
```python
async def get_profile_context(
    current_user: AuthUser = Depends(get_current_user),
    x_profile_id: Optional[str] = Header(None, alias="X-Profile-Id")
) -> ProfileContext:
    """
    Extract and validate profile context from request.

    - Missing X-Profile-Id: Auto-select user's default profile
    - Invalid profile_id: 404 Not Found
    - Profile belongs to different user: 403 Forbidden
    """
    supabase = _get_supabase()
    if not supabase:
        raise HTTPException(status_code=503, detail="Database not available")

    if not x_profile_id:
        # Auto-select default profile
        result = supabase.table("profiles")\
            .select("id")\
            .eq("user_id", current_user.id)\
            .eq("is_default", True)\
            .single()\
            .execute()

        if not result.data:
            raise HTTPException(
                status_code=500,
                detail="No default profile found. Contact support."
            )

        profile_id = result.data["id"]
        logger.info(f"[Profile {profile_id}] Auto-selected default for user {current_user.id}")
    else:
        profile_id = x_profile_id

        # Validate profile exists
        result = supabase.table("profiles")\
            .select("id, user_id")\
            .eq("id", profile_id)\
            .single()\
            .execute()

        if not result.data:
            raise HTTPException(status_code=404, detail="Profile not found")

        # Check ownership
        if result.data["user_id"] != current_user.id:
            raise HTTPException(status_code=403, detail="Access denied to this profile")

    return ProfileContext(profile_id=profile_id, user_id=current_user.id)
```

IMPORTANT: Follow the existing code style - use double quotes, same logging patterns, same error handling structure.
  </action>
  <verify>
Run: `python -c "from app.api.auth import ProfileContext, get_profile_context; print('OK')"` returns OK
  </verify>
  <done>
ProfileContext class importable, get_profile_context dependency exists with proper validation logic for missing/invalid/foreign profiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create profile_routes.py with CRUD endpoints</name>
  <files>app/api/profile_routes.py</files>
  <action>
Create new file app/api/profile_routes.py with Profile CRUD endpoints.

Follow the existing route file patterns from library_routes.py:
- APIRouter with prefix and tags
- Pydantic models for request/response
- Supabase client singleton pattern
- Proper error handling with HTTPException

Endpoints to create:

1. **GET /profiles** - List user's profiles
   - Depends on get_current_user (not get_profile_context - listing profiles doesn't require selecting one)
   - Returns all profiles for current user
   - Response: List of profile objects with id, name, description, is_default, created_at

2. **POST /profiles** - Create new profile
   - Depends on get_current_user
   - Request body: ProfileCreate(name: str, description: Optional[str])
   - New profiles have is_default=False
   - Returns created profile

3. **GET /profiles/{profile_id}** - Get single profile
   - Depends on get_current_user
   - Validates ownership (404 if not found, 403 if foreign)
   - Returns full profile object

4. **PUT /profiles/{profile_id}** - Update profile
   - Depends on get_current_user
   - Request body: ProfileUpdate(name: Optional[str], description: Optional[str])
   - Validates ownership
   - Returns updated profile

5. **DELETE /profiles/{profile_id}** - Delete profile
   - Depends on get_current_user
   - CANNOT delete if is_default=True (return 400)
   - CASCADE delete handled by database FK
   - Returns { "status": "deleted", "profile_id": ... }

6. **POST /profiles/{profile_id}/set-default** - Set profile as default
   - Depends on get_current_user
   - Validates ownership
   - Sets is_default=True on this profile
   - Sets is_default=False on user's other profiles
   - Returns updated profile

Pydantic models:
```python
class ProfileCreate(BaseModel):
    name: str
    description: Optional[str] = None

class ProfileUpdate(BaseModel):
    name: Optional[str] = None
    description: Optional[str] = None

class ProfileResponse(BaseModel):
    id: str
    name: str
    description: Optional[str]
    is_default: bool
    created_at: str
    updated_at: str
```

Use the same Supabase client pattern as library_routes.py (_supabase_client singleton with get_supabase() function).

Add logging with profile_id context: `logger.info(f"[Profile {profile_id}] Action performed")`
  </action>
  <verify>
Run: `python -c "from app.api.profile_routes import router; print(f'Routes: {len(router.routes)}')"` shows 6+ routes
  </verify>
  <done>
profile_routes.py exists with all 6 CRUD endpoints, proper validation, default profile protection, and logging.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register profile router in main.py</name>
  <files>app/main.py</files>
  <action>
Register the profile_routes router in app/main.py alongside existing routers.

1. Add import near other router imports:
```python
from app.api.profile_routes import router as profile_router
```

2. Include router with prefix near other router includes:
```python
app.include_router(profile_router, prefix="/api/v1")
```

The profile routes will be accessible at /api/v1/profiles/*.
  </action>
  <verify>
Run: `cd "/mnt/c/OBSID SRL/n8n/edit_factory" && python -c "from app.main import app; routes = [r.path for r in app.routes if '/profiles' in str(r.path)]; print(f'Profile routes: {routes}')"` shows profile routes registered
  </verify>
  <done>
Profile router registered in FastAPI app, endpoints accessible at /api/v1/profiles/*.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Import check:**
   ```bash
   python -c "from app.api.auth import ProfileContext, get_profile_context; from app.api.profile_routes import router; print('All imports OK')"
   ```

2. **Route registration check:**
   ```bash
   python -c "from app.main import app; print([r.path for r in app.routes if 'profile' in str(r.path).lower()])"
   ```

3. **Manual API test (if server running):**
   - GET /api/v1/profiles should return 401 (auth required) or profiles list with valid token
</verification>

<success_criteria>
- ProfileContext class exists in auth.py
- get_profile_context dependency validates X-Profile-Id header correctly
- Profile CRUD endpoints exist at /api/v1/profiles/*
- Default profile deletion returns 400 error
- Profile ownership validation returns 403 for foreign profiles
</success_criteria>

<output>
After completion, create `.planning/phases/02-backend-profile-context/02-01-SUMMARY.md`
</output>
