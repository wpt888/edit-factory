---
phase: 02-backend-profile-context
plan: 05
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/api/library_routes.py
  - app/api/routes.py
autonomous: true

must_haves:
  truths:
    - "FFmpeg temp files for one profile's job don't interfere with another profile's job"
    - "Temp directory cleanup for one profile doesn't delete another profile's in-progress files"
    - "Concurrent video processing for multiple profiles works without file conflicts"
  artifacts:
    - path: "app/api/library_routes.py"
      provides: "Profile-scoped temp directory creation"
      contains: "temp.*profile"
    - path: "app/api/routes.py"
      provides: "Profile-scoped temp directory creation"
      contains: "temp.*profile"
  key_links:
    - from: "library_routes.py temp_dir creation"
      to: "VideoProcessorService"
      via: "temp_dir parameter"
      pattern: 'temp_dir.*=.*profile'
---

<objective>
Update FFmpeg temporary directory paths to be profile-scoped, preventing cross-profile file interference.

Purpose: When multiple profiles run video processing concurrently, temp files (segment clips, concat lists, TTS audio) must not collide. Profile-scoped temp directories ensure isolation: `temp/{profile_id}/...` instead of flat `temp/...`.

Output: All VideoProcessorService instantiations and direct temp file operations use profile-scoped directories.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-backend-profile-context/02-CONTEXT.md
@.planning/phases/02-backend-profile-context/02-01-SUMMARY.md

# Source files to modify
@app/api/library_routes.py
@app/api/routes.py
@app/services/video_processor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update library_routes.py temp directories to be profile-scoped</name>
  <files>app/api/library_routes.py</files>
  <action>
Update all temp directory paths in library_routes.py to include profile_id for isolation.

**1. Find all VideoProcessorService instantiations and update temp_dir:**

Current pattern (in _generate_raw_clips_task and similar):
```python
processor = VideoProcessorService(
    input_dir=settings.base_dir / "uploads",
    output_dir=settings.base_dir / "output",
    temp_dir=settings.base_dir / "temp"  # FLAT - collision risk
)
```

Change to:
```python
processor = VideoProcessorService(
    input_dir=settings.base_dir / "uploads",
    output_dir=settings.base_dir / "output",
    temp_dir=settings.base_dir / "temp" / profile_id  # SCOPED by profile
)
```

**2. Find all direct temp_dir usages and scope them:**

Search for patterns like:
- `temp_dir = settings.base_dir / "temp"`
- `audio_path = temp_dir / f"tts_{...}.mp3"`
- `srt_path = temp_dir / f"srt_{...}.srt"`

In _render_final_clip_task:
```python
# BEFORE
temp_dir = settings.base_dir / "temp"
audio_path = temp_dir / f"tts_{clip_id}.mp3"

# AFTER
temp_dir = settings.base_dir / "temp" / profile_id
temp_dir.mkdir(parents=True, exist_ok=True)
audio_path = temp_dir / f"tts_{clip_id}.mp3"
```

**3. Update extend_project_clips function:**

Current:
```python
temp_dir = settings.base_dir / "temp" / f"extend_{project_id[:8]}"
```

Change to include profile:
```python
temp_dir = settings.base_dir / "temp" / profile_id / f"extend_{project_id[:8]}"
```

**4. Update cleanup_temp_files route if exists:**

If there's a cleanup route, ensure it only cleans the current profile's temp dir:
```python
temp_dir = settings.base_dir / "temp" / profile.profile_id
# Only clean files in this profile's temp dir
```

**5. Ensure mkdir is called before use:**

Every temp_dir assignment should be followed by:
```python
temp_dir.mkdir(parents=True, exist_ok=True)
```

**LOCATIONS TO UPDATE (search for these patterns):**
- Line ~444: VideoProcessorService instantiation in _generate_raw_clips_task
- Line ~1622: temp_dir in _render_final_clip_task
- Line ~2080: temp_dir in extend function
- Line ~2159: cleanup_temp_files route
- Any other `settings.base_dir / "temp"` occurrences
  </action>
  <verify>
Run:
```bash
# Check that temp directories include profile_id
grep -n 'temp.*profile_id\|temp.*profile\.profile_id' app/api/library_routes.py | head -10

# Ensure no flat temp dirs remain (except in cleanup which should filter by profile)
grep -n 'settings.base_dir / "temp"' app/api/library_routes.py | grep -v profile
```
The second command should return empty or only show cleanup route with profile filter.
  </verify>
  <done>
All temp directory paths in library_routes.py are scoped to profile_id, preventing cross-profile file collisions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update routes.py temp directories to be profile-scoped</name>
  <files>app/api/routes.py</files>
  <action>
Update all temp directory paths in routes.py to include profile_id for isolation.

**1. Update get_processor() function or its callers:**

If get_processor() is called with fixed temp_dir, update callers to pass profile-scoped path:
```python
# In background task that has profile_id:
processor = VideoProcessorService(
    input_dir=settings.base_dir / "uploads",
    output_dir=settings.base_dir / "output",
    temp_dir=settings.base_dir / "temp" / profile_id
)
```

**2. Find all direct temp_dir usages:**

Search for:
- `temp_dir = settings.base_dir / "temp"`
- `audio_path = temp_dir / ...`

In TTS generation routes/tasks:
```python
# BEFORE
temp_dir = settings.base_dir / "temp"
audio_path = temp_dir / f"tts_{job_id}.mp3"

# AFTER
temp_dir = settings.base_dir / "temp" / profile_id
temp_dir.mkdir(parents=True, exist_ok=True)
audio_path = temp_dir / f"tts_{job_id}.mp3"
```

**3. Background tasks that need profile_id for temp dirs:**

- process_job
- process_tts_job
- process_multi_video_job
- Any task that creates temp files

Each should use:
```python
temp_dir = settings.base_dir / "temp" / profile_id
temp_dir.mkdir(parents=True, exist_ok=True)
```

**LOCATIONS TO UPDATE (approximate line numbers from grep):**
- Line ~41: get_processor() temp_dir (may need to parameterize)
- Line ~1266-1268: TTS temp file creation
- Any VideoProcessorService instantiation

**NOTE:** If get_processor() is a singleton, consider making temp_dir a parameter passed to individual methods instead, OR create processor instances per-call with profile-scoped temp_dir.
  </action>
  <verify>
Run:
```bash
# Check that temp directories include profile_id
grep -n 'temp.*profile_id' app/api/routes.py | head -10

# Ensure no flat temp dirs remain in job processing code
grep -n 'settings.base_dir / "temp"' app/api/routes.py | grep -v profile
```
  </verify>
  <done>
All temp directory paths in routes.py are scoped to profile_id, preventing cross-profile file collisions during video processing.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Profile-scoped temp dirs in library_routes.py:**
   ```bash
   grep -c 'temp.*profile' app/api/library_routes.py
   ```
   Should show multiple occurrences

2. **Profile-scoped temp dirs in routes.py:**
   ```bash
   grep -c 'temp.*profile' app/api/routes.py
   ```
   Should show occurrences

3. **No remaining flat temp dirs in processing code:**
   ```bash
   grep 'base_dir / "temp"' app/api/library_routes.py app/api/routes.py | grep -v profile | grep -v "#"
   ```
   Should return empty (all temp dirs are profile-scoped)

4. **Syntax check:**
   ```bash
   python -c "from app.api.library_routes import router; from app.api.routes import router as r2; print('OK')"
   ```
</verification>

<success_criteria>
- All VideoProcessorService instantiations use `temp_dir=.../{profile_id}`
- All direct temp file operations (TTS audio, SRT files) use profile-scoped paths
- temp_dir.mkdir(parents=True, exist_ok=True) is called before file operations
- Cleanup operations only affect the current profile's temp directory
- No flat `temp/` usage remains in video processing code paths
</success_criteria>

<output>
After completion, create `.planning/phases/02-backend-profile-context/02-05-SUMMARY.md`
</output>
