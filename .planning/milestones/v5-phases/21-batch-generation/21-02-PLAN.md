---
phase: 21-batch-generation
plan: 02
type: execute
wave: 2
depends_on:
  - "21-01"
files_modified:
  - frontend/src/app/products/page.tsx
  - frontend/src/hooks/use-batch-polling.ts
  - frontend/src/app/batch-generate/page.tsx
autonomous: false
requirements:
  - BATCH-02
  - BATCH-04

must_haves:
  truths:
    - "User can toggle checkboxes on product cards to select multiple products"
    - "A sticky action bar appears at the bottom when products are selected showing count and a Generate Videos button"
    - "Clicking Generate Videos dispatches POST /products/batch-generate and redirects to /batch-generate?batch_id=..."
    - "The batch-generate page shows a per-product progress card for each product with independent status (queued/processing/done/failed)"
    - "User can navigate away from batch-generate page and return to see current progress (batch_id is in URL, state is in Supabase)"
    - "A Retry Failed button appears when some products have failed status, dispatching a new batch with only failed product IDs"
  artifacts:
    - path: "frontend/src/app/products/page.tsx"
      provides: "Multi-select checkboxes on product cards + sticky action bar with Generate Videos button"
      contains: "selectedProductIds"
    - path: "frontend/src/hooks/use-batch-polling.ts"
      provides: "useBatchPolling hook that polls GET /products/batch/{batchId}/status and returns per-product states"
      contains: "useBatchPolling"
    - path: "frontend/src/app/batch-generate/page.tsx"
      provides: "Batch generation progress page with per-product card grid and retry-failed button"
      contains: "BatchGeneratePage"
  key_links:
    - from: "frontend/src/app/products/page.tsx"
      to: "/api/v1/products/batch-generate"
      via: "apiPost on Generate Videos click"
      pattern: "batch-generate"
    - from: "frontend/src/app/batch-generate/page.tsx"
      to: "frontend/src/hooks/use-batch-polling.ts"
      via: "useBatchPolling hook for polling batch status"
      pattern: "useBatchPolling"
    - from: "frontend/src/hooks/use-batch-polling.ts"
      to: "/api/v1/products/batch/{batchId}/status"
      via: "fetch polling at 2s interval"
      pattern: "batch.*status"
---

<objective>
Add batch generation frontend: multi-select checkboxes on product cards with a sticky action bar, a batch progress page with per-product status cards, and a useBatchPolling hook.

Purpose: Enable users to select multiple products and generate batch videos (BATCH-02) with per-product progress visibility (BATCH-04).
Output: Modified products/page.tsx, new use-batch-polling.ts hook, new batch-generate/page.tsx.
</objective>

<execution_context>
@/home/ukfdb/.claude/get-shit-done/workflows/execute-plan.md
@/home/ukfdb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-batch-generation/21-RESEARCH.md
@.planning/phases/21-batch-generation/21-01-SUMMARY.md
@frontend/src/app/products/page.tsx
@frontend/src/hooks/use-job-polling.ts
@frontend/src/app/product-video/page.tsx
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-select and sticky action bar to products page + create useBatchPolling hook</name>
  <files>frontend/src/app/products/page.tsx, frontend/src/hooks/use-batch-polling.ts</files>
  <action>
**A) Modify products/page.tsx to add multi-select:**

1. Add state:
   ```typescript
   const [selectedProductIds, setSelectedProductIds] = useState<Set<string>>(new Set());
   ```

2. Add toggle function:
   ```typescript
   const toggleProductSelection = (productId: string) => {
     setSelectedProductIds(prev => {
       const next = new Set(prev);
       if (next.has(productId)) next.delete(productId);
       else next.add(productId);
       return next;
     });
   };
   ```

3. Add select-all-on-page / clear-all functions:
   ```typescript
   const selectAllOnPage = () => {
     setSelectedProductIds(new Set(products.map(p => p.id)));
   };
   const clearSelection = () => {
     setSelectedProductIds(new Set());
   };
   ```

4. Add Checkbox to each product card — positioned `absolute top-2 left-2` with z-10. Import Checkbox from `@/components/ui/checkbox`. Use `onClick={(e) => e.stopPropagation()}` to prevent card interactions. Show checkbox always (not just on hover — mobile needs it).

5. Add `pb-24` to the product grid container when `selectedProductIds.size > 0` to prevent the sticky bar from covering the last row.

6. Add sticky action bar at the bottom of the page (after pagination, inside the main container):
   ```tsx
   {selectedProductIds.size > 0 && (
     <div className="fixed bottom-0 left-0 right-0 bg-card border-t shadow-lg z-50 p-4">
       <div className="max-w-7xl mx-auto flex items-center justify-between">
         <div className="flex items-center gap-3">
           <span className="font-medium">{selectedProductIds.size} selected</span>
           <Button variant="ghost" size="sm" onClick={selectAllOnPage}>Select all on page</Button>
           <Button variant="ghost" size="sm" onClick={clearSelection}>Clear</Button>
         </div>
         <Button onClick={handleBatchGenerate} disabled={batchLoading}>
           {batchLoading ? <Loader2 className="h-4 w-4 mr-2 animate-spin" /> : <Film className="h-4 w-4 mr-2" />}
           Generate {selectedProductIds.size} Videos
         </Button>
       </div>
     </div>
   )}
   ```

7. Add handleBatchGenerate function:
   ```typescript
   const [batchLoading, setBatchLoading] = useState(false);
   const handleBatchGenerate = async () => {
     setBatchLoading(true);
     try {
       const res = await apiPost("/products/batch-generate", {
         product_ids: Array.from(selectedProductIds),
         voiceover_mode: "quick",
         tts_provider: "edge",
         duration_s: 30,
         encoding_preset: "tiktok",
       });
       if (res.ok) {
         const data = await res.json();
         router.push(`/batch-generate?batch_id=${data.batch_id}`);
       } else {
         const err = await res.json().catch(() => ({ detail: "Batch generation failed" }));
         toast.error(err.detail || "Batch generation failed");
       }
     } catch {
       toast.error("Network error starting batch generation");
     } finally {
       setBatchLoading(false);
     }
   };
   ```

8. Import Checkbox: `import { Checkbox } from "@/components/ui/checkbox";`

**B) Create use-batch-polling.ts hook:**

Create `frontend/src/hooks/use-batch-polling.ts` — modeled after use-job-polling.ts:

```typescript
"use client";
import { useState, useCallback, useRef, useEffect } from "react";

interface ProductJobStatus {
  product_id: string;
  job_id: string;
  title: string;
  status: "queued" | "processing" | "completed" | "failed";
  progress: string;
  error: string | null;
  result: Record<string, unknown> | null;
}

interface BatchStatus {
  batch_id: string;
  status: "processing" | "completed";
  total: number;
  completed: number;
  failed: number;
  product_jobs: ProductJobStatus[];
}

interface UseBatchPollingOptions {
  apiBaseUrl: string;
  interval?: number;
  onBatchComplete?: (batchStatus: BatchStatus) => void;
}

interface UseBatchPollingReturn {
  startPolling: (batchId: string) => void;
  stopPolling: () => void;
  isPolling: boolean;
  batchStatus: BatchStatus | null;
  productJobs: ProductJobStatus[];
  completedCount: number;
  failedCount: number;
  totalCount: number;
}
```

Implementation:
- Polls `GET ${apiBaseUrl}/products/batch/${batchId}/status` at `interval` (default 2000ms)
- Updates `batchStatus` state on each poll
- Derives `productJobs`, `completedCount`, `failedCount`, `totalCount` from response
- Stops polling when `batchStatus.status === "completed"` (all products done or failed)
- Calls `onBatchComplete` callback when batch finishes
- Uses same ref-based cleanup pattern as useJobPolling (pollingRef, isCancelledRef)
- Cleanup on unmount via useEffect return
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify TypeScript compiles.
Take a Playwright screenshot of the products page to verify checkboxes appear on product cards.
  </verify>
  <done>Product cards have checkboxes for multi-select, sticky action bar shows when products are selected with a "Generate N Videos" button, and useBatchPolling hook polls batch status endpoint</done>
</task>

<task type="auto">
  <name>Task 2: Create batch-generate progress page with per-product status cards</name>
  <files>frontend/src/app/batch-generate/page.tsx</files>
  <action>
Create `frontend/src/app/batch-generate/page.tsx`:

1. **Page setup:**
   - "use client" directive
   - Wrap content in Suspense boundary (useSearchParams requires it in Next.js App Router)
   - Read `batch_id` from `useSearchParams()` — if missing, show error state
   - Import useBatchPolling from `@/hooks/use-batch-polling`
   - Start polling on mount when batch_id is present

2. **Header section:**
   - Title: "Batch Generation"
   - Subtitle showing "X of Y complete, Z failed" derived from polling state
   - Overall progress bar (completed + failed / total * 100)
   - Back button linking to /products

3. **Per-product progress card grid:**
   - Grid layout: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`
   - Each card (Shadcn Card) shows:
     - Product title (from polling response)
     - Status badge: queued (gray/outline), processing (blue/secondary), completed (green), failed (red/destructive)
     - Status icon: Clock for queued, Loader2 (animate-spin) for processing, CheckCircle2 for completed, XCircle for failed
     - Progress bar (Shadcn Progress component) showing 0-100 for processing state, 100 for completed, 0 for failed
     - Error message in red text if status is "failed" and error is not null
   - Import icons from lucide-react: Clock, Loader2, CheckCircle2, XCircle

4. **Retry Failed button:**
   - Show only when batch is complete AND failedCount > 0
   - On click: collect product_ids where status === "failed", POST /products/batch-generate with those IDs (same settings as original), navigate to new batch page `/batch-generate?batch_id=${newBatchId}`
   - Store the original batch settings in a ref or derive from URL (simplest: use defaults since batch always uses quick/edge/30s/tiktok per research recommendation)

5. **Completion state:**
   - When all products are done (status === "completed"):
     - If failedCount === 0: Show success message with link to /librarie (library page)
     - If failedCount > 0: Show partial success message + retry button

6. **Navigate-away resilience:**
   - batch_id is in URL params — page reads it on mount and resumes polling
   - No sessionStorage or React state for batch_id
   - useBatchPolling reads persisted state from Supabase via the status endpoint

7. **Add navbar link:**
   - Do NOT add a permanent navbar link for batch-generate — it's a transient page reached from products page only
  </action>
  <verify>
Take a Playwright screenshot of `/batch-generate?batch_id=test` to verify the page renders (will show error/empty state since batch_id is fake, but confirms page exists and renders without crash).
  </verify>
  <done>Batch generate page shows per-product progress cards with independent status transitions, retry-failed button, and navigate-away resilience via URL params</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete batch generation flow</name>
  <what-built>
  Complete batch generation flow:
  1. Multi-select checkboxes on product cards in /products page
  2. Sticky action bar with "Generate N Videos" button
  3. Batch generation dispatches to backend and redirects to /batch-generate page
  4. Per-product progress cards show independent status (queued/processing/done/failed)
  5. Retry-failed button for partial failures
  </what-built>
  <how-to-verify>
  1. Go to http://localhost:3000/products
  2. Select a feed and verify product cards now have checkboxes in the top-left corner
  3. Click several checkboxes — verify the sticky action bar appears at the bottom showing "N selected" and "Generate N Videos" button
  4. Click "Select all on page" and "Clear" buttons — verify they work
  5. Click "Generate N Videos" — verify redirect to /batch-generate?batch_id=... page
  6. On the batch-generate page, verify per-product cards show with status badges and progress bars updating
  7. Navigate away (go to /products) and come back to the same /batch-generate URL — verify progress is preserved
  8. If any product fails, verify the failed card shows an error message and the retry button appears when the batch completes
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Products page has checkboxes on each product card for multi-select
2. Sticky action bar appears when products are selected with correct count and Generate button
3. POST /products/batch-generate is called with selected product IDs on button click
4. Redirect to /batch-generate?batch_id=... occurs after successful dispatch
5. Batch-generate page shows per-product progress cards polling at 2s intervals
6. Each card independently transitions through queued -> processing -> completed/failed
7. Navigate-away-and-return preserves batch progress (batch_id in URL, state from Supabase)
8. Retry-failed button dispatches new batch with only failed product IDs
</verification>

<success_criteria>
- Multi-select works on product cards with checkboxes
- Sticky action bar shows selection count and generates batch on click
- Per-product progress cards update independently via batch polling
- Failed products show error message, retry button creates new batch
- Navigate away and return preserves progress state
</success_criteria>

<output>
After completion, create `.planning/phases/21-batch-generation/21-02-SUMMARY.md`
</output>
